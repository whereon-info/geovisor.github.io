<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estudio de mercado a un clic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body,html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .leaflet-sidebar { z-index:1000; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar" class="leaflet-sidebar collapsed">
    <div class="leaflet-sidebar-tabs">
      <ul role="tablist">
        <li><a href="#info" role="tab"><i class="bi bi-info-circle"></i></a></li>
      </ul>
    </div>
    <div class="leaflet-sidebar-content">
      <div class="leaflet-sidebar-pane" id="info">
        <h1 class="leaflet-sidebar-header">
          Informaci칩n
          <span class="leaflet-sidebar-close"><i class="bi bi-x-lg"></i></span>
        </h1>
        <div id="sidebar-content">Haz clic en un hex치gono</div>
      </div>
    </div>
  </div>

  <script>
    // ================== MAPA ===================
    const map = L.map('map').setView([19.4326, -99.1332], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const sidebar = L.control.sidebar({ container:'sidebar', position:'right' }).addTo(map);
    function mostrarEnSidebar(html){ 
      document.getElementById("sidebar-content").innerHTML = html; 
      sidebar.open("info"); 
    }

    // ================== TOKEN DENUE ===================
    const token = "aqui_va_tu_token";

    // ================== CATEGOR칈AS ===================
    const categoriasHex = ["bancos", "supermercados", "escuelas", "hoteles"];

    function getIconoCategoria(cat){
      switch(cat){
        case "Bancos": return '<i class="bi bi-bank"></i>';
        case "Supermercados": return '<i class="bi bi-basket3-fill"></i>';
        case "Escuelas": return '<i class="bi bi-mortarboard-fill"></i>';
        case "Hoteles": return '<i class="bi bi-building"></i>';
        default: return '<i class="bi bi-geo-alt-fill"></i>';
      }
    }

    async function buscarEnHexagono(bounds, categorias) {
      let resultados = [];
      const centro = bounds.getCenter();
      for (const cat of categorias) {
        const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${centro.lat},${centro.lng}/1000/${token}`;
        try {
          const resp = await fetch(url);
          if (!resp.ok) continue;
          const data = await resp.json();
          const dentro = data.filter(d => {
            const lat = parseFloat(d.Latitud), lon = parseFloat(d.Longitud);
            return !isNaN(lat) && !isNaN(lon) && bounds.contains([lat, lon]);
          });
          resultados.push(...dentro);
        } catch (err) {
          console.error("Error en consulta hex치gono:", err);
        }
      }
      return resultados;
    }

    function onEachFeature(feature, layer) {
      layer.on("click", async () => {
        const props = feature.properties || {};
        let html = `<h4>${props.nomgeo||'Zona'}</h4>
                    <p><b>Poblaci칩n:</b> ${props.pobtot?.toLocaleString()||0}</p>
                    <hr><h5>游댍 Buscando establecimientos...</h5>`;
        mostrarEnSidebar(html);

        const bounds = layer.getBounds();
        const resultados = await buscarEnHexagono(bounds, categoriasHex);

        // AGRUPADO
        const resumen = { Bancos:0, Supermercados:0, Escuelas:0, Hoteles:0 };
        for (const item of resultados) {
          const c = (item.Clase_actividad || "").toLowerCase();
          if (c.includes("banco")) resumen.Bancos++;
          else if (c.includes("escuela") || c.includes("colegio") || c.includes("universidad")) resumen.Escuelas++;
          else if (c.includes("super") || c.includes("autoservicio") || c.includes("bodega") || c.includes("abarrotes")) resumen.Supermercados++;
          else if (c.includes("hotel") || c.includes("motel") || c.includes("hostal")) resumen.Hoteles++;
        }

        let listado = "<h5>游낇 Elementos urbanos dentro del 치rea:</h5><ul style='list-style:none;padding:0;'>";
        for (const [cat, num] of Object.entries(resumen)) {
          listado += `<li style="margin-bottom:6px; display:flex; align-items:center;">
                        <span style="margin-right:6px;">${getIconoCategoria(cat)}</span>
                        <b>${cat}:</b> ${num}
                      </li>`;
        }
        listado += "</ul>";

        mostrarEnSidebar(`<h4>${props.nomgeo||'Zona'}</h4>` + listado);
      });
    }

    // ================== HEX츼GONOS ===================

	function getColor(d) {
    return d > 1000000 ? '#d7191c' :
           d > 500000  ? '#fdae61' :
           d > 250000  ? '#ffffbf' :
           d > 100000  ? '#abdda4' :
                        '#2b83ba';
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties.POBADUL),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
    };
}
	  
	  var hiveLayer09 = L.geoJson(hive_cdmx, { 
    style: style, 
    onEachFeature: onEachFeature 
}).addTo(map);

var hiveLayer15 = L.geoJson(hive_edomex, { 
    style: style, 
    onEachFeature: onEachFeature 
}).addTo(map);
	
// Leyenda
var legend = L.control({position: 'bottomright'}); 
legend.onAdd = function (map) { 
    var div = L.DomUtil.create('div', 'info legend'), 
        grades = [0, 100000, 250000, 500000, 1000000]; 
    for (var i = 0; i < grades.length; i++) { 
        div.innerHTML += 
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' + 
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+'); 
    } 
    return div; 
}; 
legend.addTo(map); 

// ========================TITULO=========================
	var title = L.control();
	title.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'info');
		    div.innerHTML +=
		    '<h1>Estudio de mercado</h1>An치lisis de entornos';
		 return div;
	};
	title.addTo(map);	
	
	
// ===== LAYER CONTROL =====
var myMarker = L.marker([19.28581583157899, -99.40670897151347]) 
var myMarker1 = L.marker([19.38581583157899, -99.10670897151347]); 
map.addLayer(myMarker); 
map.addLayer(myMarker1); 
var baseLayers = { "Base": osm, "Ortoimagen": map }; 
var overlays = { "Casa": myMarker, "Otro": myMarker1, "Hive CDMX": hiveLayer09, "Hive EDOMEX": hiveLayer15 }; 
var control = new L.control.layers(baseLayers, overlays, {collapsed:true}); control.addTo(map);




  </script>
</body>
</html>

