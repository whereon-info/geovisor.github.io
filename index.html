<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa DENUE con Iconos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        #map { height: 100vh; }
        .custom-div-icon { text-align: center; line-height: 24px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        const TOKEN_DENUE = "TU_TOKEN_AQUI"; // Sustituye por tu token oficial
        const LAT = 21.12; // Centro del mapa
        const LON = -101.68;
        const RADIO = 500; // metros
        let iconConfig = [];

        // Cargar configuración de iconos
        fetch("iconConfig.json")
            .then(res => res.json())
            .then(data => {
                iconConfig = data;
                iniciarMapa();
            })
            .catch(err => console.error("Error cargando configuración:", err));

        function iniciarMapa() {
            const map = L.map('map').setView([LAT, LON], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            const markersLayer = L.layerGroup().addTo(map);

            // Consulta a la API DENUE
            const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar//${LAT},${LON}/${RADIO}/${TOKEN_DENUE}`;

            fetch(url)
                .then(res => res.json())
                .then(datos => {
                    datos.forEach(item => {
                        const icono = obtenerIcono(item.nombre_act);

                        const marker = L.marker([item.latitud, item.longitud], { icon: icono })
                            .bindPopup(`
                                <b>${item.nom_estab}</b><br>
                                ${item.nombre_act}<br>
                                <small>${item.ubicacion}</small>
                            `);

                        markersLayer.addLayer(marker);
                    });
                })
                .catch(err => console.error("Error consultando DENUE:", err));
        }

        // Selección de ícono según giro
        function obtenerIcono(texto) {
            texto = texto.toLowerCase();
            for (let cfg of iconConfig) {
                if (cfg.match.some(keyword => texto.includes(keyword))) {
                    return L.divIcon({
                        html: `<i class="bi ${cfg.icon}" style="font-size: 24px; color: ${cfg.color};"></i>`,
                        className: 'custom-div-icon',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24],
                        popupAnchor: [0, -24]
                    });
                }
            }
            return L.divIcon({
                html: `<i class="bi bi-geo-alt-fill" style="font-size: 24px; color: gray;"></i>`,
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 24],
                popupAnchor: [0, -24]
            });
        }
    </script>
</body>
</html>
