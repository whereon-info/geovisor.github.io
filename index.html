<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estudio de mercado a un clic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="text/javascript" src="js/hive_cdmx.js"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

	 <!-- Geocode -->
		<script src="js/Control.OSMGeocoder.js"></script>
		<link rel="stylesheet" href="css/Control.OSMGeocoder.css" />

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            background: #121212;
            color: #e0e0e0;
        }
        #controls {
            padding: 10px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
        }
        label { margin-right: 5px; }
        input, button {
            margin: 3px;
            padding: 5px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background: #444;
        }
        #map {
            height: 60vh;
            width: 100%;
        }
        #listado {
            height: 40vh;
            overflow-y: auto;
            background: #181818;
            border-top: 1px solid #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            color: #e0e0e0;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        tr:hover {
            background: #333;
            cursor: pointer;
        }
        th {
            background: #222;
            position: sticky;
            top: 0;
        }
        .custom-div-icon {
            background: transparent;
            border: none;
        }
		  .info {
		padding: 6px 8px;
		font: 14px/16px Arial, Helvetica, sans-serif;
		background: red;
		background: rgba(186,186,186,0.8);
		box-shadow: 0 0 15px rgba(0,0,0,0.2);
		border-radius: 5px;
	}
	.info h2 {
		margin: 0 0 5px;
		color: #404040;
	}
	.legend {
	    line-height: 18px;
	    color: #555;
	}
	.legend i {
	    width: 18px;
	    height: 18px;
	    float: left;
	    margin-right: 8px;
	    opacity: 0.7;
	}
    </style>
</head>
<body>
    <div id="controls">
        <label>Establecimiento:</label>
        <input type="text" id="condi" value="restaurantes" />
        <label>Latitud:</label>
        <input type="text" id="lat" value="19.432650801677962" />
        <label>Longitud:</label>
        <input type="text" id="lon" value="-99.13316794583835" />
        <label>Metros:</label>
        <input type="number" id="mts" value="500" />
        <button id="btnBuscar">Buscar</button>
    </div>

    <div id="map"></div>
    <div id="listado">
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Dirección</th>
                    <th>Teléfono</th>
                    <th>Clase</th>
                    <th>Personal ocupado</th>
                </tr>
            </thead>
            <tbody id="tablaResultados"></tbody>
        </table>
    </div>

<script>

const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";

// Inicializar mapa en modo oscuro
const map = L.map('map').setView([22.5, -100.5], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);

var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
});

map.addLayer(osm);

	
// ===== MARCADOR DRAGGABLE CON GEOLOCALIZACIÓN =====
let userMarker;

function onLocationFound(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    // Crear marcador draggable
    userMarker = L.marker([lat, lon], { draggable: true }).addTo(map)
        .bindPopup("📍 Arrástrame para mover tu ubicación").openPopup();

    // Actualizar campos al detectar ubicación
    document.getElementById("lat").value = lat;
    document.getElementById("lon").value = lon;

    // Evento para actualizar al mover el marcador
    userMarker.on("dragend", function (event) {
        const position = event.target.getLatLng();
        document.getElementById("lat").value = position.lat;
        document.getElementById("lon").value = position.lng;
    });

    map.setView([lat, lon], 15);
}

function onLocationError(e) {
    alert("⚠️ No se pudo obtener tu ubicación. Ingresa manualmente las coordenadas.");
}

map.on("locationfound", onLocationFound);
map.on("locationerror", onLocationError);

// Solicitar ubicación del navegador
map.locate({ setView: true, maxZoom: 16 });

// ==================================================


// ======= TUS CAPAS Y FUNCIONES EXISTENTES =======
var hive = L.geoJson(hive_cdmx).addTo(map);

// ===== LAYER CONTROL =====
var myMarker = L.marker([19.28581583157899, -99.40670897151347]) 
var myMarker1 = L.marker([19.38581583157899, -99.10670897151347]); 
map.addLayer(myMarker); 
map.addLayer(myMarker1); 
var baseLayers = { "Base": osm, "Ortoimagen": map }; 
var overlays = { "Casa": myMarker, "Otro": myMarker1, "Hive": hive, }; 
var control = new L.control.layers(baseLayers, overlays, {collapsed:true}); control.addTo(map);



	var title = L.control();
	title.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'info');
		    div.innerHTML +=
		    '<h1>Estudio de mercado</h1>Análisis de entornos';
		 return div;
	};
	title.addTo(map);

function getColor(d) {
    return d > 1000000 ? '#d7191c' :
           d > 500000  ? '#fdae61' :
           d > 250000  ? '#ffffbf' :
           d > 100000  ? '#abdda4' :
                        '#2b83ba';
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties.POBADUL),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
    };
}

function onEachFeature(feature, layer) {
    if (feature.properties) {
        const props = feature.properties;
        const popupContent = `
            <h3>${props.nomgeo || 'Zona'}</h3>
            <b>Tipo:</b> ${props.TIPO || 'N/A'}<br>
            <b>Rezago:</b> ${props.REZAGO || 'N/A'}<br><hr>
            <b>Población total:</b> ${props.pobtot?.toLocaleString() || 0}<br>
            <b>Población adulta:</b> ${props.POBADUL?.toLocaleString() || 0}<br><hr>
            <b>Extorsión:</b> ${props["extorsión"] || 0}<br>
            <b>Narcomenudeo:</b> ${props.narcomenud || 0}<br>
            <b>Robo a negocio:</b> ${props["robo a neg"] || 0}<br><hr>
            <b>Total créditos:</b> ${props.TC?.toLocaleString() || 0}<br>
            <b>Crédito personal:</b> ${props.CRED_PERS?.toLocaleString() || 0}<br>
            <b>Crédito nómina:</b> ${props.CRED_NOMI?.toLocaleString() || 0}<br>
            <b>Crédito hipotecario:</b> ${props.CRED_HIPOT?.toLocaleString() || 0}<br>
            <b>Crédito automotriz:</b> ${props.CRED_AUTOM?.toLocaleString() || 0}<br><hr>
            <b>Tasa crédito hipotecario:</b> ${props.T_C_HIP || 0}<br>
            <b>Tasa crédito automotriz:</b> ${props.T_C_AUTO || 0}<br>
            <b>Tasa tarjetas crédito:</b> ${props.T_TC || 0}
        `;
        layer.bindPopup(popupContent);
    }
}

L.geoJson(hive_cdmx, { style, onEachFeature }).addTo(map);

// Leyenda
var legend = L.control({position: 'bottomright'}); 
legend.onAdd = function (map) { 
    var div = L.DomUtil.create('div', 'info legend'), 
        grades = [0, 100000, 250000, 500000, 1000000]; 
    for (var i = 0; i < grades.length; i++) { 
        div.innerHTML += 
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' + 
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+'); 
    } 
    return div; 
}; 
legend.addTo(map); 

// Geocoder
var osmGeocoder = new L.Control.OSMGeocoder({placeholder: 'Escribir dirección...'});
map.addControl(osmGeocoder);

</script>
</body>
</html>


