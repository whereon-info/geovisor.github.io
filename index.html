<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Estudio de mercado a un clic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Hive (tu geojson) -->
  <script type="text/javascript" src="js/hive_cdmx.js"></script>
  <script type="text/javascript" src="js/hive_edomex.js"></script>

  <!-- Buscadores / plugins locales -->
  <link rel="stylesheet" href="css/leaflet-search.css">
  <link rel="stylesheet" href="css/L.Control.Locate.min.css">
  <link rel="stylesheet" href="css/leaflet.photon.css">

  <!-- GOOGLGE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto&display=swap" rel="stylesheet">
	
	<!-- Font Awesome para que funcionen los iconos de locate y search -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

		<!-- Photon CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet.photon/leaflet.photon.css" />
	
	<!-- Photon JS -->
	<script src="https://unpkg.com/leaflet.photon/leaflet.photon.js"></script>


  <style>
    body,html { margin:0; padding:0; height:100%; font-family: 'Poppins', sans-serif; font-size: 14px; color: #f1f1f1; }
    #map { width:100%; height:85%; }
    .leaflet-sidebar { z-index:1000; }
    /*.title {font family: Roboto; background-color:#15f20a}*/
    /*.legend {line-height: 18px; color: #000000;} TEXTO DE LA SIMBOLOG√çA*/
    .legend i {width: 10px;height: 10px; float: left;margin-right: 8px; opacity: 0.5;}
    /*.leaflet-sidebar-header {height: 20px;line-height: 20px; font-size: 10pt; color:#FFFFFF; background-color:#000000; margin:15px 15px 0; padding:0 20px;} SIDEBAR*/
    /*.leaflet-sidebar-content {position:absolute; top:0; bottom:0; background-color:rgba(153, 153, 153,.90); overflow-x:hidden; overflow-y:auto; color: #FFFFFF;}*/
	/*.leaflet-control-layers-expanded {background: rgba(153, 153, 153,.90); color: #999999;}*/
	/*.leaflet-control-layers label {font-family: 'Poppins', sans-serif; font-size: 14px; color: #ffffff;}*/
    .info {padding:6px 8px; font:14px/16px Poppins, Poppins, Poppins, Poppins; background: rgba(44, 44, 44, 0.8); box-shadow:0 0 15px rgba(0,0,0,0.2); border-radius:5px;}
    /*.info h2 { margin:0 0 5px; color:#00793a; } TEXTO DEL T√çTULO*/
    /*#listado-header { background-color:#00793a } LISTADO DE ESTABLECIMIENTOS*/
    /*#listado, #sidebar-content { transition: height 1.0s ease, padding 1.0s ease; }*/
    /*#listado.minimized { height: 30px; overflow: hidden; }*/
    /*#sidebar-content.minimized { height: 30px; overflow: hidden; }*/

    /*#controls { padding:10px; background:#00793a; border-bottom:3px solid #f15a29 }BARRA ARRIBA*/
    /*label { color:white; }*/

    /*table { width: 100%; border-collapse: collapse; color: #000000; background-color: #FFFFFF; } */
    /*th, td { padding: 3px; border-bottom: 1px solid #000000; } LINEA Y TABLAS*/
    /*tr:hover { background: #00ae4d; cursor: pointer; } COLOR SELECCI√ìN ELEMENTOS*/
    th { background: #2c2c2c; position: sticky; top: 0; } /*BARRA NOMBRE DIRECCION TELEFONO ETC*/

	/* üé® Fuente uniforme en todo el mapa */
	.leaflet-control, .leaflet-popup-content, {font-family: 'Poppins', sans-serif; font-size: 14px; color: #999999;}
	
	/* üóÇ Control de capas */
	.leaflet-control-layers {background: rgba(44, 44, 44, 0.8);border-radius: 8px;padding: 6px;color: #ffffff;font-family: 'Poppins', sans-serif;}
	.leaflet-sidebar-header {background: rgba(44, 44, 44, 0.8);border-radius: 6px;padding: 4px;color: #ffffff;font-family: 'Poppins', sans-serif;}
	.leaflet-control-layers label { color: #ffffff; font-weight: 500; cursor: pointer;}
	.leaflet-control-search a {display: flex; align-items: center; justify-content: center; font-size: 18px; color: #FFFFFF;}
	.leaflet-control-search a:hover {color: #b81cb0;}
  	
	/* üìë Sidebar y tabla de resultados */
	#controls {background: #2c2c2c;color: #FFFFFF;font-family: 'Poppins', sans-serif;font-size: 14px; line-height: 2.0;}
	#listado {background: #000000;color: #FFFFFF;font-family: 'Poppins', sans-serif;font-size: 12px; line-height: 1.5;}
	#sidebar {background: #2c2c2c;color: #000000;font-family: 'Poppins', sans-serif;font-size: 14px; line-height: 1.0;}  
	 table { width: 100%;} 
	#sidebar h3, #listado h3, { font-weight: 150; font-size: 12px; margin-bottom: 8px;}
	#gcd-button-control {  display: flex;  align-items: center;  justify-content: center;  font-size: 8px;   /* tama√±o del emoji */  width: 28px;  height: 28px;   border-radius: 2px;  cursor: pointer;}
	#gcd-button-control:hover {  background: #f0f0f0;}
	.leaflet-sidebar-tabs>li.active, .leaflet-sidebar-tabs>ul>li.active {color: #FFFFFF; background-color: #2c2c2c;}  

	#resultadosBusqueda .resultado-personalizado {  display: flex;  align-items: center;  margin: 4px 0;  padding: 4px 6px;  background: rgba(200,230,255,0.5);  border-radius: 6px;}
	#resultadosBusqueda .icono {  font-size: 18px;  margin-right: 6px;}
	#resultadosBusqueda .nombre {  flex: 1;  font-weight: bold;  text-transform: capitalize;}
	#resultadosBusqueda .conteo {  color: #333;}
 
  </style>
</head>
<body>
<div id="controls">
  <label>Establecimiento:</label>
  <input type="text" id="condi" value="pizzer√≠as" />
  <label>Latitud:</label>
  <input type="text" id="lat" value="19.432650801677962" />
  <label>Longitud:</label>
  <input type="text" id="lon" value="-99.13316794583835" />
  <label>Metros:</label>
  <input type="number" id="mts" value="1000" />
  <button id="btnBuscar">Buscar</button>
  <button id="btnExportar">Exportar a PDF</button>
</div>

<div id="map"></div>

<!-- SIDEBAR -->
<div id="sidebar" class="leaflet-sidebar collapsed">
  <div class="leaflet-sidebar-tabs">
    <ul role="tablist">
      <li><a href="#info" role="tab"><i class="bi bi-info-circle"></i></a></li>
    </ul>
  </div>
  <div class="leaflet-sidebar-content">
    <div class="leaflet-sidebar-pane" id="info">
      <div id="sidebar-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h2 class="leaflet-sidebar-header" style="margin:0;">üìä Ficha de informaci√≥n urbana</h2>
        </div>
      <div id="sidebar-content">H√°ga clic en una zona para conocer su informaci√≥n</div>
    </div>
  </div>
	<h3>B√∫squedas personalizadas</h3>
  <div id="resultadosBusqueda"> <!-- Aqu√≠ se mostrar√°n las b√∫squedas con .buscarDENUE -->
      </div>
</div>

<!-- LISTADO -->
<div id="listado">
  <div id="listado-header" style="display:flex;justify-content:space-between;align-items:center;">
    <h4>üìç Establecimientos econ√≥micos dentro de la zona de estudio</h4>
    <button id="btnToggle"><i class="bi bi-dash"></i></button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Nombre</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Personal ocupado</th><th>Clase</th>
      </tr>
    </thead>
    <tbody id="tablaResultados"></tbody>
  </table>
</div>

<!-- plugins local JS -->
<script src="js/leaflet.photon.js"></script>
<script src="js/L.Control.Locate.min.js"></script>

<script>
  // ========== MAPA + CAPAS ==========
  const map = L.map('map').setView([22.5, -100.5], 5);

  // tile layers (def√≠nelas y agr√©galas a control despu√©s)
  const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');


  // ========== VARIABLES COMPARTIDAS (evita ReferenceError) ==========
  var x = null;            // geojson temporal usado por photon
  var marker = null;       // marcador temporal usado por photon
  var last = null;

  // ========== CONTROLES (locate) ======================
	  L.control.locate({ locateOptions: { maxZoom: 15 } }).addTo(map);
	  var draggableMarker;
		map.on("locationfound", function (e) {
	  if (draggableMarker) {
	    draggableMarker.setLatLng(e.latlng);
	  } else {
	    draggableMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
	
	    // Cuando se arrastra, actualizamos inputs
	    draggableMarker.on("dragend", function (ev) {
	      var pos = ev.target.getLatLng();
	      document.getElementById("lat").value = pos.lat.toFixed(6);
	      document.getElementById("lon").value = pos.lng.toFixed(6);
	    });
	  }
	
	  // Guardar coordenadas iniciales en los inputs
	  document.getElementById("lat").value = e.latlng.lat.toFixed(6);
	  document.getElementById("lon").value = e.latlng.lng.toFixed(6);
	  map.setView(e.latlng, 15);
	});
	
	// Si falla la localizaci√≥n
	map.on("locationerror", function () {
	  alert("No se pudo obtener tu ubicaci√≥n");
	});


  // ========== SIDEBAR ==========
  const sidebar = L.control.sidebar({ container:'sidebar', position:'right' }).addTo(map);
  function mostrarEnSidebar(html){
    document.getElementById("sidebar-content").innerHTML = html;
    sidebar.open("info");
  }

  // token y markersLayer
  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";
  let markersLayer = L.featureGroup().addTo(map);

  // ====== √çconos y funciones DENUE ======
  function getBootstrapIconFromActividad(clase) {
    clase = (clase || "").toLowerCase();
    let iconHTML;
    if (clase.includes("restaurante")) iconHTML = '<i class="bi bi-shop" style="font-size:26px;color:orange"></i>';
    else if (clase.includes("hotel")) iconHTML = '<i class="bi bi-building" style="font-size:26px;color:blue"></i>';
    else iconHTML = '<i class="bi bi-geo-alt-fill" style="font-size:26px;color:red"></i>';
    return L.divIcon({ html: iconHTML, className: 'custom-div-icon', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-26] });
  }

  async function buscarEnHexagono(bounds, categorias) {
    let resultados = [];
    const centro = bounds.getCenter();
    for (const cat of categorias) {
      const urlApi = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${centro.lat},${centro.lng}/1000/${token}`;
      try {
        const resp = await fetch(urlApi);
        if (!resp.ok) continue;
        const data = await resp.json();
        const dentro = data.filter(d => {
          const lat = parseFloat(d.Latitud), lon = parseFloat(d.Longitud);
          return !isNaN(lat) && !isNaN(lon) && bounds.contains([lat, lon]);
        });
        resultados.push(...dentro);
      } catch (err) {
        console.error("Error en consulta", err);
      }
    }
    return resultados;
  }

  // ========== FUNCIONES DE HEX√ÅGONOS ==========
  function onEachFeature(feature, layer) {
    layer.on("click", async () => {
      const props = feature.properties || {};

      const htmlFija = `
        <div id="info-fija">
          <h2>${props.nomgeo || 'Zona'}</h2>
          <b>Tipo:</b> ${props.TIPO || 'N/A'}<br>
          <p><b>Poblaci√≥n municipal total:</b> ${props.pobtot?.toLocaleString() || 0}</p>
          <p><b>Poblaci√≥n adulta municipal:</b> ${props.POBADUL?.toLocaleString() || 0}</p>
          <p><b>√çndice de Rezago:</b> ${props.REZAGO || 'N/A'}</p><hr>
          <p><b>Extorsi√≥n:</b> ${props["extorsi√≥n"] || 0}</p>
          <p><b>Narcomenudeo:</b> ${props.narcomenud || 0}</p>
          <p><b>Robo a negocio:</b> ${props["robo a neg"] || 0}</p><hr>
          <p><b>Cr√©ditos personales:</b> ${props.CRED_PERS?.toLocaleString() || 0}</p>
          <p><b>Cr√©ditos n√≥mina:</b> ${props.CRED_NOMI?.toLocaleString() || 0}</p>
          <p><b>Cr√©ditos hipotecarios:</b> ${props.CRED_HIPOT?.toLocaleString() || 0}</p>
          <p><b>Cr√©ditos automotrices:</b> ${props.CRED_AUTOM?.toLocaleString() || 0}</p><hr>
        </div>
        <div id="info-dinamica">Cargando...</div>
      `;
      mostrarEnSidebar(htmlFija);

      const bounds = layer.getBounds();
      const resultados = await buscarEnHexagono(bounds, ["bancos","supermercados","escuelas","hoteles"]);

      // Agrupar
      const resumen = { Bancos:0, Supermercados:0, Escuelas:0, Hoteles:0 };
      const extras = {}; // aqu√≠ se guardan categor√≠as nuevas
      
      for (const item of resultados) {
        const c = (item.Clase_actividad || "").toLowerCase();
      
        if (c.includes("banco")) resumen.Bancos++;
        else if (c.includes("escuela") || c.includes("colegio") || c.includes("universidad")) resumen.Escuelas++;
        else if (c.includes("super") || c.includes("autoservicio") || c.includes("bodega") || c.includes("abarrotes")) resumen.Supermercados++;
        else if (c.includes("hotel") || c.includes("motel") || c.includes("hostal")) resumen.Hoteles++;
      
        // üîπ si no entra en las fijas, lo mando a extras
        else {
          const nombre = item.Clase_actividad.trim();
          if (!extras[nombre]) extras[nombre] = 0;
          extras[nombre]++;
        }
      }


      let listado = "<h3>üè¨ Elementos urbanos dentro del √°rea:</h3><ul style='list-style:none;padding:0;'>";
       for (const [cat,num] of Object.entries(resumen)) {
          listado += `<li style="margin-bottom:6px; display:flex; align-items:center;">
                        <span style="margin-right:8px;">${getEmojiCategoria(cat)}</span>
                        <strong style="margin-right:6px;">${cat}:</strong> ${num}
                      </li>`;
                          }
          listado += "</ul>";

            if (Object.keys(extras).length > 0) {
        listado += "<h3>üîç Otros establecimientos:</h3><ul style='list-style:none;padding:0;'>";
        for (const [cat,num] of Object.entries(extras)) {
          listado += `<li style="margin-bottom:6px; display:flex; align-items:center;">
                        <span style="margin-right:8px;">üìç</span>
                        <strong style="margin-right:6px;">${cat}:</strong> ${num}
                      </li>`;
        }
        listado += "</ul>";
      }
      
      function getEmojiCategoria(cat) {
          const emojis = {
            "Bancos": "üè¶",
            "Supermercados": "üõí",
            "Escuelas": "üè´",
            "Hoteles": "üè®"
          };
          return emojis[cat] || "üìç";
        }

      // Reemplaza #info-dinamica
      const cont = document.getElementById("info-dinamica");
      if (cont) cont.innerHTML = listado;
    });
  }
  
  // ========== AGRUPAR =====================================




  //======================= LOGO ================================
	var logoControl = L.control({ position: "bottomleft" });

logoControl.onAdd = function (map) {
    var div = L.DomUtil.create("div", "logo-leaflet");
    div.innerHTML = '<img src="images/WhereOn-Logo-Color-Vrt.png" style="width:80px; opacity:0.9;">';
    return div;
};

logoControl.addTo(map);
  
  // ========== ESTILO / LAYERS (crear HIVE primero) ==========
  function getColor(d) {
    return d > 1000 ? '#d7191c' :
           d > 500  ? '#fdae61' :
           d > 250  ? '#ffffbf' :
           d > 100  ? '#abdda4' :
                      '#2b83ba';
  }
  function style(feature) {
    return {
      fillColor: getColor(feature.properties?.["robo a neg"]),
      weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
    };
  }

  // Crear capas HIVE (usa variables cargadas por tus js/hive_*.js)
  var hiveLayer09 = null, hiveLayer15 = null;
  try {
    hiveLayer09 = L.geoJson(hive_cdmx, { style: style, onEachFeature: onEachFeature }).addTo(map);
  } catch(e) { console.warn('hive_cdmx no disponible o error:', e); }
  try {
    hiveLayer15 = L.geoJson(hive_edomex, { style: style, onEachFeature: onEachFeature }).addTo(map);
  } catch(e) { console.warn('hive_edomex no disponible o error:', e); }


  // Leyenda y t√≠tulo
  var legend = L.control({position: 'bottomright'});
  legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 100, 250, 500, 1000];
    for (var i = 0; i < grades.length; i++) {
      div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                       grades[i] + (grades[i+1] ? '&ndash;' + grades[i+1] + '<br>' : '+');
    }
    return div;
  };
  legend.addTo(map);

  var title = L.control();
  title.onAdd = function(map) {
    var div = L.DomUtil.create('div', 'info');
    div.innerHTML += '<h2>Estudio de mercado</h2><h3>An√°lisis de entornos</h3>';
    return div;
  };
  title.addTo(map);

  // Ahora s√≠ agregamos control de capas
  const baseLayers = { "Oscuro": dark, "Calles": osm };
  const overlays = {};
  if (hiveLayer09) overlays["Hive CDMX"] = hiveLayer09;
  if (hiveLayer15) overlays["Hive EDOMEX"] = hiveLayer15;
  L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

  // ========== B√öSQUEDA DENUE (bot√≥n) ==========
  async function buscarDENUE() {
    markersLayer.clearLayers();
    document.getElementById("tablaResultados").innerHTML = "";

    let condi = document.getElementById('condi').value.trim();
    const lat = parseFloat(document.getElementById('lat').value.trim());
    const lon = parseFloat(document.getElementById('lon').value.trim());
    const mts = parseInt(document.getElementById('mts').value.trim());

    if (!condi || isNaN(lat) || isNaN(lon) || isNaN(mts)) {
      alert("Por favor ingresa datos v√°lidos.");
      return;
    }
  }
	
    const urlApi = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(condi)}/${lat},${lon}/${mts}/${token}`;

  document.getElementById('btnBuscar').addEventListener('click', buscarDENUE);

  // ========== TOGGLES: listado y sidebar ==========
  //document.getElementById("btnToggle").addEventListener("click", function() {
    //const listado = document.getElementById("listado");
    //listado.classList.toggle("minimized");
    //this.innerHTML = listado.classList.contains("minimized") ? '<i class="bi bi-plus"></i>' : '<i class="bi bi-dash"></i>';
  //});

  //document.getElementById("btnSidebarToggle").addEventListener("click", function() {
    //const sidebarContent = document.getElementById("sidebar-content");
    //sidebarContent.classList.toggle("minimized");
    //this.innerHTML = sidebarContent.classList.contains("minimized") ? '<i class="bi bi-plus"></i>' : '<i class="bi bi-dash"></i>';
  //});

  // Utilidad: getIconoCategoria (usa tu funci√≥n original)
  function getIconoCategoria(cat){
    switch(cat){
      case "Bancos": return '<i class="bi bi-bank"></i>';
      case "Supermercados": return '<i class="bi bi-basket3-fill"></i>';
      case "Escuelas": return '<i class="bi bi-mortarboard-fill"></i>';
      case "Hoteles": return '<i class="bi bi-building"></i>';
      default: return '<i class="bi bi-geo-alt-fill"></i>';
    }
  }

// ============================== RESUMEN DENUE ======================================
	fetch(url)
    .then(response => response.json())
    .then(data => {
      if (!data || data.length === 0) {
        alert("No se encontraron resultados para " + categoria);
        return;
      }

      // --- Muestra los puntos en el mapa ---
      if (window.resultadosPersonalizados) {
        map.removeLayer(window.resultadosPersonalizados);
      }

      window.resultadosPersonalizados = L.geoJSON(data, {
        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {
            icon: L.divIcon({
              className: "denue-marker",
              html: "üìå"  // Icono √∫nico para b√∫squedas
            })
          }).bindPopup(feature.properties.Nombre);
        }
      }).addTo(map);

      // --- Muestra resumen independiente ---
      mostrarResultadosBusqueda(categoria, data.length);
    })
    .catch(err => console.error("Error en la b√∫squeda DENUE:", err));
}


// --- Funci√≥n para mostrar resumen en secci√≥n independiente ---
function mostrarResultadosBusqueda(categoria, total) {
  let contenedor = document.getElementById("resultadosBusqueda");
  if (!contenedor) {
    console.warn("No existe el contenedor con id=resultadosBusqueda");
    return;
  }

  // Limpia siempre los resultados anteriores (opcional)
  contenedor.innerHTML = "";

  // Crea un bloque
  const div = document.createElement("div");
  div.className = "resultado-personalizado";
  div.innerHTML = `
    <span class="icono">üìå</span>
    <span class="nombre">${categoria}</span>
    <span class="conteo">(${total})</span>
  `;

  contenedor.appendChild(div);
}
	
	// ========== PLUGIN PHOTON (si est√° cargado) ==========
const url = {"Nominatim": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&", "BAN": "https://api-adresse.data.gouv.fr/search/?"}	
 var photonControl;
if (L.control.photon) {
  photonControl = L.control.photon({
    url: url["Nominatim"],
    position: 'topleft',
    includePosition: true,
    placeholder: "Buscar direcci√≥n...",
    initial: true
  }).addTo(map);

  // Manejar selecci√≥n de Photon
  photonControl.on('selected', function(e) {
    try {
      if (x) { map.removeLayer(x); x = null; }
      if (marker) { map.removeLayer(marker); marker = null; }

      // Dibujar geometr√≠a si viene en respuesta
      x = L.geoJSON(e.choice).addTo(map);
      const ll = x.getLayers()[0].getLatLng();
      marker = L.marker(ll).addTo(map);
      map.setView(ll, 17);

      // Texto en input
      const label = (e.choice.properties && (e.choice.properties.label || e.choice.properties.display_name)) || '';
      if (e.target && e.target.input) e.target.input.value = label;

      // Si quieres guardar coordenadas en inputs lat/lon
      if (document.getElementById("lat")) document.getElementById("lat").value = ll.lat;
      if (document.getElementById("lon")) document.getElementById("lon").value = ll.lng;
    } catch (err) {
      console.error('Error en selecci√≥n Photon:', err);
    }
  });

  // --- Ajustes visuales del control Photon ---
  const search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
  if (search) {
    search.classList.add("leaflet-control-search");
    search.style.display = "flex";
    search.style.alignItems = "center";
    search.style.backgroundColor = "rgba(255,255,255,0.9)";
    search.style.padding = "2px 6px";
    search.style.borderRadius = "6px";
    search.style.fontFamily = "Poppins, Arial, sans-serif";
    search.style.fontSize = "14px";

    // Bot√≥n üîç centrado
    var button = document.createElement("div");
    button.id = "gcd-button-control";
    button.innerHTML = "üîç"; 
    button.style.fontSize = "18px";
    button.style.cursor = "pointer";
    button.style.marginRight = "6px";
    search.insertBefore(button, search.firstChild);

    // Input visible/invisible al dar clic en üîç
    let last = search.lastChild;
    if (last) last.style.display = "none";
    button.addEventListener("click", function () {
      if (!last) return;
      last.style.display = (last.style.display === "none") ? "block" : "none";
    });
  }
} else {
  console.warn("L.control.photon no est√° disponible (¬øfalta cargar leaflet.photon.js?)");
}


</script>
</body>
</html>
