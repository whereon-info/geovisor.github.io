
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Viabilidad comercial en M√©xico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <!--<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />-->
  <!--<script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>-->

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Hive (tu geojson) -->
  <script type="text/javascript" src="js/hive_ags.js"></script>
  <script type="text/javascript" src="js/hive_hgo.js"></script>
  <script type="text/javascript" src="js/hive_qro.js"></script>	
  <script type="text/javascript" src="js/hive_cdmx.js"></script>
  <script type="text/javascript" src="js/hive_edomex.js"></script>
  <script type="text/javascript" src="js/hive_gto.js"></script>
  <script type="text/javascript" src="js/hive_nay.js"></script>
  <script type="text/javascript" src="js/hive_mor.js"></script>
  <script type="text/javascript" src="js/hive_pue.js"></script>
  <script type="text/javascript" src="js/hive_tlax.js"></script>
  <script type="text/javascript" src="js/hive_slp.js"></script>	
  	

   <!-- NSE -->
  <script type="text/javascript" src="js/nse_ags.js"></script>	
  <script type="text/javascript" src="js/nse_cdmx.js"></script>


  <!-- Buscadores / plugins locales -->
  <link rel="stylesheet" href="css/leaflet-search.css">
  <link rel="stylesheet" href="css/L.Control.Locate.min.css">

  <!-- GOOGLGE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto&display=swap" rel="stylesheet">
	
	<!-- Font Awesome para que funcionen los iconos de locate y search -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

	<!-- Photon CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet.photon/leaflet.photon.css" />
	<script src="https://unpkg.com/leaflet.photon/leaflet.photon.js"></script>

	<!-- html2canvas -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	
	<!-- jsPDF -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

	<!-- Chart -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<!-- SPLIT -->
	<script src="https://unpkg.com/split.js/dist/split.min.js"></script>


  <style>

			 /* ====================== FUENTES ====================== 
			@font-face {
			  font-family: 'MetalOnMetal';
			  src: url('../fonts/MetalOnMetal-OBo.ttf') format('truetype');
			  font-weight: normal;
			  font-style: normal;
			}*/
			
			/* ====================== ESTRUCTURA BASE ====================== */
			html, body {
			  margin: 0;
			  padding: 0;
			  width: 100%;
			  overflow: hidden;
			  display: flex;
			  flex-direction: column;
			  background: #1f1f1f;
			  font-family: 'Poppins', sans-serif;
			  font-size: 14px;
			  color: #f1f1f1;
			}
			
			/* contenedor principal dividido en secciones */
			#main-split {
			  display: flex;
			  flex-direction: column;
			  height: 100vh;
			  width: 100%;
			}
			
			/* fila superior con los paneles horizontales */
			#top-row {
			  display: flex;
			  flex: 1;
			  min-height: 0;
			}
			
			/* contenedor de urbano + scatter */
			#otro {
			  display: flex;
			  flex-direction: column;
			}
			
			/* ====================== MAPA ====================== */
			#map {
			  flex: 1 1 auto;
			  width: 100%;
			  height: 100%;
			  min-height: 400px;
			  border: 2px solid #00793a;
			  box-sizing: border-box;
			}
			
			/* ====================== PANEL BASE ====================== */
			.panel {
			  padding: 8px;
			  box-sizing: border-box;
			  background: #2c2c2c;
			  color: #fff;
			}
			
			/* ====================== GUTTERS (Split.js) ====================== */
			.gutter {
			  background-color: #00793a;
			  transition: background-color 0.2s ease;
			}
			.gutter.gutter-horizontal {
			  z-index: 1000;
			  cursor: col-resize;
			}
			.gutter.gutter-vertical {
			  cursor: row-resize;
			}
			.gutter:hover {
			  background-color: #00b050;
			}
			
			/* ====================== ENCABEZADOS ====================== */
			#title {
			  background: #00793a;
			  color: #ffffff;
			  font-family: 'Poppins', Roboto;
			  text-align: center;
			  padding: 10px;
			  letter-spacing: 1px;
			}
			
			.header {
			  font-weight: bold;
			  margin-bottom: 10px;
			  font-size: 1.1em;
			  text-align: center;
			  background: #f0f0f0;
			  padding: 5px;
			  color: #000;
			}
			
			/* ====================== PANEL ESPEC√çFICOS ====================== */
			#controls {
			  background: #2c2c2c;
			  color: #ffffff;
			  flex: 0 0 auto;
			  font-size: 14px;
			  line-height: 2;
			}
			
			#listado {
			  background: #2c2c2c;
			  color: #ffffff;
			  font-size: 12px;
			  line-height: 1.5;
			}
			
			#sidebar,
			#chart,
			#urbano,
			#graph {
			  background: #2c2c2c;
			  color: #ffffff;
			  font-size: 13px;
			  line-height: 1.5;
			  min-height: 0;
              overflow: auto;
			}
			
			/* ====================== TABLAS ====================== */
			table {
			  width: 100%;
			  border-collapse: collapse;
			}
			th {
			  background: #00793a;
			  position: sticky;
			  top: 0;
			  padding: 6px;
			}
			td {
			  padding: 4px 6px;
			}
			tr:hover {
			  background: rgba(0, 174, 77, 0.3);
			}
			
			/* ====================== LEAFLET ====================== */
			.leaflet-control,
			.leaflet-popup-content {
			  font-family: 'Poppins', sans-serif;
			  font-size: 13px;
			  color: #ffffff;
			}
			
			.leaflet-control-layers {
			  background: rgba(44, 44, 44, 0.8);
			  border-radius: 8px;
			  padding: 6px;
			  color: #ffffff;
			}
			.leaflet-control-layers label {
			  color: #ffffff;
			  font-weight: 500;
			  cursor: pointer;
			}
			
			.leaflet-popup-content-wrapper {
			  background: rgba(44, 44, 44, 0.85);
			  color: #fff;
			  box-shadow: 0 3px 14px rgba(0, 0, 0, 0.5);
			}
			
			.legend {
			  line-height: 18px;
			  color: #fff;
			  background: rgba(44, 44, 44, 0.8);
			  border-radius: 5px;
			  padding: 6px;
			  font-size: 12px;
			}
			.legend i {
			  width: 10px;
			  height: 10px;
			  float: left;
			  margin-right: 6px;
			  opacity: 0.8;
			}
			
			/* ====================== WELCOME BOX ====================== */
			#welcomeBox {
			  position: absolute;
			  top: 25%;
			  left: 50%;
			  transform: translateX(-50%);
			  background: #00793a;
			  padding: 20px;
			  border-radius: 12px;
			  box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.8);
			  z-index: 1000;
			  max-width: 800px;
			  font-family: 'Poppins', sans-serif;
			  font-size: 14px;
			  color: #fff;
			  line-height: 1.5;
			}
			#welcomeContent {
			  position: relative;
			}
			#closeWelcome {
			  position: absolute;
			  top: 5px;
			  right: 10px;
			  cursor: pointer;
			  font-size: 18px;
			  color: #fff;
			}
			
			/* ====================== RESULTADOS ====================== */
			#resultadosBusqueda .resultado-personalizado {
			  display: flex;
			  align-items: center;
			  margin: 4px 0;
			  padding: 6px 8px;
			  background: rgba(200, 230, 255, 0.2);
			  border-radius: 6px;
			}
			#resultadosBusqueda .icono {
			  font-size: 18px;
			  margin-right: 6px;
			}
			#resultadosBusqueda .nombre {
			  flex: 1;
			  font-weight: bold;
			  text-transform: capitalize;
			}
			#resultadosBusqueda .conteo {
			  color: #ccc;
			}
			
			/* ====================== ICONOS Y MARCADORES ====================== */
			.leaflet-marker-icon {
			  width: 50px;
			  height: 50px;
			}
			.custom-pin {
			  font-size: 22px;
			  text-align: center;
			  line-height: 22px;
			}
			
			/* ====================== UBICACI√ìN ====================== */
			#ubica {
			  position: absolute;
			  top: 14%;
			  left: 33%;
			  transform: translateX(-50%);
			  background: #2c2c2c;
			  padding: 6px 10px;
			  border-radius: 8px;
			  box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.8);
			  z-index: 1000;
			  font-size: 11px;
			}
			
			/* ====================== GRAFICAS ====================== */
			#chart {
			  display: flex;
			  flex-direction: column;
			  align-items: stretch;
			  pointer-events: none;
			}
			#myChart, #scatterChart {
			  width: 100%;
			  height: 100%;
			}
			
			/* ====================== PEQUE√ëOS DETALLES ====================== */
			button {
			  background: #00793a;
			  border: none;
			  color: #fff;
			  padding: 6px 10px;
			  border-radius: 6px;
			  cursor: pointer;
			  font-family: 'Poppins', sans-serif;
			}
			button:hover {
			  background: #00b050;
			}
			
			label {
			  color: #fff;
			  font-weight: 500;
			}
			
			hr {
			  border: 1px solid #00793a;
			  margin: 8px 0;
			}

 
  </style>
</head>
<body>

	<div id="title">	<h1> üåé GeoViable - Plataforma para el an√°lisis de la viabilidad comercial en M√©xico</h1>	</div>

	<div id="top-row">
		<div id="controls" class="panel">
		  <p><label> 1Ô∏è‚É£ Establecimiento:</label>
		  <input type="text" id="condi" value="taqueria" /></p>
		  <p><label>Latitud:   </label>
		  <input type="text" id="lat" value="19.432650801677962" /></p>
		  <label>Longitud:</label>
		  <input type="text" id="lon" value="-99.13316794583835" />
		  <p><label>Radio (mts):</label>
		  <input type="number" id="mts" value="1000" /></p>
		  <button id="btnBuscar">Buscar</button>
			<hr>
			<label for="filtroEstado">2Ô∏è‚É£ Filtrar por Entidad:</label>
			<select id="filtroEstado">
			  <option value="todos">Todos</option>
				<option value="AGS">Aguascalientes</option>
				<option value="BC">Baja California</option>
				<option value="BCS">Baja California Sur</option>
				<option value="CAM">Campeche</option>
				<option value="COA">Coahuila</option>
				<option value="COL">Colima</option>
				<option value="CHP">Chiapas</option>
				<option value="CHIH">Chiahuahua</option>
				<option value="CDMX">Ciudad de M√©xico</option>
				<option value="DGO">Durango</option>
		        <option value="GTO">Guanajuato</option>
				<option value="GRO">Guerrero</option>
			    <option value="HGO">Hidalgo</option>
				<option value="JAL">Jalisco</option>
				<option value="MEX">Estado de M√©xico</option>
				<option value="MIC">Michoac√°n</option>
				<option value="MOR">Morelos</option>
				<option value="NAY">Nayarit</option>
				<option value="NL">NuevoLe√≥n</option>
				<option value="OAX">Oaxaca</option>
				<option value="PUE">Puebla</option>
			    <option value="QRO">Quer√©taro</option>
			    <option value="QROO">Quintana Roo</option>
				<option value="SLP">San Luis Potos√≠</option>
				<option value="SIN">Sinaloa</option>
				<option value="SON">Sonora</option>
				<option value="TAB">Tabasco</option>
		        <option value="TAM">Tamaulipas</option>
				<option value="TLX">Tlaxcala</option>
				<option value="VER">Veracruz</option>
				<option value="YUC">Yucac√°n</option>
				<option value="ZAC">Zacatecas</option>	  
			</select>
				<hr>
				<p><label>3Ô∏è‚É£ Busque un lugar:</label>
				<div id="photon-container"></div></p>
			    <hr>
				<label>4Ô∏è‚É£ </label>
				<button id="Ubicacion">Buscar por ubicaci√≥n</button>
				<hr>
				<button id="btnExportar">Exportar a PDF</button>
			    <hr>
			</div>
		<div id="map" class="panel"></div>
	
	

<!-- ================== CHART PANEL ================== -->
		<div id="chart" class="panel">
		  <h3>üìä ¬øA qui√©n le vas a vender?</h3>
		  <div id="info-content"></div>
		  <canvas id="myChart"></canvas>	
		</div>
		
<!-- ================== URBANO PANEL ================== -->
	<div id="otro" class="panel">	
		<div id="urbano" class="panel">
		  <h3>üèôÔ∏è Resultado de las b√∫squedas personalizadas</h3>
		  <div id="resultadosBusqueda"></div>
		</div>

		<div id="scatter" class="panel">
		  <h3>üìâ ¬øComo est√° la situaci√≥n social?</h3>
			<p>
			 <label for="filtroDelito">üìå Selecciona delito:</label>
			  <select id="filtroDelito">
			    <option value="robo a neg">Robo a negocio</option>
			    <option value="extorsi√≥n">Extorsi√≥n</option>
			    <option value="narcomenud">Narcomenudeo</option>
			  </select>
			</p>
		  <canvas id="scatterChart"></canvas>
		</div>
	</div>
		
	<!-- SIDEBAR -->
			
		<div id="sidebar" class="panel">
		   <h3>üìë Ficha de informaci√≥n municipal</h3>
		    <div id="sidebar-content">H√°ga clic en una zona para conocer su informaci√≥n</div>
		</div>
	</div>
		
	

<!-- LISTADO -->
<div id="listado" class="panel">
  <div id="listado-header" style="display:flex;justify-content:space-between;align-items:center;">
    <h2>üìç ¬øQui√©n es tu competencia?</h2>
  </div>
  <table>
    <thead>
      <tr>
        <th>Nombre</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Personal ocupado</th><th>Clase</th>
      </tr>
    </thead>
    <tbody id="tablaResultados"></tbody>
  </table>
</div>

	<div id="welcomeBox">
 		<div id="welcomeContent">
   	 <span id="closeWelcome">&times;</span>
    	<h2>üëã Bienvenido</h2>
   	 <p>A este webmap donde podr√° encontrar informaci√≥n sociodemogr√°fica, econ√≥mica y urbana de las manchas urbanas de ciudades de M√©xico.<br></p>
		<p>Conozca la situaci√≥n social, el status econ√≥mico, el potencial comercial, la competencia que tendr√° su negocio, los elementos urbanos atractores de clientes potenciales, el perfil de los habitantes 
		de la zona donde se encontrar√° su emprendimiento, franquicia y/o sucursal.</p>
		<p>Busque en el recuadro superior el giro de su inter√©s, y/o de clic sobre los hex√°gonos para conocer la informaci√≥n sobre un municipio, zona, lugar o donde se encuentra usted.</p> 
		<p>Renuncia de responsabilidad: Toda la informaci√≥n geoestad√≠stica aqu√≠ presentada es elaborada y por consiguiente propiedad de los institutos, organismos, asociaciones y/o secretar√≠as respectivamente. Whereon s√≥lo procesa y presenta los datos.</p>  
 	 </div>
</div>


<!-- plugins local JS -->
<script src="js/L.Control.Locate.min.js"></script>
	
<script>
document.addEventListener("DOMContentLoaded", function() {
  // ================== SPLIT PRINCIPAL (MAPA Y PANEL DERECHO) ==================
  Split(['#title', '#top-row', '#listado'], {
    sizes: [2, 60, 38],            // proporci√≥n inicial
    minSize: [100, 100],        // tama√±os m√≠nimos en p√≠xeles
    gutterSize: 6,              // ancho del divisor
    direction: 'vertical',
    gutterAlign: 'center',
    snapOffset: 40,
  });

  // ================== SPLIT INTERNO (CHART ‚Üí SIDEBAR Y URBANO) ==================
	  Split(['#controls', '#map', '#chart', '#otro','#sidebar'], {
	    sizes: [10, 30, 25, 20, 15],
	    direction: 'horizontal',
	    gutterSize: 6,
	    minSize: [100, 100]
	  });
	
	  Split(['#urbano', '#scatter'], {
	    sizes: [50, 50],
	    direction: 'vertical',
	    gutterSize: 6,
	    minSize: [100, 100]
	  });
	});

  // ================== ESTILO GUTTERS ==================
  const gutters = document.querySelectorAll('.gutter');
  gutters.forEach(g => {
    g.style.background = '#00793a';
    g.style.border = 'none';
    g.style.transition = 'background 0.2s ease';
    g.addEventListener('mouseenter', () => g.style.background = '#00b050');
    g.addEventListener('mouseleave', () => g.style.background = '#00793a');
  });


  // ========== MAPA + CAPAS ==========
  const map = L.map('map',{
			center: [22.5, -102.5],
			zoom: 4,
			maxZoom: 18,
			minZoom: 2, 
			});
	  

			// üåç Mapa claro (OSM est√°ndar)
			const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			});
			
			// üåÉ Mapa oscuro (Carto Dark)
			const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>'
			});
			
			// ‚òÄÔ∏è Carto Light
			const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>'
			});
			
			// üõ∞Ô∏è Esri Sat√©lite
			const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
			});
	
			
			// üëÄ Agregar el mapa base por defecto (ejemplo: OSM claro)
			dark.addTo(map);
	

		// ================== Cerrar con la X ====================
		document.getElementById("closeWelcome").addEventListener("click", () => {
		  document.getElementById("welcomeBox").style.display = "none";
		});
		
		// Cerrar haciendo clic en el mapa
		map.on("click", () => {
		  document.getElementById("welcomeBox").style.display = "none";
		});

		// Cerrar haciendo clic en el mapa
		map.on("click", () => {
		  document.getElementById("ubica").style.display = "none";
		});

	
  // ========== VARIABLES COMPARTIDAS (evita ReferenceError) ==========
  var x = null;            // geojson temporal usado por photon
  var marker = null;       // marcador temporal usado por photon
  var last = null;

  // ========== LOCATE ======================
	  L.control.locate({ locateOptions: { maxZoom: 10 } }).addTo(map);
	  var draggableMarker;
		map.on("locationfound", function (e) {
	  if (draggableMarker) {
	    draggableMarker.setLatLng(e.latlng);
	  } else {
	    draggableMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
	
	    // Cuando se arrastra, actualizamos inputs
	    draggableMarker.on("dragend", function (ev) {
	      var pos = ev.target.getLatLng();
	      document.getElementById("lat").value = pos.lat.toFixed(6);
	      document.getElementById("lon").value = pos.lng.toFixed(6);
	    });
	  }
	
	  // Guardar coordenadas iniciales en los inputs
	  document.getElementById("lat").value = e.latlng.lat.toFixed(6);
	  document.getElementById("lon").value = e.latlng.lng.toFixed(6);
	  map.setView(e.latlng, 15);
	});
	
	// Si falla la localizaci√≥n
	map.on("locationerror", function () {
	  alert("No se pudo obtener tu ubicaci√≥n");
	});

	
  // ======================= DENUE =============================================
 //const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";

// üîπ Funci√≥n auxiliar para asignar √≠conos seg√∫n la actividad
function getBootstrapIconFromActividad(actividad) {
  if (!actividad) return L.divIcon({ className: "custom-pin", html: "üìç" });

  actividad = actividad.toLowerCase();
  if (actividad.includes("pizza") || actividad.includes("pizzer√≠a")) {
    return L.divIcon({ className: "custom-pin", html: "üçï" });
  } else if (actividad.includes("escuela") || actividad.includes("colegio") || actividad.includes("prepa") || actividad.includes("preparatoria") || actividad.includes("universidad")) {
    return L.divIcon({ className: "custom-pin", html: "üè´" });
  } else if (actividad.includes("banco")|| actividad.includes("banca multiple")) {
    return L.divIcon({ className: "custom-pin", html: "üè¶" });
  } else if (actividad.includes("hotel") || actividad.includes("motel") || actividad.includes("hostal")) {
    return L.divIcon({ className: "custom-pin", html: "üè®" });
  } else if (actividad.includes("super") || actividad.includes("bodega") || actividad.includes("tienda") || actividad.includes("abarrotes")) {
    return L.divIcon({ className: "custom-pin", html: "üõí" });
  } else if (actividad.includes("tacos") || actividad.includes("taquer√≠a") || actividad.includes("taqueria") || actividad.includes("comida mexicana")) {
    return L.divIcon({ className: "custom-pin", html: "üåÆ" });
  } else if (actividad.includes("hamburguesas") || actividad.includes("hamburgueseria") || actividad.includes("hamburgueseria")) {
    return L.divIcon({ className: "custom-pin", html: "üçî" });
  } else if (actividad.includes("sushi")) {
    return L.divIcon({ className: "custom-pin", html: "üçú" });
  }
  
   

  // valor por defecto
  return L.divIcon({ className: "custom-pin", html: "üìç" });
}

// üîπ Funci√≥n principal para buscar en DENUE
async function buscarDENUE(condi, lat, lon, mts) {
  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e"; // tu token DENUE
  const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(condi)}/${lat},${lon}/${mts}/${token}`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const resultados = await response.json();

    // üìç Limpiar tabla y pines anteriores
    document.getElementById("tablaResultados").innerHTML = "";
    if (window.denueLayer) {
      map.removeLayer(window.denueLayer);
    }
    window.denueLayer = L.layerGroup().addTo(map);

    // üìä Procesar resultados
    resultados.forEach(item => {
      // --- Agregar fila en la tabla ---
      const row = `
        <tr>
          <td>${item.Nombre || "Sin nombre"}</td>
          <td>${item.Calle || ""} ${item.Num_Exterior || ""}, ${item.Colonia || ""}, ${item.Municipio || ""}</td>
          <td>${item.Telefono || "N/D"}</td>
          <td>${item.Estrato || "N/D"}</td>
          <td>${item.Clase_actividad || "N/D"}</td>
        </tr>
      `;
      document.getElementById("tablaResultados").insertAdjacentHTML("beforeend", row);

      // --- Agregar marcador en el mapa ---
      const marker = L.marker([item.Latitud, item.Longitud], {
        icon: getBootstrapIconFromActividad(item.Clase_actividad)
      }).bindPopup(`<b>${item.Nombre}</b><br>${item.Clase_actividad}<br>${item.Calle || ""}, ${item.Colonia || ""}`);
      marker.addTo(window.denueLayer);
    });

    // üìå Mostrar en el sidebar un resumen
    mostrarResultadosBusqueda(condi, resultados.length);

  } catch (error) {
    console.error("Error en buscarDENUE:", error);
    alert("‚ùå No se pudieron obtener resultados del DENUE.");
  }
}

// ================== GR√ÅFICA ==================
let chart = new Chart(document.getElementById("myChart"), {
  type: "pie",
  data: {
    labels: ["0-14 a√±os", "15-64 a√±os", "65+ a√±os"],
    datasets: [{
      backgroundColor: ["#00ae4d", "#99ca3c", "#d7df23"],
      data: [0, 0, 0]
    }]
  },
  options: {
    responsive: true,
	maintainAspectRatio: true,
    title: {
      display: true,
      text: "Poblaci√≥n seg√∫n grupo de edad"
    }
  }
});

// ================== FUNCIONES DE IMPRESI√ìN ==================
function mostrarEnSidebar(html) {
  const cont = document.getElementById("sidebar-content");
  if (cont) cont.innerHTML = html;
}

function agregarEnSidebar(html) {
  const cont = document.getElementById("sidebar-content");
  if (cont) cont.innerHTML += html;
}

function mostrarEnGraph(html) {
  const cont = document.getElementById("info-content");
  if (cont) cont.innerHTML = html;
}

function mostrarEnUrbano(html) {
  const cont = document.getElementById("sidebar-content");
  if (cont) {
    const bloqueUrbano = `
      <div id="info-urbano">
        ${html}
      </div>
    `;
    cont.innerHTML += bloqueUrbano;
  }
}




// ================== FUNCIONES URBANOS ==================
function procesarDENUE(resumen, extras) {
  let listado =  `<h3>üèôÔ∏è Elementos urbanos dentro de la zona</h3>`;

   listado += "<ul>";
	
	for (const [cat, num] of Object.entries(resumen)) {
    listado += `<li>${getEmojiCategoria(cat)} <strong>${cat}:</strong> ${num}</li>`;
  }
  listado += "</ul>";
  listado += "<ul>";
	
  if (Object.keys(extras).length > 0) {
    listado += "<h3>üîç Otros establecimientos:</h3>";
    for (const [cat, num] of Object.entries(extras)) {
      listado += `<li>üìç<h3>${cat}:</h3> ${num}</li>`;
    }
	  listado += "</ul>";
     }

  mostrarEnUrbano(listado);
}

function getEmojiCategoria(cat) {
  const emojis = {
    "Bancos": "üè¶",
    "Supermercados": "üõí",
    "Escuelas": "üè´",
    "Hoteles": "üè®"
  };
  return emojis[cat] || "üìç";
}

// ================== EVENTOS EN HEXAGONOS ==================
function onEachFeature(feature, layer) {
  layer.on("click", async () => {
    const props = feature.properties || {};

    // --- Sidebar fijo ---
    const htmlFija = `
      <div id="info-fija">
        <h2>${props.nomgeo || "Zona"}</h2>
        <b>Tipo:</b> ${props.TIPO || "N/A"}<br>
        <p><b>Poblaci√≥n municipal total:</b> ${props.pobtot?.toLocaleString() || 0}</p>
        <p><b>Poblaci√≥n adulta municipal:</b> ${props.POBADUL?.toLocaleString() || 0}</p>
        <p><b>√çndice de Rezago:</b> ${props.REZAGO || "N/A"}</p><hr>
        <p><b>Extorsi√≥n:</b> ${props["extorsi√≥n"] || 0}</p>
        <p><b>Narcomenudeo:</b> ${props.narcomenud || 0}</p>
        <p><b>Robo a negocio:</b> ${props["robo a neg"] || 0}</p><hr>
        <p><b>Cr√©ditos personales:</b> ${props.CRED_PERS?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos n√≥mina:</b> ${props.CRED_NOMI?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos hipotecarios:</b> ${props.CRED_HIPOT?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos automotrices:</b> ${props.CRED_AUTOM?.toLocaleString() || 0}</p>
      </div><hr>
    `;
    mostrarEnSidebar(htmlFija);

    // --- Calculo y densidades ---
    const pobTot = props.POBTOT_sum || 0;
    const pob0_14 = props.POB0_14_sum || 0;
    const pob15_64 = props.POB15_64_sum || 0;
    const pob65   = props.POB65_MAS_sum || 0;

    const densidadTot = (pobTot / 700).toFixed(2);
    const densidad0_14 = (pob0_14 / 700).toFixed(2);
    const densidad15_64 = (pob15_64 / 700).toFixed(2);
    const densidad65 = (pob65 / 700).toFixed(2);

    const infoPob = `
      <p><b>Pertenece al municipio de:</b> ${props.nomgeo || "Zona"}</p>
      <p><b>Poblaci√≥n total: </b> ${pobTot.toLocaleString()} 
        <i>(Dens.: ${densidadTot} hab/ha)</i></p>
      <p><b>Poblaci√≥n de 0 a 14 a√±os: </b> ${pob0_14.toLocaleString()} 
        <i>(Dens.: ${densidad0_14} hab/ha)</i></p>
      <p><b>Poblaci√≥n de 15 a 64 a√±os: </b> ${pob15_64.toLocaleString()} 
        <i>(Dens.: ${densidad15_64} hab/ha)</i></p>
      <p><b>Poblaci√≥n de +65 a√±os: </b> ${pob65.toLocaleString()} 
        <i>(Dens.: ${densidad65} hab/ha)</i></p>
    `;
    mostrarEnGraph(infoPob);

    // --- Actualizar gr√°fica ---
    chart.data.datasets[0].data = [pob0_14, pob15_64, pob65];
    chart.update();

    // --- Consulta DENUE ---
    const bounds = layer.getBounds();
    const resultados = await buscarEnHexagono(bounds, ["banco","super","escuela","hotel"]);

    const resumen = { Bancos:0, Supermercados:0, Escuelas:0, Hoteles:0 };
    const extras = {};

    resultados.forEach(item => {
      const c = (item.Clase_actividad || "").toLowerCase();
      if (c.includes("banco") || c.includes("banca m√∫ltiple")) resumen.Bancos++;
      else if (c.includes("escuela") || c.includes("colegio") || c.includes("universidad")) resumen.Escuelas++;
      else if (c.includes("super") || c.includes("bodega") || c.includes("abarrotes")) resumen.Supermercados++;
      else if (c.includes("hotel") || c.includes("motel") || c.includes("hostal")) resumen.Hoteles++;
      else {
        const nombre = item.Clase_actividad.trim();
        extras[nombre] = (extras[nombre] || 0) + 1;
      }
    });

    procesarDENUE(resumen, extras);
  });
}


  //======================= LOGO ================================
	var logoControl = L.control({ position: "bottomleft" });

	logoControl.onAdd = function (map) {
	    var div = L.DomUtil.create("div", "logo-leaflet");
	    div.innerHTML = '<img src="images/WhereOn-Blanco-Vert.png" style="width:80px; opacity:0.9;">';
	    return div;
	};
	
	logoControl.addTo(map);
  
  // ========== ESTILO / LAYERS ==========
  function getColor(d) {
    return d > 50000 ? '#d7191c' :
           d > 25000 ? '#fdae61' :
           d > 10000 ? '#ffffbf' :
           d > 5000  ? '#abdda4' :
           d > 1     ? '#2b83ba':
		               '#2d2d2d';
  }
  
	function style(feature) {
    return {
      fillColor: getColor(feature.properties?.["POBTOT_sum"]),
      weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
    };
  }


  // Leyenda
  var legendHex = L.control({position: 'bottomright'});
  legendHex.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1, 5000, 10000, 25000, 50000];
	  div.innerHTML += "<b>Poblaci√≥n</b><br>";
    for (var i = 0; i < grades.length; i++) {
      div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                       grades[i] + (grades[i+1] ? '&ndash;' + grades[i+1] + '<br>' : '+');
    }
    return div;
  };
  legendHex.addTo(map);

	

  // ========== ESTILO NSE ==========

	function getColorNSE(tipo) {
	  switch (tipo) {
	    case 'A/B': return '#1f77b4';
	    case 'C+':  return '#0ddec9';
	    case 'C':   return '#2ca02c';
	    case 'C-':  return '#95de0d';
	    case 'D+':  return '#ffd200';
	    case 'D':   return '#ff7f0e';
	    case 'E':   return '#d62728';
	    default:    return '#cccccc';
	  }
	}
	function styleNSE(feature) {
	 return {
	 fillColor: getColorNSE (feature.properties["NIVEL PREDOMINANTE"]),
	 weight: 2,
	 opacity: 1,
	 color: 'white',
	 dashArray: '3',
	 fillOpacity: 0.7
		 };
		}

	const nseAgs = L.geoJson(nse_ags, {
	  style: styleNSE,
	  onEachFeature: function (feature, layer) {
	    layer.bindPopup("Nivel socioecon√≥mico predominante: " + feature.properties["NIVEL PREDOMINANTE"]);
	  }
	});
	
	const nseCdmx = L.geoJson(nse_cdmx, {
	  style: styleNSE,
	  onEachFeature: function (feature, layer) {
	    layer.bindPopup("Nivel socioecon√≥mico predominante: " + feature.properties["NIVEL PREDOMINANTE"]);
	  }
	});
	
	
	// HIVE
	const hiveLayer01 = L.geoJson(hive_ags, { style, onEachFeature });
	const hiveLayer13 = L.geoJson(hive_hgo, { style, onEachFeature });
	const hiveLayer22 = L.geoJson(hive_qro, { style, onEachFeature });
	const hiveLayer09 = L.geoJson(hive_cdmx, { style, onEachFeature });
	const hiveLayer15 = L.geoJson(hive_edomex, { style, onEachFeature });
	const hiveLayer11 = L.geoJson(hive_gto, { style, onEachFeature });
	const hiveLayer17 = L.geoJson(hive_mor, { style, onEachFeature });
	const hiveLayer18 = L.geoJson(hive_nay, { style, onEachFeature });
	const hiveLayer21 = L.geoJson(hive_pue, { style, onEachFeature });
	const hiveLayer29 = L.geoJson(hive_tlax, { style, onEachFeature });
	const hiveLayer24 = L.geoJson(hive_slp, { style, onEachFeature });
	
	// GRUPOS
	const hiveGroup = L.layerGroup([hiveLayer01, hiveLayer09, hiveLayer11, hiveLayer15, hiveLayer13, hiveLayer17, hiveLayer18, hiveLayer21, hiveLayer22, hiveLayer24, hiveLayer29]).addTo(map);
	const nseGroup = L.layerGroup([nseAgs,nseCdmx]);

			var legendNSE = L.control({ position: 'bottomright' });
		legendNSE.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'info legend'),
		      categories = ['A/B', 'C+', 'C', 'C-', 'D+', 'D', 'E'];
		  div.innerHTML += "<b>NSE</b><br>";
		  for (var i = 0; i < categories.length; i++) {
		    div.innerHTML +=
		      '<i style="background:' + getColorNSE(categories[i]) + '"></i> ' +
		      categories[i] + '<br>';
		  }
		  return div;
		};
		legendNSE.addTo(map);
		
			// Mostrar la leyenda correspondiente
		map.on('overlayadd', function (eventLayer) {
		  if (eventLayer.name === "HIVE") {
		    map.addControl(legendHex);
		  }
		  if (eventLayer.name === "NSE") {
		    map.addControl(legendNSE);
		  }
		});
		
		map.on('overlayremove', function (eventLayer) {
		  if (eventLayer.name === "HIVE") {
		    map.removeControl(legendHex);
		  }
		  if (eventLayer.name === "NSE") {
		    map.removeControl(legendNSE);
		  }
		});

  // üéõÔ∏è Ahora s√≠ agregamos control de capas
		var baseMaps = {
          "Oscuro": dark,
		  "Claro": osm,
          "Light": light,
          "Sat√©lite": esriSat,	
        };
               
        var overlays = {
		  "HIVE": hiveGroup,
		  "NSE": nseGroup,
        };
        
        L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);

// ============================== FILTRO ======================================

const hiveLayers = {
  AGS: hiveLayer01,
  HGO: hiveLayer13,
  QRO: hiveLayer22,
  CDMX: hiveLayer09,
  MEX: hiveLayer15,
  GTO: hiveLayer11,
  MOR: hiveLayer17,
  NAY: hiveLayer18,
  PUE: hiveLayer21,
  SLP: hiveLayer24,	
  TLX: hiveLayer29
  };

	
// ============================== RESUMEN DENUE ======================================

document.getElementById('btnBuscar').addEventListener('click', () => {
  const condi = document.getElementById("condi").value;
  const lat = document.getElementById("lat").value;
  const lon = document.getElementById("lon").value;
  const mts = document.getElementById("mts").value;

  buscarDENUE(condi, lat, lon, mts);
});


// ================= FUNCION buscarEnHexagono ===================
	async function buscarEnHexagono(bounds, categorias) {
	  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";
	
	  // üëâ Tomamos el centro del hex√°gono
	  const center = bounds.getCenter();
	
	  // üëâ Aproximamos un radio en metros (diagonal menor del bounding box)
	  const latDiff = bounds.getNorth() - bounds.getSouth();
	  const lonDiff = bounds.getEast() - bounds.getWest();
	  const approxKm = Math.max(latDiff, lonDiff) * 111; // 1¬∞ ‚âà 111 km
	  const radius = Math.round(approxKm * 1000 / 2); // en metros
	
	  let resultados = [];
	
	  for (const cat of categorias) {
	    const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${center.lat},${center.lng}/${radius}/${token}`;

	    try {
	      const resp = await fetch(url);
	      if (resp.ok) {
	        const data = await resp.json();
	        if (Array.isArray(data)) resultados = resultados.concat(data);
	      }
	    } catch (e) {
	      console.error("Error consultando categor√≠a", cat, e);
	    }
	  }
	
	  return resultados;
	}


  // Utilidad: getIconoCategoria (usa tu funci√≥n original)
  function getIconoCategoria(cat){
    switch(cat){
      case "Bancos": return '<i class="bi bi-bank"></i>';
      case "Supermercados": return '<i class="bi bi-basket3-fill"></i>';
      case "Escuelas": return '<i class="bi bi-mortarboard-fill"></i>';
      case "Hoteles": return '<i class="bi bi-building"></i>';
      default: return '<i class="bi bi-geo-alt-fill"></i>';
    }
  }

function mostrarResultadosBusqueda(condi, total) {
  const cont = document.getElementById("resultadosBusqueda");
  cont.innerHTML = `
    <div class="resultado-personalizado">
      <span class="icono">üìä</span>
      <span class="nombre">${condi}</span>
      <span class="conteo">(${total} encontrados)</span>
    </div>
  `;
}



	
	// ========== PLUGIN PHOTON ==========
	
if (L.control.photon) {
  // Inicializa Photon en el mapa
  const photonControl = L.control.photon({
    url: "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
    placeholder: "Buscar direcci√≥n..."
  }).addTo(map);

  // Mueve el nodo a #controls
  const photonNode = document.getElementsByClassName("leaflet-photon")[0];
  if (photonNode) {
    document.getElementById("photon-container").appendChild(photonNode);
  }

  // Evento cuando seleccionas un resultado
  photonControl.on('selected', function(e) {
    try {
      if (x) { map.removeLayer(x); x = null; }
      if (marker) { map.removeLayer(marker); marker = null; }

      // Dibujar geometr√≠a si existe
      x = L.geoJSON(e.choice).addTo(map);
      const ll = x.getLayers()[0].getLatLng();
      marker = L.marker(ll).addTo(map);
      map.setView(ll, 17);

      // Actualizar inputs
      if (document.getElementById("lat")) document.getElementById("lat").value = ll.lat;
      if (document.getElementById("lon")) document.getElementById("lon").value = ll.lng;
    } catch (err) {
      console.error('Error en selecci√≥n Photon:', err);
    }
  });
} else {
  console.warn("L.control.photon no est√° disponible (¬øfalta cargar leaflet.photon.js?)");
}

	



// ============== BOTON PDF ===================================
	
  //document.getElementById("btnExportar").addEventListener("click", function () {
    //const contenedor = document.getElementById("mapa-contenedor");

   // html2canvas(contenedor, {
     // useCORS: true, // para tiles externos
      //scale: 2       // mejor calidad
    //}).then(canvas => {
      //const imgData = canvas.toDataURL("image/png");
      //const { jsPDF } = window.jspdf;
      //const pdf = new jsPDF("landscape", "mm", "a4");

      //const pageWidth = pdf.internal.pageSize.getWidth();
      //const pageHeight = pdf.internal.pageSize.getHeight();

      //const imgWidth = pageWidth;
      //const imgHeight = canvas.height * pageWidth / canvas.width;

      //pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
      //pdf.save("mapa_resultados.pdf");
    //});
  //});

// ============== UBICACION ===================================

document.getElementById("Ubicacion").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("‚ö†Ô∏è Tu navegador no soporta geolocalizaci√≥n");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // üëá Quitar marcador previo si existe
      if (window.miUbicacionMarker) {
        map.removeLayer(window.miUbicacionMarker);
      }

      // üëá Crear marcador en la ubicaci√≥n del usuario
      window.miUbicacionMarker = L.marker([lat, lon], {
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", // √çcono personalizado
          iconSize: [30, 30]
        })
      }).addTo(map).bindPopup("üìç Est√°s aqu√≠").openPopup();

      // üëá Hacer zoom al punto
      map.setView([lat, lon], 15);

      // üëá Si quieres llenar inputs en #controls
      if (document.getElementById("lat")) document.getElementById("lat").value = lat;
      if (document.getElementById("lon")) document.getElementById("lon").value = lon;
    },
    (err) => {
      alert("‚ùå No se pudo obtener la ubicaci√≥n: " + err.message);
    }
  );
});


// ================== CHART SCATTER ==================
let scatterChart = new Chart(document.getElementById("scatterChart"), {
  type: "bubble",
  data: {
    datasets: [{
      label: "Robo a negocio",
      backgroundColor: "#ff6384",
      borderColor: "#ff6384",
      pointRadius: 5,
      data: [] // se llenar√° din√°micamente
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: {
        type: "category",
        title: { display: true, text: "Municipio" }
      },
      y: {
        beginAtZero: true,
        title: { display: true, text: "Incidencia delictiva municipal" }
      }
    },
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            let punto = context.raw;
            return `${punto.x}: ${punto.y} casos`;
          }
        }
      }
    }
  }
});


// ================== FUNCI√ìN PARA ACTUALIZAR SCATTER ==================
function actualizarScatter(layer, delito) {
  const datos = [];
  layer.eachLayer(l => {
    const props = l.feature?.properties || {};
    const municipio = props.nomgeo || "N/A";
    const valor = props[delito] || 0;
    datos.push({ x: municipio, y: valor });
  });

  scatterChart.data.datasets[0].data = datos;
  scatterChart.data.datasets[0].label = delito.toUpperCase();
  scatterChart.update();
}



// ================== EVENTO FILTRO ==================
document.getElementById("filtroEstado").addEventListener("change", () => {
  actualizarScatterConFiltros();
});

document.getElementById("filtroDelito").addEventListener("change", () => {
  actualizarScatterConFiltros();
});

function actualizarScatterConFiltros() {
  const estado = document.getElementById("filtroEstado").value;
  const delito = document.getElementById("filtroDelito").value;

  hiveGroup.clearLayers();

  if (estado === "todos") {
    Object.values(hiveLayers).forEach(layer => hiveGroup.addLayer(layer));
    actualizarScatter(hiveGroup, delito);

    // üîπ Zoom a todos los estados
    const bounds = hiveGroup.getBounds();
    if (bounds.isValid()) map.fitBounds(bounds);

  } else {
    let capa = hiveLayers[estado];
    hiveGroup.addLayer(capa);
    actualizarScatter(capa, delito);

    // üîπ Zoom al estado seleccionado
    const bounds = capa.getBounds();
    if (bounds.isValid()) map.fitBounds(bounds);
  }
}

	function actualizarScatter(layer, delito) {
  let datos = [];

  layer.eachLayer(l => {
    const props = l.feature?.properties || {};
    const municipio = props.nomgeo || "N/A";
    const valor = props[delito] || 0;

    datos.push({ x: municipio, y: valor });
  });

  scatterChart.data.datasets[0].data = datos;
  scatterChart.options.plugins.title.text =
    "Delito seleccionado: " + delito.toUpperCase();
  scatterChart.update();
}




</script>
</body>
</html>
































































