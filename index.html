<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Estudio de mercado a un clic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Hive (tu geojson) -->
  <script type="text/javascript" src="js/hive_cdmx.js"></script>
  <script type="text/javascript" src="js/hive_edomex.js"></script>

  <!-- Buscadores / plugins locales -->
  <link rel="stylesheet" href="css/leaflet-search.css">
  <link rel="stylesheet" href="css/L.Control.Locate.min.css">
  <link rel="stylesheet" href="css/leaflet.photon.css">
  <link rel="stylesheet" href="css/leaflet-measure.css">

  <style>
    body,html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .leaflet-sidebar { z-index:1000; }

    .legend {line-height: 18px; color: #999999;}
    .legend i {width: 18px;height: 18px; float: left;margin-right: 8px;opacity: 0.7;}
    .leaflet-sidebar-header {height: 40px;line-height: 40px; font-size: 10pt; color:#fff; background-color:#000; margin:-10px -20px 0; padding:0 20px;}
    /* .leaflet-sidebar-content {position:absolute; top:0; bottom:0; background-color:rgba(0,0,0,.95); overflow-x:hidden; overflow-y:auto;} */

    .info {padding:6px 8px; font:14px/16px Arial, Helvetica, sans-serif; background: rgba(186,186,186,0.8); box-shadow:0 0 15px rgba(0,0,0,0.2); border-radius:5px;}
    .info h2 { margin:0 0 5px; color:#404040; }

    #listado, #sidebar-content { transition: height 0.4s ease, padding 0.4s ease; }
    #listado.minimized { height: 30px; overflow: hidden; }
    #sidebar-content.minimized { height: 30px; overflow: hidden; }

    #controls { padding:10px; background:#FFFFFF; border-bottom:1px solid #FFFFFF; }
    label { color:gray; }

    table { width: 100%; border-collapse: collapse; color: #999999; }
    th, td { padding: 8px; border-bottom: 1px solid #FFFFFF; }
    tr:hover { background: #000000; cursor: pointer; }
    th { background: #0000000; position: sticky; top: 0; }
  </style>
</head>
<body>
<div id="controls">
  <label>Establecimiento:</label>
  <input type="text" id="condi" value="pizzerías" />
  <label>Latitud:</label>
  <input type="text" id="lat" value="19.432650801677962" />
  <label>Longitud:</label>
  <input type="text" id="lon" value="-99.13316794583835" />
  <label>Metros:</label>
  <input type="number" id="mts" value="1000" />
  <button id="btnBuscar">Buscar</button>
  <button id="btnExportar">Exportar a PDF</button>
</div>

<div id="map"></div>

<!-- SIDEBAR -->
<div id="sidebar" class="leaflet-sidebar collapsed">
  <div class="leaflet-sidebar-tabs">
    <ul role="tablist">
      <li><a href="#info" role="tab"><i class="bi bi-info-circle"></i></a></li>
    </ul>
  </div>
  <div class="leaflet-sidebar-content">
    <div class="leaflet-sidebar-pane" id="info">
      <div id="sidebar-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h4 class="leaflet-sidebar-header" style="margin:0;">📊 Ficha de información urbano social y económica</h4>
        <button id="btnSidebarToggle"><i class="bi bi-dash"></i></button>
      </div>
      <div id="sidebar-content">Haz clic en una zona para conocer su información</div>
    </div>
  </div>
</div>

<!-- LISTADO -->
<div id="listado">
  <div id="listado-header" style="display:flex;justify-content:space-between;align-items:center;">
    <h4>📍 Tabla de resultados de establecimientos económicos</h4>
    <button id="btnToggle"><i class="bi bi-dash"></i></button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Nombre</th><th>Dirección</th><th>Teléfono</th><th>Personal ocupado</th><th>Clase</th>
      </tr>
    </thead>
    <tbody id="tablaResultados"></tbody>
  </table>
</div>

<!-- plugins local JS -->
<script src="js/leaflet.photon.js"></script>
<script src="js/leaflet-measure.js"></script>
<script src="js/leaflet-search.js"></script>
<script src="js/L.Control.Locate.min.js"></script>

<script>
  // ========== MAPA + CAPAS ==========
  const map = L.map('map').setView([22.5, -100.5], 5);

  // tile layers (defínelas y agrégalas a control después)
  const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

  // ========== VARIABLES COMPARTIDAS (evita ReferenceError) ==========
  var x = null;            // geojson temporal usado por photon
  var marker = null;       // marcador temporal usado por photon
  var last = null;

  // ========== CONTROLES (locate, measure) ==========
  L.control.locate({ locateOptions: { maxZoom: 19 } }).addTo(map);

  var measureControl = new L.Control.Measure({
    position: 'topleft',
    primaryLengthUnit: 'meters',
    secondaryLengthUnit: 'kilometers',
    primaryAreaUnit: 'sqmeters',
    secondaryAreaUnit: 'hectares'
  });
  measureControl.addTo(map);

  // Protege acceso si elemento no existe aún
  const measureToggleEls = document.getElementsByClassName('leaflet-control-measure-toggle');
  if (measureToggleEls.length) {
    measureToggleEls[0].innerHTML = '';
    measureToggleEls[0].className += ' fas fa-ruler';
  }

  // ========== PLUGIN PHOTON (si está cargado) ==========
  const url = {
    "Nominatim": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
    "BAN": "https://api-adresse.data.gouv.fr/search/?"
  };

  var photonControl;
  if (L.control.photon) {
    photonControl = L.control.photon({
      url: url["Nominatim"],
      feedbackLabel: '',
      position: 'topleft',
      includePosition: true,
      initial: true
    }).addTo(map);

    // Manejar selección de Photon (usa x y marker ya declarados)
    photonControl.on('selected', function(e) {
      try {
        if (x) { map.removeLayer(x); x = null; }
        if (marker) { map.removeLayer(marker); marker = null; }

        x = L.geoJSON(e.choice).addTo(map);
        const ll = x.getLayers()[0].getLatLng();
        marker = L.marker(ll).addTo(map);
        map.setView(ll, 17);

        const label = (e.choice.properties && (e.choice.properties.label || e.choice.properties.display_name)) || '';
        if (e.target && e.target.input) e.target.input.value = label;
      } catch (err) {
        console.error('Error en selección Photon:', err);
      }
    });

    // Ajustes visuales del control photon (si existe)
    const search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
    if (search) {
      search.classList.add("leaflet-control-search");
      search.style.display = "flex";
      search.style.backgroundColor = "rgba(255,255,255,0.5)";

      // botón extra (opcional)
      var button = document.createElement("div");
      button.id = "gcd-button-control";
      button.className = "gcd-gl-btn fa fa-search search-button";
      search.insertBefore(button, search.firstChild);
      last = search.lastChild;
      if (last) last.style.display = "none";
      button.addEventListener("click", function () {
        if (!last) return;
        last.style.display = (last.style.display === "none") ? "block" : "none";
      });
    }
  } else {
    console.warn("L.control.photon no está disponible (archivo leaflet.photon.js no cargado?)");
  }

  // ========== SIDEBAR ==========
  const sidebar = L.control.sidebar({ container:'sidebar', position:'right' }).addTo(map);
  function mostrarEnSidebar(html){
    document.getElementById("sidebar-content").innerHTML = html;
    sidebar.open("info");
  }

  // token y markersLayer
  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";
  let markersLayer = L.featureGroup().addTo(map);

  // ====== Íconos y funciones DENUE ======
  function getBootstrapIconFromActividad(clase) {
    clase = (clase || "").toLowerCase();
    let iconHTML;
    if (clase.includes("restaurante")) iconHTML = '<i class="bi bi-shop" style="font-size:26px;color:orange"></i>';
    else if (clase.includes("hotel")) iconHTML = '<i class="bi bi-building" style="font-size:26px;color:blue"></i>';
    else iconHTML = '<i class="bi bi-geo-alt-fill" style="font-size:26px;color:red"></i>';
    return L.divIcon({ html: iconHTML, className: 'custom-div-icon', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-26] });
  }

  async function buscarEnHexagono(bounds, categorias) {
    let resultados = [];
    const centro = bounds.getCenter();
    for (const cat of categorias) {
      const urlApi = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${centro.lat},${centro.lng}/1000/${token}`;
      try {
        const resp = await fetch(urlApi);
        if (!resp.ok) continue;
        const data = await resp.json();
        const dentro = data.filter(d => {
          const lat = parseFloat(d.Latitud), lon = parseFloat(d.Longitud);
          return !isNaN(lat) && !isNaN(lon) && bounds.contains([lat, lon]);
        });
        resultados.push(...dentro);
      } catch (err) {
        console.error("Error en consulta DENUE:", err);
      }
    }
    return resultados;
  }

  // ========== FUNCIONES DE HEXÁGONOS ==========
  function onEachFeature(feature, layer) {
    layer.on("click", async () => {
      const props = feature.properties || {};

      const htmlFija = `
        <div id="info-fija">
          <h2>${props.nomgeo || 'Zona'}</h2>
          <b>Tipo:</b> ${props.TIPO || 'N/A'}<br>
          <p><b>Población municipal total:</b> ${props.pobtot?.toLocaleString() || 0}</p>
          <p><b>Población adulta municipal:</b> ${props.POBADUL?.toLocaleString() || 0}</p>
          <p><b>Índice de Rezago:</b> ${props.REZAGO || 'N/A'}</p><hr>
          <p><b>Extorsión:</b> ${props["extorsión"] || 0}</p>
          <p><b>Narcomenudeo:</b> ${props.narcomenud || 0}</p>
          <p><b>Robo a negocio:</b> ${props["robo a neg"] || 0}</p><hr>
          <p><b>Créditos personales:</b> ${props.CRED_PERS?.toLocaleString() || 0}</p>
          <p><b>Créditos nómina:</b> ${props.CRED_NOMI?.toLocaleString() || 0}</p>
          <p><b>Créditos hipotecarios:</b> ${props.CRED_HIPOT?.toLocaleString() || 0}</p>
          <p><b>Créditos automotrices:</b> ${props.CRED_AUTOM?.toLocaleString() || 0}</p>
        </div>
        <div id="info-dinamica">Cargando...</div>
      `;
      mostrarEnSidebar(htmlFija);

      const bounds = layer.getBounds();
      const resultados = await buscarEnHexagono(bounds, ["bancos","supermercados","escuelas","hoteles"]);

      // Agrupar
      const resumen = { Bancos:0, Supermercados:0, Escuelas:0, Hoteles:0 };
      for (const item of resultados) {
        const c = (item.Clase_actividad || "").toLowerCase();
        if (c.includes("banco")) resumen.Bancos++;
        else if (c.includes("escuela") || c.includes("colegio") || c.includes("universidad")) resumen.Escuelas++;
        else if (c.includes("super") || c.includes("autoservicio") || c.includes("bodega") || c.includes("abarrotes")) resumen.Supermercados++;
        else if (c.includes("hotel") || c.includes("motel") || c.includes("hostal")) resumen.Hoteles++;
      }

      let listado = "<h3>🏬 Elementos urbanos dentro del área:</h3><ul style='list-style:none;padding:0;'>";
      for (const [cat,num] of Object.entries(resumen)) {
        listado += `<li style="margin-bottom:6px; display:flex; align-items:center;">
                      <span style="margin-right:8px;">${getIconoCategoria(cat)}</span>
                      <strong style="margin-right:6px;">${cat}:</strong> ${num}
                    </li>`;
      }
      listado += "</ul>";

      // Reemplaza #info-dinamica
      const cont = document.getElementById("info-dinamica");
      if (cont) cont.innerHTML = listado;
    });
  }

  // ========== ESTILO / LAYERS (crear HIVE primero) ==========
  function getColor(d) {
    return d > 1000000 ? '#d7191c' :
           d > 500000  ? '#fdae61' :
           d > 250000  ? '#ffffbf' :
           d > 100000  ? '#abdda4' :
                        '#2b83ba';
  }
  function style(feature) {
    return {
      fillColor: getColor(feature.properties?.POBADUL),
      weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
    };
  }

  // Crear capas HIVE (usa variables cargadas por tus js/hive_*.js)
  var hiveLayer09 = null, hiveLayer15 = null;
  try {
    hiveLayer09 = L.geoJson(hive_cdmx, { style: style, onEachFeature: onEachFeature }).addTo(map);
  } catch(e) { console.warn('hive_cdmx no disponible o error:', e); }
  try {
    hiveLayer15 = L.geoJson(hive_edomex, { style: style, onEachFeature: onEachFeature }).addTo(map);
  } catch(e) { console.warn('hive_edomex no disponible o error:', e); }


  // Leyenda y título
  var legend = L.control({position: 'bottomright'});
  legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 100000, 250000, 500000, 1000000];
    for (var i = 0; i < grades.length; i++) {
      div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                       grades[i] + (grades[i+1] ? '&ndash;' + grades[i+1] + '<br>' : '+');
    }
    return div;
  };
  legend.addTo(map);

  var title = L.control();
  title.onAdd = function(map) {
    var div = L.DomUtil.create('div', 'info');
    div.innerHTML += '<h1>Estudio de mercado</h1><h2>Análisis de entornos</h2>';
    return div;
  };
  title.addTo(map);

  // Ahora sí agregamos control de capas
  const baseLayers = { "Carto Dark": dark, "OSM": osm };
  const overlays = {};
  if (hiveLayer09) overlays["Hive CDMX"] = hiveLayer09;
  if (hiveLayer15) overlays["Hive EDOMEX"] = hiveLayer15;
  L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

  // ========== BÚSQUEDA DENUE (botón) ==========
  async function buscarDENUE() {
    markersLayer.clearLayers();
    document.getElementById("tablaResultados").innerHTML = "";

    let condi = document.getElementById('condi').value.trim();
    const lat = parseFloat(document.getElementById('lat').value.trim());
    const lon = parseFloat(document.getElementById('lon').value.trim());
    const mts = parseInt(document.getElementById('mts').value.trim());

    if (!condi || isNaN(lat) || isNaN(lon) || isNaN(mts)) {
      alert("Por favor ingresa datos válidos.");
      return;
    }

    const urlApi = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(condi)}/${lat},${lon}/${mts}/${token}`;

    try {
      const resp = await fetch(urlApi);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) { alert("No se encontraron resultados."); return; }

      let htmlDENUE = "<h3>📍 Resultados de DENUE</h3><ul style='list-style:none;padding:0;'>";
      data.forEach(item => {
        const latNum = parseFloat(item.Latitud), lonNum = parseFloat(item.Longitud);
        if (isNaN(latNum) || isNaN(lonNum)) return;

        const popupContent = `<b>${item.Nombre || ''}</b><br><small>${item.Clase_actividad || ''}</small>`;
        const icono = getBootstrapIconFromActividad(item.Clase_actividad);
        const mk = L.marker([latNum, lonNum], { icon: icono }).bindPopup(popupContent);
        markersLayer.addLayer(mk);

        const row = document.createElement("tr");
        row.innerHTML = `<td>${item.Nombre || ''}</td>
                         <td>${(item.Calle || '')} ${(item.Num_Exterior || '')}, ${(item.Colonia || '')}</td>
                         <td>${item.Telefono || ''}</td>
                         <td>${item.Estrato || ''}</td>
                         <td>${item.Clase_actividad || ''}</td>`;
        row.addEventListener("click", () => { map.setView([latNum, lonNum], 18); mk.openPopup(); });
        document.getElementById("tablaResultados").appendChild(row);

        htmlDENUE += `<li style="margin-bottom:8px;padding:6px;border-bottom:1px solid #333;">
                        <b>${item.Nombre || ''}</b><br>
                        <small>${item.Clase_actividad || ''}</small><br>
                        ${(item.Calle || '')} ${(item.Num_Exterior || '')}, ${(item.Colonia || '')}<br>
                        ${item.Telefono || ''}
                      </li>`;
      });

      htmlDENUE += "</ul>";
      mostrarEnSidebar(htmlDENUE);

      const bounds = markersLayer.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
    } catch (error) {
      console.error("Error consultando DENUE:", error);
      alert("Error al consultar la API.");
    }
  }

  document.getElementById('btnBuscar').addEventListener('click', buscarDENUE);

  // ========== TOGGLES: listado y sidebar ==========
  document.getElementById("btnToggle").addEventListener("click", function() {
    const listado = document.getElementById("listado");
    listado.classList.toggle("minimized");
    this.innerHTML = listado.classList.contains("minimized") ? '<i class="bi bi-plus"></i>' : '<i class="bi bi-dash"></i>';
  });

  document.getElementById("btnSidebarToggle").addEventListener("click", function() {
    const sidebarContent = document.getElementById("sidebar-content");
    sidebarContent.classList.toggle("minimized");
    this.innerHTML = sidebarContent.classList.contains("minimized") ? '<i class="bi bi-plus"></i>' : '<i class="bi bi-dash"></i>';
  });

  // Utilidad: getIconoCategoria (usa tu función original)
  function getIconoCategoria(cat){
    switch(cat){
      case "Bancos": return '<i class="bi bi-bank"></i>';
      case "Supermercados": return '<i class="bi bi-basket3-fill"></i>';
      case "Escuelas": return '<i class="bi bi-mortarboard-fill"></i>';
      case "Hoteles": return '<i class="bi bi-building"></i>';
      default: return '<i class="bi bi-geo-alt-fill"></i>';
    }
  }
</script>
</body>
</html>


