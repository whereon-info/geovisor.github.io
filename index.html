<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Estudio de mercado a un clic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <!--<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />-->
  <!--<script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>-->

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Hive (tu geojson) -->
  <script type="text/javascript" src="js/hive_cdmx.js"></script>
  <script type="text/javascript" src="js/hive_edomex.js"></script>

  <!-- Buscadores / plugins locales -->
  <link rel="stylesheet" href="css/leaflet-search.css">
  <link rel="stylesheet" href="css/L.Control.Locate.min.css">

  <!-- GOOGLGE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto&display=swap" rel="stylesheet">
	
	<!-- Font Awesome para que funcionen los iconos de locate y search -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

	<!-- Photon CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet.photon/leaflet.photon.css" />
	<script src="https://unpkg.com/leaflet.photon/leaflet.photon.js"></script>

	<!-- html2canvas -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	
	<!-- jsPDF -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



  <style>
    body,html { margin:0; padding:0; height:100%; display: flex; flex-direction: column;font-family: 'Poppins', sans-serif; font-size: 14px; color: #f1f1f1; }
    
	.dashboard {
	  display: grid;
	  grid-template-columns: 20% 45% 35%;
	  grid-template-rows: 5% 65% 30%;
	  grid-template-areas:
	    "title title title"
		"controls map sidebar"
	    "listado listado listado";
	  height: 100vh;
	  width: 100vw;
	  overflow: hidden; /* üëà evita desbordes */
	}

    .panel {
      border: 4px solid #00793a;
      overflow: hidden;
      padding: 10px;
    }

    #title {grid-area: title}
	#controls { grid-area: controls; }
    #map { grid-area: map; }
    #sidebar { grid-area: sidebar; overflow: auto;  }
    #listado { grid-area: listado; overflow: auto;  }
	  
	.header {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1em;
      text-align: center;
      background: #f0f0f0;
      padding: 5px;
    }


	  
    /*.leaflet-sidebar { z-index:1000; }*/
    /*.title {font family: Roboto; background-color:#15f20a}*/
    /*.legend {line-height: 18px; color: #000000;} TEXTO DE LA SIMBOLOG√çA*/
    .legend i {width: 10px;height: 10px; float: left;margin-right: 8px; opacity: 0.5;}
    /*.leaflet-sidebar-header {height: 20px;line-height: 20px; font-size: 10pt; color:#FFFFFF; background-color:#000000; margin:15px 15px 0; padding:0 20px;} SIDEBAR*/
    /*.leaflet-sidebar-content {position:absolute; top:0; bottom:0; background-color:rgba(153, 153, 153,.90); overflow-x:hidden; overflow-y:auto; color: #FFFFFF;}*/
	/*.leaflet-control-layers-expanded {background: rgba(153, 153, 153,.90); color: #999999;}*/
	/*.leaflet-control-layers label {font-family: 'Poppins', sans-serif; font-size: 14px; color: #ffffff;}*/
    .info {padding:6px 8px; font:14px/16px Poppins, Poppins, Poppins, Poppins; background: rgba(44, 44, 44, 0.8); box-shadow:0 0 15px rgba(0,0,0,0.2); border-radius:5px;}
    /*.info h2 { margin:0 0 5px; color:#00793a; } TEXTO DEL T√çTULO*/
    /*#listado-header { background-color:#00793a } LISTADO DE ESTABLECIMIENTOS*/
    /*#listado, #sidebar-content { transition: height 1.0s ease, padding 1.0s ease; }*/
    /*#listado.minimized { height: 30px; overflow: hidden; }*/
    /*#sidebar-content.minimized { height: 30px; overflow: hidden; }*/

    /*#controls { padding:10px; background:#00793a; border-bottom:3px solid #f15a29 }BARRA ARRIBA*/
    /*label { color:white; }*/

    /*table { width: 100%; border-collapse: collapse; color: #000000; background-color: #FFFFFF; } */
    /*th, td { padding: 3px; border-bottom: 1px solid #000000; } LINEA Y TABLAS*/
    /*tr:hover { background: #00ae4d; cursor: pointer; } COLOR SELECCI√ìN ELEMENTOS*/
    th { background: #00793a; position: sticky; top: 0; } /*BARRA NOMBRE DIRECCION TELEFONO ETC*/

	/* üé® Fuente uniforme en todo el mapa */
	.leaflet-control, .leaflet-popup-content {font-family: 'Poppins', sans-serif; font-size: 14px; color: #FFFFFF;}
	
	/* üóÇ Control de capas */
	.leaflet-control-layers {background: rgba(44, 44, 44, 0.8);border-radius: 8px;padding: 6px;color: #ffffff;font-family: 'Poppins', sans-serif;}
	/*.leaflet-sidebar-header {background: rgba(44, 44, 44, 0.8);border-radius: 3px;padding: 4px;color: #ffffff;font-family: 'Poppins', sans-serif;}*/
	/*.leaflet-sidebar-tabs>li.active, .leaflet-sidebar-tabs>ul>li.active {color: #FFFFFF; background-color: #2c2c2c;*/
	.leaflet-control-layers label { color: #FFFFFF; font-weight: 500; cursor: pointer;}
	.leaflet-popup-content-wrapper {background: rgba(44, 44, 44, 0.8); color: #333; box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);}
	.leaflet-control-search {padding: 0.1px 0.1px;}
	.leaflet-control-search a {padding: 0.1px 0.1px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #FFFFFF;}
	.leaflet-control-search a:hover {color: #b81cb0;}
  	
	/* üìë Sidebar y tabla de resultados */
	#title {background: #00793a; color: #FFFFFF; flex: 0 0 auto; font-family: 'Poppins', sans-serif; line-height: 0.5;}  
	#controls {background: #2c2c2c; color: #FFFFFF; flex: 0 0 auto; font-family: 'Poppins', sans-serif;font-size: 14px; line-height: 2.0;}
	#listado {background: #2c2c2c; color: #FFFFFF;font-family: 'Poppins', sans-serif;font-size: 12px; line-height: 1.5;}
	#sidebar {grid-area: sidebar; background: #2c2c2c;color: #FFFFFF;font-family: 'Poppins', sans-serif;font-size: 14px; line-height: 1.0;}  
	 table { width: 100%;} 
	#sidebar h3, #listado h3 { font-weight: 150; font-size: 12px; margin-bottom: 8px;}
	#gcd-button-control {  display: flex;  align-items: center;  justify-content: center;  font-size: 8px;   /* tama√±o del emoji */  width: 12px;  height: 28px;   border-radius: 2px;  cursor: pointer;}
	#gcd-button-control:hover {  background: #f0f0f0;}
	#info-dinamica {font-size: 12px;line-height: 2.0;}  

	#resultadosBusqueda .resultado-personalizado {  display: flex;  align-items: center;  margin: 4px 0;  padding: 4px 6px;  background: rgba(200,230,255,0.5);  border-radius: 6px;}
	#resultadosBusqueda .icono {  font-size: 18px;  margin-right: 6px;}
	#resultadosBusqueda .nombre {  flex: 1;  font-weight: bold;  text-transform: capitalize;}
	#resultadosBusqueda .conteo {  color: #333;}

	.leaflet-marker-icon {width: 50px; height: 50px;}
	.custom-pin {  font-size: 22px;  text-align: center;  line-height: 22px;}

	#welcomeBox {  position: absolute;  top: 160px;  left: 50%;  transform: translateX(-50%);  background: #00793a;  padding: 15px 20px;  border-radius: 12px;  box-shadow: 0px 8px 10px rgba(0,0,0,0.8);
  	z-index: 1000;  max-width: 800px; font-family: 'Poppins', sans-serif; font-size: 12px;}
	#welcomeContent {  position: relative;}
	#closeWelcome {  position: absolute;  top: 5px;  right: 10px;  cursor: pointer;  font-size: 18px;  color: #333;}

 
  </style>
</head>
<body>

<div class="dashboard">

	<div id="title">
	 	  	<h3> Estudio sobre la viabilidad comercial en M√©xico </h3>
	</div>
	
<div id="controls" class="panel">
  <label>Establecimiento:</label>
  <input type="text" id="condi" value="pizzerias" />
  <label>Latitud:</label>
  <input type="text" id="lat" value="19.432650801677962" />
  <label>Longitud:</label>
  <input type="text" id="lon" value="-99.13316794583835" />
  <label>Metros:</label>
  <input type="number" id="mts" value="1000" />
  <button id="btnBuscar">Buscar</button>
  <button id="btnExportar">Exportar a PDF</button>
</div>

<!--<div id="mapa-contenedor" style="display:flex; height:100vh; width:100%;">-->	
<div id="map" class="panel"></div>

<!-- SIDEBAR -->
<div id="sidebar" class="panel">
   <h3 class="leaflet-sidebar-header" style="margin:0.5;">üìä Ficha de informaci√≥n urbana</h3>
    <div id="sidebar-content">H√°ga clic en una zona para conocer su informaci√≥n</div>
	<h3>B√∫squedas personalizadas</h3>
  <div id="resultadosBusqueda"> <!-- Aqu√≠ se mostrar√°n las b√∫squedas con .buscarDENUE --></div>
</div>

	
<!-- LISTADO -->
<div id="listado" class="panel">
  <div id="listado-header" style="display:flex;justify-content:space-between;align-items:center;">
    <h3>üìç Establecimientos econ√≥micos dentro de la zona de estudio</h3>
  </div>
  <table>
    <thead>
      <tr>
        <th>Nombre</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Personal ocupado</th><th>Clase</th>
      </tr>
    </thead>
    <tbody id="tablaResultados"></tbody>
  </table>
</div>
</div>

	<div id="welcomeBox">
 		<div id="welcomeContent">
   	 <span id="closeWelcome">&times;</span>
    	<h2>üëã Bienvenido</h2>
   	 <p>A este webmap donde podr√° encontrar informaci√≥n sociodemogr√°fica, econ√≥mica y urbana de las manchas urbanas de ciudades de M√©xico.<br></p>
		<p>Conozca la situaci√≥n social, el status econ√≥mico, el potencial comercial, la competencia que tendr√° su negocio, los elementos urbanos atractores de clientes potenciales, el perfil de los habitantes 
		de la zona donde se encontrar√° su emprendimiento, franquicia y/o sucursal.</p>
		<p>Busque en el recuadro superior el giro de su inter√©s.</p>	
		<p> Y/o de clic sobre los hex√°gonos para conocer la informaci√≥n sobre un municipio, zona, lugar o donde se encuentra usted.</p> 
		<p>Renuncia de responsabilidad: Toda la informaci√≥n geoestad√≠stica aqu√≠ presentada es elaborada y por consiguiente propiedad de los institutos, organismos, asociaciones y/o secretar√≠as respectivamente. Whereon procesa y presenta estos los datos.</p>  
 	 </div>
	</div>

<!-- plugins local JS -->
<script src="js/L.Control.Locate.min.js"></script>

<script>
  // ========== MAPA + CAPAS ==========
  const map = L.map('map').setView([22.5, -100.5], 5);

			// üåç Mapa claro (OSM est√°ndar)
			const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			});
			
			// üåÉ Mapa oscuro (Carto Dark)
			const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>'
			});
			
			// ‚òÄÔ∏è Carto Light
			const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>'
			});
			
			// üõ∞Ô∏è Esri Sat√©lite
			const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
			});
			

			// üëÄ Agregar el mapa base por defecto (ejemplo: OSM claro)
			osm.addTo(map);
	

		// ================== Cerrar con la X ====================
		document.getElementById("closeWelcome").addEventListener("click", () => {
		  document.getElementById("welcomeBox").style.display = "none";
		});
		
		// Cerrar haciendo clic en el mapa
		map.on("click", () => {
		  document.getElementById("welcomeBox").style.display = "none";
		});

	
  // ========== VARIABLES COMPARTIDAS (evita ReferenceError) ==========
  var x = null;            // geojson temporal usado por photon
  var marker = null;       // marcador temporal usado por photon
  var last = null;

  // ========== CONTROLES (locate) ======================
	  L.control.locate({ locateOptions: { maxZoom: 15 } }).addTo(map);
	  var draggableMarker;
		map.on("locationfound", function (e) {
	  if (draggableMarker) {
	    draggableMarker.setLatLng(e.latlng);
	  } else {
	    draggableMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
	
	    // Cuando se arrastra, actualizamos inputs
	    draggableMarker.on("dragend", function (ev) {
	      var pos = ev.target.getLatLng();
	      document.getElementById("lat").value = pos.lat.toFixed(6);
	      document.getElementById("lon").value = pos.lng.toFixed(6);
	    });
	  }
	
	  // Guardar coordenadas iniciales en los inputs
	  document.getElementById("lat").value = e.latlng.lat.toFixed(6);
	  document.getElementById("lon").value = e.latlng.lng.toFixed(6);
	  map.setView(e.latlng, 15);
	});
	
	// Si falla la localizaci√≥n
	map.on("locationerror", function () {
	  alert("No se pudo obtener tu ubicaci√≥n");
	});

	// ========== CAPAS ==========



  // ========== SIDEBAR ==========


  // ======================= DENUE =============================================
 //const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";

// üîπ Funci√≥n auxiliar para asignar √≠conos seg√∫n la actividad
function getBootstrapIconFromActividad(actividad) {
  if (!actividad) return L.divIcon({ className: "custom-pin", html: "üìç" });

  actividad = actividad.toLowerCase();
  if (actividad.includes("pizza") || actividad.includes("pizzer√≠a")) {
    return L.divIcon({ className: "custom-pin", html: "üçï" });
  } else if (actividad.includes("escuela") || actividad.includes("colegio") || actividad.includes("universidad")) {
    return L.divIcon({ className: "custom-pin", html: "üè´" });
  } else if (actividad.includes("banco")|| actividad.includes("banca multiple")) {
    return L.divIcon({ className: "custom-pin", html: "üè¶" });
  } else if (actividad.includes("hotel") || actividad.includes("motel") || actividad.includes("hostal")) {
    return L.divIcon({ className: "custom-pin", html: "üè®" });
  } else if (actividad.includes("super") || actividad.includes("bodega") || actividad.includes("tienda") || actividad.includes("abarrotes")) {
    return L.divIcon({ className: "custom-pin", html: "üõí" });
  }

  // valor por defecto
  return L.divIcon({ className: "custom-pin", html: "üìç" });
}

// üîπ Funci√≥n principal para buscar en DENUE
async function buscarDENUE(condi, lat, lon, mts) {
  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e"; // tu token DENUE
  const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(condi)}/${lat},${lon}/${mts}/${token}`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const resultados = await response.json();

    // üìç Limpiar tabla y pines anteriores
    document.getElementById("tablaResultados").innerHTML = "";
    if (window.denueLayer) {
      map.removeLayer(window.denueLayer);
    }
    window.denueLayer = L.layerGroup().addTo(map);

    // üìä Procesar resultados
    resultados.forEach(item => {
      // --- Agregar fila en la tabla ---
      const row = `
        <tr>
          <td>${item.Nombre || "Sin nombre"}</td>
          <td>${item.Calle || ""} ${item.Num_Exterior || ""}, ${item.Colonia || ""}, ${item.Municipio || ""}</td>
          <td>${item.Telefono || "N/D"}</td>
          <td>${item.Estrato || "N/D"}</td>
          <td>${item.Clase_actividad || "N/D"}</td>
        </tr>
      `;
      document.getElementById("tablaResultados").insertAdjacentHTML("beforeend", row);

      // --- Agregar marcador en el mapa ---
      const marker = L.marker([item.Latitud, item.Longitud], {
        icon: getBootstrapIconFromActividad(item.Clase_actividad)
      }).bindPopup(`<b>${item.Nombre}</b><br>${item.Clase_actividad}<br>${item.Calle || ""}, ${item.Colonia || ""}`);
      marker.addTo(window.denueLayer);
    });

    // üìå Mostrar en el sidebar un resumen
    mostrarResultadosBusqueda(condi, resultados.length);

  } catch (error) {
    console.error("Error en buscarDENUE:", error);
    alert("‚ùå No se pudieron obtener resultados del DENUE.");
  }
}


	
	
  // ========== FUNCIONES DE HEX√ÅGONOS ==========
		function mostrarEnSidebar(html) {
		  const cont = document.getElementById("sidebar-content");
		  if (cont) cont.innerHTML = html;
		}

function onEachFeature(feature, layer) {
  layer.on("click", async () => {
    const props = feature.properties || {};

    const htmlFija = `
      <div id="info-fija">
        <h2>${props.nomgeo || 'Zona'}</h2>
        <b>Tipo:</b> ${props.TIPO || 'N/A'}<br>
        <p><b>Poblaci√≥n municipal total:</b> ${props.pobtot?.toLocaleString() || 0}</p>
        <p><b>Poblaci√≥n adulta municipal:</b> ${props.POBADUL?.toLocaleString() || 0}</p>
        <p><b>√çndice de Rezago:</b> ${props.REZAGO || 'N/A'}</p><hr>
        <p><b>Extorsi√≥n:</b> ${props["extorsi√≥n"] || 0}</p>
        <p><b>Narcomenudeo:</b> ${props.narcomenud || 0}</p>
        <p><b>Robo a negocio:</b> ${props["robo a neg"] || 0}</p><hr>
        <p><b>Cr√©ditos personales:</b> ${props.CRED_PERS?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos n√≥mina:</b> ${props.CRED_NOMI?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos hipotecarios:</b> ${props.CRED_HIPOT?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos automotrices:</b> ${props.CRED_AUTOM?.toLocaleString() || 0}</p><hr>
      </div>
      <div id="info-dinamica">Cargando...</div>
    `;

    mostrarEnSidebar(htmlFija);

    // üëá Aqu√≠ s√≠ puedes usar await porque est√°s dentro de async
    const bounds = layer.getBounds();
    const resultados = await buscarEnHexagono(bounds, ["banco","super","escuela","hotel"]);

    // Resumen de resultados
    const resumen = { Bancos:0, Supermercados:0, Escuelas:0, Hoteles:0 };
    const extras = {};

    resultados.forEach(item => {
      const c = (item.Clase_actividad || "").toLowerCase();
      if (c.includes("banco")) resumen.Bancos++;
      else if (c.includes("escuela") || c.includes("colegio") || c.includes("universidad")) resumen.Escuelas++;
      else if (c.includes("super") || c.includes("bodega") || c.includes("abarrotes")) resumen.Supermercados++;
      else if (c.includes("hotel") || c.includes("motel") || c.includes("hostal")) resumen.Hoteles++;
      else {
        const nombre = item.Clase_actividad.trim();
        extras[nombre] = (extras[nombre] || 0) + 1;
      }
    });

    let listado = "<h2>üè¨ Elementos urbanos dentro del √°rea:</h2><ul>";
    for (const [cat, num] of Object.entries(resumen)) {
      listado += `<li>${getEmojiCategoria(cat)} <strong>${cat}:</strong> ${num}</li>`;
    }
    listado += "</ul>";

    if (Object.keys(extras).length > 0) {
      listado += "<h2>üîç Otros establecimientos:</h2><ul>";
      for (const [cat, num] of Object.entries(extras)) {
        listado += `<li>üìç <strong>${cat}:</strong> ${num}</li>`;
      }
      listado += "</ul>";
    }

    document.getElementById("info-dinamica").innerHTML = listado;
  });
}



      
      function getEmojiCategoria(cat) {
          const emojis = {
            "Bancos": "üè¶",
            "Supermercados": "üõí",
            "Escuelas": "üè´",
            "Hoteles": "üè®"
          };
          return emojis[cat] || "üìç";
        }

      // Reemplaza #info-dinamica
      const cont = document.getElementById("info-dinamica");
      if (cont) cont.innerHTML = listado;

	
  
  //======================= LOGO ================================
	var logoControl = L.control({ position: "bottomleft" });

logoControl.onAdd = function (map) {
    var div = L.DomUtil.create("div", "logo-leaflet");
    div.innerHTML = '<img src="images/WhereOn-Logo-Color-Vrt.png" style="width:80px; opacity:0.9;">';
    return div;
};

logoControl.addTo(map);
  
  // ========== ESTILO / LAYERS (crear HIVE primero) ==========
  function getColor(d) {
    return d > 1000 ? '#d7191c' :
           d > 500  ? '#fdae61' :
           d > 250  ? '#ffffbf' :
           d > 100  ? '#abdda4' :
                      '#2b83ba';
  }
  function style(feature) {
    return {
      fillColor: getColor(feature.properties?.["robo a neg"]),
      weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
    };
  }

  // Crear capas HIVE
  var hiveLayer09 = null, hiveLayer15 = null;
  try {
    hiveLayer09 = L.geoJson(hive_cdmx, { style: style, onEachFeature: onEachFeature }).addTo(map);
  } catch(e) { console.warn('hive_cdmx no disponible o error:', e); }
  try {
    hiveLayer15 = L.geoJson(hive_edomex, { style: style, onEachFeature: onEachFeature }).addTo(map);
  } catch(e) { console.warn('hive_edomex no disponible o error:', e); }



  // Leyenda
  var legend = L.control({position: 'bottomright'});
  legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 100, 250, 500, 1000];
    for (var i = 0; i < grades.length; i++) {
      div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                       grades[i] + (grades[i+1] ? '&ndash;' + grades[i+1] + '<br>' : '+');
    }
    return div;
  };
  legend.addTo(map);


  // üéõÔ∏è Ahora s√≠ agregamos control de capas
		var baseMaps = {
          "Claro": osm,
          "Oscuro": dark,
          "Light": light,
          "Sat√©lite": esriSat
        };
        
        // Declare and initialize myMarker before using it
        var myMarker = L.marker([51.5, -0.09]).addTo(map); // Example initialization
        var myMarker1 = L.marker([51.5, -0.1]).addTo(map); // Example initialization for myMarker1
        
        var overlays = {
          "Casa": myMarker,
          "Otro": myMarker1
        };
        if (hiveLayer09) overlays["Hive CDMX"] = hiveLayer09;
        if (hiveLayer15) overlays["Hive EDOMEX"] = hiveLayer15;
        
        L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);




	
// ============================== RESUMEN DENUE ======================================

document.getElementById('btnBuscar').addEventListener('click', () => {
  const condi = document.getElementById("condi").value;
  const lat = document.getElementById("lat").value;
  const lon = document.getElementById("lon").value;
  const mts = document.getElementById("mts").value;

  buscarDENUE(condi, lat, lon, mts);
});


// ================= FUNCION buscarEnHexagono ===================
	async function buscarEnHexagono(bounds, categorias) {
	  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";
	
	  // üëâ Tomamos el centro del hex√°gono
	  const center = bounds.getCenter();
	
	  // üëâ Aproximamos un radio en metros (diagonal menor del bounding box)
	  const latDiff = bounds.getNorth() - bounds.getSouth();
	  const lonDiff = bounds.getEast() - bounds.getWest();
	  const approxKm = Math.max(latDiff, lonDiff) * 111; // 1¬∞ ‚âà 111 km
	  const radius = Math.round(approxKm * 1000 / 2); // en metros
	
	  let resultados = [];
	
	  for (const cat of categorias) {
	    const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${center.lat},${center.lng}/${radius}/${token}`;

	    try {
	      const resp = await fetch(url);
	      if (resp.ok) {
	        const data = await resp.json();
	        if (Array.isArray(data)) resultados = resultados.concat(data);
	      }
	    } catch (e) {
	      console.error("Error consultando categor√≠a", cat, e);
	    }
	  }
	
	  return resultados;
	}


  // Utilidad: getIconoCategoria (usa tu funci√≥n original)
  function getIconoCategoria(cat){
    switch(cat){
      case "Bancos": return '<i class="bi bi-bank"></i>';
      case "Supermercados": return '<i class="bi bi-basket3-fill"></i>';
      case "Escuelas": return '<i class="bi bi-mortarboard-fill"></i>';
      case "Hoteles": return '<i class="bi bi-building"></i>';
      default: return '<i class="bi bi-geo-alt-fill"></i>';
    }
  }

function mostrarResultadosBusqueda(condi, total) {
  const cont = document.getElementById("resultadosBusqueda");
  cont.innerHTML = `
    <div class="resultado-personalizado">
      <span class="icono">üìä</span>
      <span class="nombre">${condi}</span>
      <span class="conteo">(${total} encontrados)</span>
    </div>
  `;
}



	
	// ========== PLUGIN PHOTON ==========
const url = {"Nominatim": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&", "BAN": "https://api-adresse.data.gouv.fr/search/?"}	
 var photonControl;
if (L.control.photon) {
  photonControl = L.control.photon({
    url: url["Nominatim"],
    position: 'topleft',
    includePosition: true,
    placeholder: "Buscar direcci√≥n...",
    initial: true
  }).addTo(map);

  // Manejar selecci√≥n de Photon
  photonControl.on('selected', function(e) {
    try {
      if (x) { map.removeLayer(x); x = null; }
      if (marker) { map.removeLayer(marker); marker = null; }

      // Dibujar geometr√≠a si viene en respuesta
      x = L.geoJSON(e.choice).addTo(map);
      const ll = x.getLayers()[0].getLatLng();
      marker = L.marker(ll).addTo(map);
      map.setView(ll, 17);

      // Texto en input
      const label = (e.choice.properties && (e.choice.properties.label || e.choice.properties.display_name)) || '';
      if (e.target && e.target.input) e.target.input.value = label;

      // Si quieres guardar coordenadas en inputs lat/lon
      if (document.getElementById("lat")) document.getElementById("lat").value = ll.lat;
      if (document.getElementById("lon")) document.getElementById("lon").value = ll.lng;
    } catch (err) {
      console.error('Error en selecci√≥n Photon:', err);
    }
  });

  // --- Ajustes visuales del control Photon ---
  const search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
  if (search) {
    search.classList.add("leaflet-control-search");
    search.style.display = "flex";
    search.style.alignItems = "center";
    search.style.backgroundColor = "rgba(255,255,255,0.9)";
    search.style.padding = "2px 6px";
    search.style.borderRadius = "6px";
    search.style.fontFamily = "Poppins, Arial, sans-serif";
    search.style.fontSize = "14px";

    // Bot√≥n üîç centrado
    var button = document.createElement("div");
    button.id = "gcd-button-control";
    button.innerHTML = "üîç"; 
    button.style.fontSize = "18px";
    button.style.cursor = "pointer";
    button.style.marginRight = "6px";
    search.insertBefore(button, search.firstChild);

    // Input visible/invisible al dar clic en üîç
    let last = search.lastChild;
    if (last) last.style.display = "none";
    button.addEventListener("click", function () {
      if (!last) return;
      last.style.display = (last.style.display === "none") ? "block" : "none";
    });
  }
} else {
  console.warn("L.control.photon no est√° disponible (¬øfalta cargar leaflet.photon.js?)");
}



// ============== BOTON PDF ===================================
	
  //document.getElementById("btnExportar").addEventListener("click", function () {
    //const contenedor = document.getElementById("mapa-contenedor");

   // html2canvas(contenedor, {
     // useCORS: true, // para tiles externos
      //scale: 2       // mejor calidad
    //}).then(canvas => {
      //const imgData = canvas.toDataURL("image/png");
      //const { jsPDF } = window.jspdf;
      //const pdf = new jsPDF("landscape", "mm", "a4");

      //const pageWidth = pdf.internal.pageSize.getWidth();
      //const pageHeight = pdf.internal.pageSize.getHeight();

      //const imgWidth = pageWidth;
      //const imgHeight = canvas.height * pageWidth / canvas.width;

      //pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
      //pdf.save("mapa_resultados.pdf");
    //});
  //});



	
</script>
</body>
</html>






















