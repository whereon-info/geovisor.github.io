
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Viabilidad comercial en M√©xico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <!--<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />-->
  <!--<script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>-->

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Hive (tu geojson) -->
  <script type="text/javascript" src="js/hive_ags.js"></script>
  <script type="text/javascript" src="js/hive_hgo.js"></script>
  <script type="text/javascript" src="js/hive_qro.js"></script>	
  <script type="text/javascript" src="js/hive_cdmx.js"></script>
  <script type="text/javascript" src="js/hive_edomex.js"></script>
  <script type="text/javascript" src="js/hive_gto.js"></script>
  <script type="text/javascript" src="js/hive_nay.js"></script>
  <script type="text/javascript" src="js/hive_mor.js"></script>
  <script type="text/javascript" src="js/hive_pue.js"></script>
  <script type="text/javascript" src="js/hive_tlax.js"></script>
  <script type="text/javascript" src="js/hive_slp.js"></script>	
  	

   <!-- NSE -->
  <script type="text/javascript" src="js/nse_ags.js"></script>	
  <script type="text/javascript" src="js/nse_cdmx.js"></script>


  <!-- Buscadores / plugins locales -->
  <link rel="stylesheet" href="css/leaflet-search.css">
  <link rel="stylesheet" href="css/L.Control.Locate.min.css">

  <!-- GOOGLGE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto&display=swap" rel="stylesheet">
	
	<!-- Font Awesome para que funcionen los iconos de locate y search -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

	<!-- Photon CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet.photon/leaflet.photon.css" />
	<script src="https://unpkg.com/leaflet.photon/leaflet.photon.js"></script>

	<!-- html2canvas -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	
	<!-- jsPDF -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

	<!-- Chart -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<!-- SPLIT -->
	<script src="https://unpkg.com/split.js/dist/split.min.js"></script>


  <style>

  /* ====================== FUENTES ======================*/
	/*		@font-face {
			  font-family: 'MetalOnMetal';
			  src: url('../fonts/MetalOnMetal-OBo.ttf') format('truetype');
			  font-weight: normal;
			  font-style: normal;
			}*/
			
			/* ====================== ESTRUCTURA BASE ====================== */
			html, body {
			  margin: 0;
			  padding: 0;
			  width: 100%;
			  overflow: hidden;
			  display: flex;
			  flex-direction: column;
			  background: #1f1f1f;
			  font-family: 'Poppins', sans-serif;
			  font-size: 14px;
			  color: #f1f1f1;
			}
			
			/* contenedor principal dividido en secciones */
			#main-split {
			  display: flex;
			  flex-direction: column;
			  height: 100vh;
			  width: 100%;
			}
			
			/* fila superior con los paneles horizontales */
			#top-row {
			  display: flex;
			  overflow: hidden;
			   flex: 1 1 auto;
 				 min-width: 0;  
 				 min-height: 0;
			}
			
			/* contenedor de urbano + scatter */
			#otro {
			  display: flex;
			  flex-direction: column;
			}
			
			/* ====================== MAPA ====================== */
			#map {
			  flex: 1 1 auto;
			  min-height: 0;
			  height: 100%;
			  width: 100%;
			  background: #333;
			  overflow: hidden !important;
			}

			
			/* ====================== PANEL BASE ====================== */
			.panel {
			  padding: 8px;
			  box-sizing: border-box;
			  background: #2c2c2c;
			  color: #fff;
			  overflow: auto;
			}
			
			/* ====================== GUTTERS (Split.js) ====================== */
			.gutter {
			  background-color: #00793a;
			  transition: background-color 0.2s ease;
			}
			.gutter.gutter-horizontal {
			  z-index: 1000;
			  cursor: col-resize;
			}
			.gutter.gutter-vertical {
			  cursor: row-resize;
			}
			.gutter:hover {
			  background-color: #00b050;
			}
			
			/* ====================== ENCABEZADOS ====================== */
			#title {
			  background: #00793a;
			  color: #ffffff;
			  font-family: 'Poppins', Roboto;
			  text-align: center;
			  padding: 2px;
			  letter-spacing: 1px;
			}
			
			.header {
			  font-weight: bold;
			  margin-bottom: 10px;
			  font-size: 1.1em;
			  text-align: center;
			  background: #f0f0f0;
			  padding: 5px;
			  color: #000;
			}
			
			/* ====================== PANEL ESPEC√çFICOS ====================== */
			
			#listado {
			  background: #2c2c2c;
			  color: #ffffff;
			  font-size: 12px;
			  line-height: 1.5;
			  overflow-y: auto;
  			  overflow-x: hidden;
			}
			
			#controls,
			#map,
			#chart,
			#otro,
			#sidebar,
			#telara√±a {
			  background: #2c2c2c;
			  color: #ffffff;
			  font-size: 13px;
			  line-height: 1.5;
			  min-height: 0;
			  overflow: auto;
			}

			#radarEvaluacion {
			  flex: 1;
			  width: 100% !important;
			  height: 100% !important;
			}

			 #urbano iframe {
			  border-radius: 10px;
			  background: #fff;
			}

			
			/* ====================== TABLAS ====================== */
			table {
			  width: 100%;
			  border-collapse: collapse;
			}
			th {
			  background: #00793a;
			  position: sticky;
			  top: 0;
			  padding: 6px;
			}
			td {
			  padding: 4px 6px;
			}
			tr:hover {
			  background: rgba(0, 174, 77, 0.3);
			}
			
			/* ====================== LEAFLET ====================== */
			.leaflet-control,
			.leaflet-popup-content {
			  font-family: 'Poppins', sans-serif;
			  font-size: 13px;
			  color: #ffffff;
			}
			
			.leaflet-control-layers {
			  background: rgba(44, 44, 44, 0.8);
			  border-radius: 8px;
			  padding: 6px;
			  color: #ffffff;
			}
			.leaflet-control-layers label {
			  color: #ffffff;
			  font-weight: 500;
			  cursor: pointer;
			}
			
			.leaflet-popup-content-wrapper {
			  background: rgba(44, 44, 44, 0.85);
			  color: #fff;
			  box-shadow: 0 3px 14px rgba(0, 0, 0, 0.5);
			}
			
			.legend {
			  line-height: 18px;
			  color: #fff;
			  background: rgba(44, 44, 44, 0.8);
			  border-radius: 5px;
			  padding: 6px;
			  font-size: 12px;
			}
			.legend i {
			  width: 10px;
			  height: 10px;
			  float: left;
			  margin-right: 6px;
			  opacity: 0.8;
			}
			
			/* ====================== WELCOME BOX ====================== */
			#welcomeBox {
			  position: absolute;
			  top: 25%;
			  left: 50%;
			  transform: translateX(-50%);
			  background: #00793a;
			  padding: 20px;
			  border-radius: 12px;
			  box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.8);
			  z-index: 1000;
			  max-width: 800px;
			  font-family: 'Poppins', sans-serif;
			  font-size: 14px;
			  color: #fff;
			  line-height: 1.5;
			}
			#welcomeContent {
			  position: relative;
			}
			#closeWelcome {
			  position: absolute;
			  top: 5px;
			  right: 10px;
			  cursor: pointer;
			  font-size: 18px;
			  color: #fff;
			}
			
			/* ====================== RESULTADOS ====================== */
			#resultadosBusqueda .resultado-personalizado {
			  display: flex;
			  align-items: center;
			  margin: 4px 0;
			  padding: 6px 8px;
			  background: rgba(200, 230, 255, 0.2);
			  border-radius: 6px;
			}
			#resultadosBusqueda .icono {
			  font-size: 18px;
			  margin-right: 6px;
			}
			#resultadosBusqueda .nombre {
			  flex: 1;
			  font-weight: bold;
			  text-transform: capitalize;
			}
			#resultadosBusqueda .conteo {
			  color: #ccc;
			}
			
			/* ====================== ICONOS Y MARCADORES ====================== */
			.leaflet-marker-icon {
			  width: 50px;
			  height: 50px;
			}
			.custom-pin {
			  font-size: 22px;
			  text-align: center;
			  line-height: 22px;
			}
			
			/* ====================== UBICACI√ìN ====================== */
			#ubica {
			  position: absolute;
			  top: 14%;
			  left: 33%;
			  transform: translateX(-50%);
			  background: #2c2c2c;
			  padding: 6px 10px;
			  border-radius: 8px;
			  box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.8);
			  z-index: 1000;
			  font-size: 11px;
			}
			
			/* ====================== GRAFICAS ====================== */
			#chart {
			  display: flex;
			  flex-direction: column;
			  align-items: stretch;
			  pointer-events: none;
			}
			#myChart, #scatterChart {
			  width: 100%;
			  height: 100%;
			}
			
			/* ====================== PEQUE√ëOS DETALLES ====================== */
			button {
			  background: #00793a;
			  border: none;
			  color: #fff;
			  padding: 6px 10px;
			  border-radius: 6px;
			  cursor: pointer;
			  font-family: 'Poppins', sans-serif;
			}
			button:hover {
			  background: #00b050;
			}
			
			label {
			  color: #fff;
			  font-weight: 500;
			}
			
			hr {
			  border: 1px solid #00793a;
			  margin: 8px 0;
			}

			#gaugeChart {
			  width: 100%;
			  height: 100%;
			  display: block;
			}
			
			#urbano {
			  padding: 5px;
			  display: flex;
			  flex-direction: column;
			}
			
			#urbano canvas {
			  flex: 1;
			  min-height: 200px;
			}


 
  </style>
</head>
<body>
<div id="main-split">
	<div id="title">	<h1> üåé GeoViable - Plataforma para el an√°lisis de la viabilidad comercial en M√©xico</h1>	</div>

	<div id="top-row">
		<div id="controls" class="panel">
		  <p><label> 1Ô∏è‚É£ Establecimiento:</label>
		  <input type="text" id="condi" value="taqueria" /></p>
		  <p><label>Latitud:   </label>
		  <input type="text" id="lat" value="19.432650801677962" /></p>
		  <label>Longitud:</label>
		  <input type="text" id="lon" value="-99.13316794583835" />
		  <p><label>Radio (mts):</label>
		  <input type="number" id="mts" value="1000" /></p>
		  <button id="btnBuscar">Buscar</button>
			<hr>
			<label for="filtroEstado">2Ô∏è‚É£ Entidad:</label>
			<select id="filtroEstado">
			  <option value="todos">Todos</option>
				<option value="AGS">Aguascalientes</option>
				<option value="BC">Baja California</option>
				<option value="BCS">Baja California Sur</option>
				<option value="CAM">Campeche</option>
				<option value="COA">Coahuila</option>
				<option value="COL">Colima</option>
				<option value="CHP">Chiapas</option>
				<option value="CHIH">Chiahuahua</option>
				<option value="CDMX">Ciudad de M√©xico</option>
				<option value="DGO">Durango</option>
		        <option value="GTO">Guanajuato</option>
				<option value="GRO">Guerrero</option>
			    <option value="HGO">Hidalgo</option>
				<option value="JAL">Jalisco</option>
				<option value="MEX">Estado de M√©xico</option>
				<option value="MIC">Michoac√°n</option>
				<option value="MOR">Morelos</option>
				<option value="NAY">Nayarit</option>
				<option value="NL">NuevoLe√≥n</option>
				<option value="OAX">Oaxaca</option>
				<option value="PUE">Puebla</option>
			    <option value="QRO">Quer√©taro</option>
			    <option value="QROO">Quintana Roo</option>
				<option value="SLP">San Luis Potos√≠</option>
				<option value="SIN">Sinaloa</option>
				<option value="SON">Sonora</option>
				<option value="TAB">Tabasco</option>
		        <option value="TAM">Tamaulipas</option>
				<option value="TLX">Tlaxcala</option>
				<option value="VER">Veracruz</option>
				<option value="YUC">Yucac√°n</option>
				<option value="ZAC">Zacatecas</option>	  
			</select>
				<hr>
				<p><label>3Ô∏è‚É£ Busque un lugar:</label>
				<div id="photon-container"></div></p>
			    <hr>
				<label>4Ô∏è‚É£ </label>
				<button id="Ubicacion">Buscar por ubicaci√≥n</button>
				<hr>
				<button id="btnExportar">Exportar a PDF</button>
			    <hr>
			</div>
		
		<div id="map" class="panel"></div>
	

<!-- ================== CHART PANEL ================== -->
		<div id="chart" class="panel">
		  <h3>üìä ¬øA qui√©n le vas a vender?</h3>
		  <div id="info-content"></div>
		  <canvas id="myChart"></canvas>	
		</div>
		
<!-- ================== URBANO PANEL ================== -->
	<div id="otro" class="panel">
		<div id="urbano" class="panel">
			<h3>üíµ Confianza del consumidor</h3>
			<h4 style="font-size:10px;text-align: center;margin: 2px;color:#ffffff;">Comparando la SITUACI√ìN ECON√ìMICA ACTUAL con la de HACE UN A√ëO, ¬øC√≥mo considera en el MOMENTO ACTUAL las 
				posibilidades de que usted o alguno de los integrantes de este hogar realice compras tales como muebles, televisor, lavadora, otros aparatos...?</h4>
			<h1 style="font-size:56px;text-align: center;margin: 2px;">30.2%</h1>
			<h4 style="font-size:12px;text-align: center;margin: 2px;color:#8b8b8b;">‚¨áÔ∏è 0.6% con respecto al a√±o anterior</h4>
			 <iframe
			    id="frmIE"
			    src="https://www.inegi.org.mx/app/widgetgenerico/widget.html?IdSeries=,454168|0-0|3"
			    width="100%"
			    height="560"
			    scrolling="no"
			    frameborder="0"
			    style="border:none;"
			  ></iframe>
		</div>

		<div id="scatter" class="panel">
		  <h3>üìâ ¬øComo est√° la situaci√≥n social?</h3>
		  <canvas id="scatterChart"></canvas>
		</div>
	</div>
		
	<!-- SIDEBAR -->
			
	<div id="sidebar" class="panel">
		   <h3>üìë Ficha de informaci√≥n municipal</h3>
		    <div id="sidebar-content">H√°ga clic en una zona para conocer su informaci√≥n</div>
			<div id="resultadosBusqueda"></div>
		</div>
	

			<div id="telara√±a" class="panel">
			  <h3>üíØ Evaluaci√≥n general de la plaza</h3>
			
			  <!-- Scores num√©ricos -->
			  <div id="scores-plaza"></div>
			
			  <!-- Gr√°fica radar -->
			  <div style="width:100%; height:100%;">
			    <canvas id="radarEvaluacion"></canvas>
			  </div>
			</div>

</div>

	

<!-- LISTADO -->
<div id="listado" class="panel">
  <div id="listado-header" style="display:flex;justify-content:space-between;align-items:center;">
    <h3>üìç ¬øQui√©n es tu competencia?</h3>
  </div>
  <table>
    <thead>
      <tr>
        <th>Nombre</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Personal ocupado</th><th>Clase</th>
      </tr>
    </thead>
    <tbody id="tablaResultados"></tbody>
  </table>
</div>

</div>


	<div id="welcomeBox">
 		<div id="welcomeContent">
   	 <span id="closeWelcome">&times;</span>
    	<h2>üëã Bienvenido</h2>
   	 <p>A este webmap donde podr√° encontrar informaci√≥n sociodemogr√°fica, econ√≥mica y urbana de las manchas urbanas de ciudades de M√©xico.<br></p>
		<p>Conozca la situaci√≥n social, el status econ√≥mico, el potencial comercial, la competencia que tendr√° su negocio, los elementos urbanos atractores de clientes potenciales, el perfil de los habitantes 
		de la zona donde se encontrar√° su emprendimiento, franquicia y/o sucursal.</p>
		<p>Busque en el recuadro superior el giro de su inter√©s, y/o de clic sobre los hex√°gonos para conocer la informaci√≥n sobre un municipio, zona, lugar o donde se encuentra usted.</p> 
		<p>Renuncia de responsabilidad: Toda la informaci√≥n geoestad√≠stica aqu√≠ presentada es elaborada y por consiguiente propiedad de los institutos, organismos, asociaciones y/o secretar√≠as respectivamente. Whereon s√≥lo procesa y presenta los datos.</p>  
 	 </div>
</div>


<!-- plugins local JS -->
<script src="js/L.Control.Locate.min.js"></script>
	
<script>
document.addEventListener("DOMContentLoaded", function() {

  // ====== SPLIT PRINCIPAL (vertical: t√≠tulo / fila / listado) ======
  Split(['#title', '#top-row', '#listado'], {
    sizes: [2, 65, 33],
    direction: 'vertical',
    gutterSize: 3,
    minSize: [60, 200, 150],
    onDragEnd: () => { if (window.map) map.invalidateSize(); }
  });

  // ====== SPLIT SECUNDARIO (horizontal: controls / map / chart / otro / sidebar) ======
  Split(['#controls', '#map', '#chart', '#otro', '#sidebar','#telara√±a'], {
    sizes: [15, 20, 15, 15, 15, 20],
    direction: 'horizontal',
    gutterSize: 3,
    minSize: [100, 100, 100, 100, 100, 100],
    onDragEnd: () => { if (window.map) map.invalidateSize(); }
  });

  // ====== SPLIT VERTICAL INTERNO (urbano / scatter) ======
  Split(['#urbano', '#scatter'], {
    sizes: [40, 60],
    direction: 'vertical',
    gutterSize: 3,
    onDragEnd: () => { if (window.map) map.invalidateSize(); }
  });
});


  // ================== ESTILO GUTTERS ==================
  const gutters = document.querySelectorAll('.gutter');
  gutters.forEach(g => {
    g.style.background = '#00793a';
    g.style.border = 'none';
    g.style.transition = 'background 0.2s ease';
    g.addEventListener('mouseenter', () => g.style.background = '#00b050');
    g.addEventListener('mouseleave', () => g.style.background = '#00793a');
  });


  // ========== MAPA + CAPAS ==========
  const map = L.map('map',{
			center: [22.5, -97.5],
			zoom: 4,
			maxZoom: 18,
			minZoom: 2, 
			});
	  

			// üåç Mapa claro (OSM est√°ndar)
			const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			});
			
			// üåÉ Mapa oscuro (Carto Dark)
			const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>'
			});
			
			// ‚òÄÔ∏è Carto Light
			const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
			  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>'
			});
			
			// üõ∞Ô∏è Esri Sat√©lite
			const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
			});
	
			
			// üëÄ Agregar el mapa base por defecto (ejemplo: OSM claro)
			dark.addTo(map);
	

		// ================== Cerrar con la X ====================
		document.getElementById("closeWelcome").addEventListener("click", () => {
		  document.getElementById("welcomeBox").style.display = "none";
		});
		
		// Cerrar haciendo clic en el mapa
		map.on("click", () => {
		  document.getElementById("welcomeBox").style.display = "none";
		});

		// Cerrar haciendo clic en el mapa
		map.on("click", () => {
		  document.getElementById("ubica").style.display = "none";
		});

	
  // ========== VARIABLES COMPARTIDAS (evita ReferenceError) ==========
  var x = null;            // geojson temporal usado por photon
  var marker = null;       // marcador temporal usado por photon
  var last = null;

  // ========== LOCATE ======================
	  L.control.locate({ locateOptions: { maxZoom: 10 } }).addTo(map);
	  var draggableMarker;
		map.on("locationfound", function (e) {
	  if (draggableMarker) {
	    draggableMarker.setLatLng(e.latlng);
	  } else {
	    draggableMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
	
	    // Cuando se arrastra, actualizamos inputs
	    draggableMarker.on("dragend", function (ev) {
	      var pos = ev.target.getLatLng();
	      document.getElementById("lat").value = pos.lat.toFixed(6);
	      document.getElementById("lon").value = pos.lng.toFixed(6);
	    });
	  }
	
	  // Guardar coordenadas iniciales en los inputs
	  document.getElementById("lat").value = e.latlng.lat.toFixed(6);
	  document.getElementById("lon").value = e.latlng.lng.toFixed(6);
	  map.setView(e.latlng, 15);
	});
	
	// Si falla la localizaci√≥n
	map.on("locationerror", function () {
	  alert("No se pudo obtener tu ubicaci√≥n");
	});

	
  // ======================= DENUE =============================================
 //const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";

// üîπ Funci√≥n auxiliar para asignar √≠conos seg√∫n la actividad
function getBootstrapIconFromActividad(actividad) {
  if (!actividad) return L.divIcon({ className: "custom-pin", html: "üìç" });

  actividad = actividad.toLowerCase();
  if (actividad.includes("pizza") || actividad.includes("pizzer√≠a")) {
    return L.divIcon({ className: "custom-pin", html: "üçï" });
  } else if (actividad.includes("escuela") || actividad.includes("colegio") || actividad.includes("prepa") || actividad.includes("preparatoria") || actividad.includes("universidad")) {
    return L.divIcon({ className: "custom-pin", html: "üè´" });
  } else if (actividad.includes("banco")|| actividad.includes("banca multiple")) {
    return L.divIcon({ className: "custom-pin", html: "üè¶" });
  } else if (actividad.includes("hotel") || actividad.includes("motel") || actividad.includes("hostal")) {
    return L.divIcon({ className: "custom-pin", html: "üè®" });
  } else if (actividad.includes("super") || actividad.includes("bodega") || actividad.includes("tienda") || actividad.includes("abarrotes")) {
    return L.divIcon({ className: "custom-pin", html: "üõí" });
  } else if (actividad.includes("tacos") || actividad.includes("taquer√≠a") || actividad.includes("taqueria") || actividad.includes("comida mexicana")) {
    return L.divIcon({ className: "custom-pin", html: "üåÆ" });
  } else if (actividad.includes("hamburguesas") || actividad.includes("hamburgueseria") || actividad.includes("hamburgueseria")) {
    return L.divIcon({ className: "custom-pin", html: "üçî" });
  } else if (actividad.includes("sushi")) {
    return L.divIcon({ className: "custom-pin", html: "üçú" });
  }
  
   

  // valor por defecto
  return L.divIcon({ className: "custom-pin", html: "üìç" });
}

// üîπ Funci√≥n principal para buscar en DENUE
	
	async function buscarDENUE(condi, lat, lon, mts) {
  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e"; // tu token DENUE
  const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(condi)}/${lat},${lon}/${mts}/${token}`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const resultados = await response.json();

    // üìç Limpiar tabla y pines anteriores
    document.getElementById("tablaResultados").innerHTML = "";
    if (window.denueLayer) {
      map.removeLayer(window.denueLayer);
    }
    window.denueLayer = L.layerGroup().addTo(map);

    // üìä Procesar resultados
    resultados.forEach(item => {
      // --- Agregar fila en la tabla ---
      const row = `
        <tr>
          <td>${item.Nombre || "Sin nombre"}</td>
          <td>${item.Calle || ""} ${item.Num_Exterior || ""}, ${item.Colonia || ""}, ${item.Municipio || ""}</td>
          <td>${item.Telefono || "N/D"}</td>
          <td>${item.Estrato || "N/D"}</td>
          <td>${item.Clase_actividad || "N/D"}</td>
        </tr>
      `;
      document.getElementById("tablaResultados").insertAdjacentHTML("beforeend", row);

      // --- Agregar marcador en el mapa ---
      const marker = L.marker([item.Latitud, item.Longitud], {
        icon: getBootstrapIconFromActividad(item.Clase_actividad)
      }).bindPopup(`<b>${item.Nombre}</b><br>${item.Clase_actividad}<br>${item.Calle || ""}, ${item.Colonia || ""}`);
      marker.addTo(window.denueLayer);
    });

    // üìå Mostrar en el sidebar un resumen
    mostrarResultadosBusqueda(condi, resultados.length);

  } catch (error) {
    console.error("Error en buscarDENUE:", error);
    alert("‚ùå No se pudieron obtener resultados del DENUE.");
  }
}

// ================== GR√ÅFICA ==================
let chart = new Chart(document.getElementById("myChart"), {
  type: "pie",
  data: {
    labels: ["0-14 a√±os", "15-64 a√±os", "65+ a√±os"],
    datasets: [{
      backgroundColor: ["#00ae4d", "#99ca3c", "#d7df23"],
      data: [0, 0, 0]
    }]
  },
  options: {
    responsive: true,
	maintainAspectRatio: true,
    title: {
      display: true,
      text: "Poblaci√≥n seg√∫n grupo de edad"
    }
  }
});

// ================== FUNCIONES DE IMPRESI√ìN ==================
function mostrarEnSidebar(html) {
  const cont = document.getElementById("sidebar-content");
  if (cont) cont.innerHTML = html;
}

function agregarEnSidebar(html) {
  const cont = document.getElementById("sidebar-content");
  if (cont) cont.innerHTML += html;
}

function mostrarEnGraph(html) {
  const cont = document.getElementById("info-content");
  if (cont) cont.innerHTML = html;
}

function mostrarEnUrbano(html) {
  const cont = document.getElementById("sidebar-content");
  if (cont) {
    const bloqueUrbano = `
      <div id="info-urbano">
        ${html}
      </div>
    `;
    cont.innerHTML += bloqueUrbano;
  }
}




// ================== FUNCIONES URBANOS ==================
function procesarDENUE(resumen, extras) {
  let listado =  `<h3>üèôÔ∏è Elementos urbanos dentro de la zona</h3>`;

   listado += "<ul>";
	
	for (const [cat, num] of Object.entries(resumen)) {
    listado += `<li>${getEmojiCategoria(cat)} <strong>${cat}:</strong> ${num}</li>`;
  }
  listado += "</ul>";
  listado += "<ul>";
	
    if (Object.keys(extras).length > 0) {
      listado += "<h3>üîç Otros establecimientos:</h3><ul>";
      for (const [cat, num] of Object.entries(extras)) {
        listado += `<li>üìç <strong>${cat}:</strong> ${num}</li>`;
      }
      listado += "</ul>";
    }

  mostrarEnUrbano(listado);
}

function getEmojiCategoria(cat) {
  const emojis = {
    "Bancos": "üè¶",
    "Supermercados": "üõí",
    "Escuelas": "üè´",
    "Hoteles": "üè®"
  };
  return emojis[cat] || "üìç";
}


// ================= UTILIDADES =================
function safeNumber(val) {
  return isNaN(val) || val === null ? 0 : Number(val);
}

function normalizarMinMax(valor, min, max) {
  if (max === min) return 50;
  return Math.max(0, Math.min(100, ((valor - min) / (max - min)) * 100));
}

// ================= RANGOS GLOBALES =================
// Ajustables despu√©s con datos reales
const rangos = {
  delitos: { min: 0, max: 100000 },
  creditos: { min: 0, max: 900000 },
  densidad: { min: 0, max: 50 },
  comercial: { min: 0, max: 50 }
};

// ================= SCORE DELICTIVO (NEGATIVO) =================
function calcularScoreDelictivo(props) {
  const robo = safeNumber(props["robo a neg"]);
  const ext = safeNumber(props["extorsi√≥n"]);
  const narco = safeNumber(props["narcomenud"]);
  const poblacion = safeNumber(props.POBTOT_sum);

  if (poblacion === 0) return 50;

  const tasa = ((robo + ext + narco) / poblacion) * 100000;

  return Number(
    100 -
    normalizarMinMax(tasa, rangos.delitos.min, rangos.delitos.max)
  ).toFixed(1);
}

// ================= SCORE FINANCIERO (POSITIVO) =================
function calcularScoreFinanciero(props) {
  const creditos =
    safeNumber(props.CRED_PERS) +
    safeNumber(props.CRED_NOMI) +
    safeNumber(props.CRED_HIPOT) +
    safeNumber(props.CRED_AUTOM);

  const poblacion = safeNumber(props.POBTOT_sum);
  if (poblacion === 0) return 50;

  const tasa = (creditos / poblacion) * 10000;

  return normalizarMinMax(
    tasa,
    rangos.creditos.min,
    rangos.creditos.max
  ).toFixed(1);
}

// ================= SCORE DEMOGR√ÅFICO =================
function calcularScoreDemografico(props) {
  const poblacion = safeNumber(props.POBTOT_sum);
  const areaHex = 700;

  const densidad = poblacion / areaHex;

  return normalizarMinMax(
    densidad,
    rangos.densidad.min,
    rangos.densidad.max
  ).toFixed(1);
}

// ================= SCORE COMERCIAL =================
function calcularScoreComercial(resumenDENUE) {
  const ponderado =
    (resumenDENUE.Bancos || 0) * 15 +
    (resumenDENUE.Supermercados || 0) * 10 +
    (resumenDENUE.Escuelas || 0) * 5 +
    (resumenDENUE.Hoteles || 0) * 10;

  const areaHex = 700;
  const densidadComercial = ponderado / areaHex;

  return normalizarMinMax(
    densidadComercial,
    rangos.comercial.min,
    rangos.comercial.max
  ).toFixed(1);
}

let radarEvaluacion;

function inicializarRadar() {
  const ctx = document.getElementById("radarEvaluacion").getContext("2d");

  radarEvaluacion = new Chart(ctx, {
    type: "radar",
    data: {
      labels: [
        "Entorno social",
        "Entorno econ√≥mico",
        "Entorno demogr√°fico",
        "Entorno urbano"
      ],
      datasets: [{
        label: "Score de la plaza",
        data: [50, 50, 50, 50],
        backgroundColor: "rgba(0, 174, 77, 0.25)",
        borderColor: "#00ae4d",
        pointBackgroundColor: "#00ae4d",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          min: 0,
          max: 100,
          ticks: {
            stepSize: 20,
			backdropColor: "transparent",
            color: "#ccc",
			font: { size: 10 }
          },
          grid: { color: "#555" },
          angleLines: { color: "#555" },
          pointLabels: {
            color: "#fff",
            font: { size: 12 }
          }
        }
      },
      plugins: {
        legend: {
          labels: { color: "#fff" }
        }
      }
    }
  });
}

document.addEventListener("DOMContentLoaded", inicializarRadar);

function mostrarScoresEnTelarana(scores) {
  const cont = document.getElementById("scores-plaza");
  if (!cont) return;

  cont.innerHTML = `
    <div style="margin-bottom:8px;">
      <p><b>üõ°Ô∏è Entorno social:</b> ${scores.delito}</p>
      <p><b>üí≥ Entorno econ√≥mico:</b> ${scores.financiero}</p>
      <p><b>üë• Entorno demogr√°fico:</b> ${scores.demografico}</p>
      <p><b>üè¨ Entorno urbano:</b> ${scores.comercial}</p>
    </div>
    <hr>
  `;
}

	
// ================== EVENTOS EN HEXAGONOS ==================
function onEachFeature(feature, layer) {
  layer.on("click", async () => {
    const props = feature.properties || {};

    // --- Sidebar fijo ---
    const htmlFija = `
      <div id="info-fija">
        <h2>${props.nomgeo || "Zona"}</h2>
        <b>Tipo:</b> ${props.TIPO || "N/A"}<br>
        <p><b>Poblaci√≥n municipal total:</b> ${props.pobtot?.toLocaleString() || 0}</p>
        <p><b>Poblaci√≥n adulta municipal:</b> ${props.POBADUL?.toLocaleString() || 0}</p>
        <p><b>√çndice de Rezago:</b> ${props.REZAGO || "N/A"}</p><hr>
        <p><b>Extorsi√≥n:</b> ${props["extorsi√≥n"] || 0}</p>
        <p><b>Narcomenudeo:</b> ${props.narcomenud || 0}</p>
        <p><b>Robo a negocio:</b> ${props["robo a neg"] || 0}</p><hr>
        <p><b>Cr√©ditos personales:</b> ${props.CRED_PERS?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos n√≥mina:</b> ${props.CRED_NOMI?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos hipotecarios:</b> ${props.CRED_HIPOT?.toLocaleString() || 0}</p>
        <p><b>Cr√©ditos automotrices:</b> ${props.CRED_AUTOM?.toLocaleString() || 0}</p>
      </div><hr>
    `;
    mostrarEnSidebar(htmlFija);

    // --- Calculo y densidades ---
    const pobTot = props.POBTOT_sum || 0;
    const pob0_14 = props.POB0_14_sum || 0;
    const pob15_64 = props.POB15_64_sum || 0;
    const pob65   = props.POB65_MAS_sum || 0;

    const densidadTot = (pobTot / 700).toFixed(2);
    const densidad0_14 = (pob0_14 / 700).toFixed(2);
    const densidad15_64 = (pob15_64 / 700).toFixed(2);
    const densidad65 = (pob65 / 700).toFixed(2);

    const infoPob = `
      <p><b>Pertenece al municipio de:</b> ${props.nomgeo || "Zona"}</p>
      <p><b>Poblaci√≥n total: </b> ${pobTot.toLocaleString()} 
        <i>(Dens.: ${densidadTot} hab/ha)</i></p>
      <p><b>Poblaci√≥n de 0 a 14 a√±os: </b> ${pob0_14.toLocaleString()} 
        <i>(Dens.: ${densidad0_14} hab/ha)</i></p>
      <p><b>Poblaci√≥n de 15 a 64 a√±os: </b> ${pob15_64.toLocaleString()} 
        <i>(Dens.: ${densidad15_64} hab/ha)</i></p>
      <p><b>Poblaci√≥n de +65 a√±os: </b> ${pob65.toLocaleString()} 
        <i>(Dens.: ${densidad65} hab/ha)</i></p>
    `;
    mostrarEnGraph(infoPob);

    // --- Actualizar gr√°fica ---
    chart.data.datasets[0].data = [pob0_14, pob15_64, pob65];
    chart.update();

    // --- Consulta DENUE ---
    const bounds = layer.getBounds();
    const resultados = await buscarEnHexagono(bounds, ["banco","super","escuela","hotel"]);

    const resumen = { Bancos:0, Supermercados:0, Escuelas:0, Hoteles:0 };
    const extras = {};

    resultados.forEach(item => {
      const c = (item.Clase_actividad || "").toLowerCase();
      if (c.includes("banco") || c.includes("banca m√∫ltiple")) resumen.Bancos++;
      else if (c.includes("escuela") || c.includes("colegio") || c.includes("universidad")) resumen.Escuelas++;
      else if (c.includes("super") || c.includes("bodega") || c.includes("abarrotes")) resumen.Supermercados++;
      else if (c.includes("hotel") || c.includes("motel") || c.includes("hostal")) resumen.Hoteles++;
      else {
        const nombre = item.Clase_actividad.trim();
        extras[nombre] = (extras[nombre] || 0) + 1;
      }
    });

    procesarDENUE(resumen, extras);

	// ================= CALCULAR SCORES =================
	const scoreDelito = calcularScoreDelictivo(props);
	const scoreFinanciero = calcularScoreFinanciero(props);
	const scoreDemo = calcularScoreDemografico(props);
	const scoreComercial = calcularScoreComercial(resumen);
	
	// ================= MOSTRAR EN TELARA√ëA =================
	mostrarScoresEnTelarana({
	  delito: scoreDelito,
	  financiero: scoreFinanciero,
	  demografico: scoreDemo,
	  comercial: scoreComercial
	});
	
if (radarEvaluacion) {
  radarEvaluacion.data.datasets[0].data = [
    scoreDelito,
    scoreFinanciero,
    scoreDemo,
    scoreComercial
  ];
  radarEvaluacion.update();
}


	  
    });
}

  //======================= LOGO ================================
	var logoControl = L.control({ position: "bottomleft" });

	logoControl.onAdd = function (map) {
	    var div = L.DomUtil.create("div", "logo-leaflet");
	    div.innerHTML = '<img src="images/WhereOn-Blanco-Vert.png" style="width:80px; opacity:0.9;">';
	    return div;
	};
	
	logoControl.addTo(map);
  
  // ========== ESTILO / LAYERS ==========
  function getColor(d) {
    return d > 50000 ? '#d7191c' :
           d > 25000 ? '#fdae61' :
           d > 10000 ? '#ffffbf' :
           d > 5000  ? '#abdda4' :
           d > 1     ? '#2b83ba':
		               '#2d2d2d';
  }
  
	function style(feature) {
    return {
      fillColor: getColor(feature.properties?.["POBTOT_sum"]),
      weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
    };
  }


  // Leyenda
  var legendHex = L.control({position: 'bottomright'});
  legendHex.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1, 5000, 10000, 25000, 50000];
	  div.innerHTML += "<b>Poblaci√≥n</b><br>";
    for (var i = 0; i < grades.length; i++) {
      div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                       grades[i] + (grades[i+1] ? '&ndash;' + grades[i+1] + '<br>' : '+');
    }
    return div;
  };
  legendHex.addTo(map);

	

  // ========== ESTILO NSE ==========

	function getColorNSE(tipo) {
	  switch (tipo) {
	    case 'A/B': return '#1f77b4';
	    case 'C+':  return '#0ddec9';
	    case 'C':   return '#2ca02c';
	    case 'C-':  return '#95de0d';
	    case 'D+':  return '#ffd200';
	    case 'D':   return '#ff7f0e';
	    case 'E':   return '#d62728';
	    default:    return '#cccccc';
	  }
	}
	function styleNSE(feature) {
	 return {
	 fillColor: getColorNSE (feature.properties["NIVEL PREDOMINANTE"]),
	 weight: 2,
	 opacity: 1,
	 color: 'white',
	 dashArray: '3',
	 fillOpacity: 0.7
		 };
		}

	const nseAgs = L.geoJson(nse_ags, {
	  style: styleNSE,
	  onEachFeature: function (feature, layer) {
	    layer.bindPopup("Nivel socioecon√≥mico predominante: " + feature.properties["NIVEL PREDOMINANTE"]);
	  }
	});
	
	const nseCdmx = L.geoJson(nse_cdmx, {
	  style: styleNSE,
	  onEachFeature: function (feature, layer) {
	    layer.bindPopup("Nivel socioecon√≥mico predominante: " + feature.properties["NIVEL PREDOMINANTE"]);
	  }
	});
	
	
	// HIVE
	const hiveLayer01 = L.geoJson(hive_ags, { style, onEachFeature });
	const hiveLayer13 = L.geoJson(hive_hgo, { style, onEachFeature });
	const hiveLayer22 = L.geoJson(hive_qro, { style, onEachFeature });
	const hiveLayer09 = L.geoJson(hive_cdmx, { style, onEachFeature });
	const hiveLayer15 = L.geoJson(hive_edomex, { style, onEachFeature });
	const hiveLayer11 = L.geoJson(hive_gto, { style, onEachFeature });
	const hiveLayer17 = L.geoJson(hive_mor, { style, onEachFeature });
	const hiveLayer18 = L.geoJson(hive_nay, { style, onEachFeature });
	const hiveLayer21 = L.geoJson(hive_pue, { style, onEachFeature });
	const hiveLayer29 = L.geoJson(hive_tlax, { style, onEachFeature });
	const hiveLayer24 = L.geoJson(hive_slp, { style, onEachFeature });
	
	// GRUPOS
	const hiveGroup = L.layerGroup([hiveLayer01, hiveLayer09, hiveLayer11, hiveLayer15, hiveLayer13, hiveLayer17, hiveLayer18, hiveLayer21, hiveLayer22, hiveLayer24, hiveLayer29]).addTo(map);
	const nseGroup = L.layerGroup([nseAgs,nseCdmx]);

			var legendNSE = L.control({ position: 'bottomright' });
		legendNSE.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'info legend'),
		      categories = ['A/B', 'C+', 'C', 'C-', 'D+', 'D', 'E'];
		  div.innerHTML += "<b>NSE</b><br>";
		  for (var i = 0; i < categories.length; i++) {
		    div.innerHTML +=
		      '<i style="background:' + getColorNSE(categories[i]) + '"></i> ' +
		      categories[i] + '<br>';
		  }
		  return div;
		};
		legendNSE.addTo(map);
		
			// Mostrar la leyenda correspondiente
		map.on('overlayadd', function (eventLayer) {
		  if (eventLayer.name === "HIVE") {
		    map.addControl(legendHex);
		  }
		  if (eventLayer.name === "NSE") {
		    map.addControl(legendNSE);
		  }
		});
		
		map.on('overlayremove', function (eventLayer) {
		  if (eventLayer.name === "HIVE") {
		    map.removeControl(legendHex);
		  }
		  if (eventLayer.name === "NSE") {
		    map.removeControl(legendNSE);
		  }
		});

  // üéõÔ∏è Ahora s√≠ agregamos control de capas
		var baseMaps = {
          "Oscuro": dark,
		  "Claro": osm,
          "Light": light,
          "Sat√©lite": esriSat,	
        };
               
        var overlays = {
		  "HIVE": hiveGroup,
		  "NSE": nseGroup,
        };
        
        L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);

// ============================== FILTRO ======================================

const hiveLayers = {
  AGS: hiveLayer01,
  HGO: hiveLayer13,
  QRO: hiveLayer22,
  CDMX: hiveLayer09,
  MEX: hiveLayer15,
  GTO: hiveLayer11,
  MOR: hiveLayer17,
  NAY: hiveLayer18,
  PUE: hiveLayer21,
  SLP: hiveLayer24,	
  TLX: hiveLayer29
  };

	
// ============================== RESUMEN DENUE ======================================

document.getElementById('btnBuscar').addEventListener('click', () => {
  const condi = document.getElementById("condi").value;
  const lat = document.getElementById("lat").value;
  const lon = document.getElementById("lon").value;
  const mts = document.getElementById("mts").value;

  buscarDENUE(condi, lat, lon, mts);
});


// ================= FUNCION buscarEnHexagono ===================
	async function buscarEnHexagono(bounds, categorias) {
	  const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";
	
	  // üëâ Tomamos el centro del hex√°gono
	  const center = bounds.getCenter();
	
	  // üëâ Aproximamos un radio en metros (diagonal menor del bounding box)
	  const latDiff = bounds.getNorth() - bounds.getSouth();
	  const lonDiff = bounds.getEast() - bounds.getWest();
	  const approxKm = Math.max(latDiff, lonDiff) * 111; // 1¬∞ ‚âà 111 km
	  const radius = Math.round(approxKm * 1000 / 2); // en metros
	
	  let resultados = [];
	
	  for (const cat of categorias) {
	    const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${center.lat},${center.lng}/${radius}/${token}`;

	    try {
	      const resp = await fetch(url);
	      if (resp.ok) {
	        const data = await resp.json();
	        if (Array.isArray(data)) resultados = resultados.concat(data);
	      }
	    } catch (e) {
	      console.error("Error consultando categor√≠a", cat, e);
	    }
	  }
	
	  return resultados;
	}


  // Utilidad: getIconoCategoria (usa tu funci√≥n original)
  function getIconoCategoria(cat){
    switch(cat){
      case "Bancos": return '<i class="bi bi-bank"></i>';
      case "Supermercados": return '<i class="bi bi-basket3-fill"></i>';
      case "Escuelas": return '<i class="bi bi-mortarboard-fill"></i>';
      case "Hoteles": return '<i class="bi bi-building"></i>';
      default: return '<i class="bi bi-geo-alt-fill"></i>';
    }
  }

function mostrarResultadosBusqueda(condi, total) {
  const cont = document.getElementById("resultadosBusqueda");
  cont.innerHTML = `
    <div class="resultado-personalizado">
      <span class="icono">üìä</span>
      <span class="nombre">${condi}</span>
      <span class="conteo">(${total} encontrados)</span>
    </div>
  `;
}



	
	// ========== PLUGIN PHOTON ==========
	
if (L.control.photon) {
  // Inicializa Photon en el mapa
  const photonControl = L.control.photon({
    url: "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
    placeholder: "Buscar direcci√≥n..."
  }).addTo(map);

  // Mueve el nodo a #controls
  const photonNode = document.getElementsByClassName("leaflet-photon")[0];
  if (photonNode) {
    document.getElementById("photon-container").appendChild(photonNode);
  }

  // Evento cuando seleccionas un resultado
  photonControl.on('selected', function(e) {
    try {
      if (x) { map.removeLayer(x); x = null; }
      if (marker) { map.removeLayer(marker); marker = null; }

      // Dibujar geometr√≠a si existe
      x = L.geoJSON(e.choice).addTo(map);
      const ll = x.getLayers()[0].getLatLng();
      marker = L.marker(ll).addTo(map);
      map.setView(ll, 17);

      // Actualizar inputs
      if (document.getElementById("lat")) document.getElementById("lat").value = ll.lat;
      if (document.getElementById("lon")) document.getElementById("lon").value = ll.lng;
    } catch (err) {
      console.error('Error en selecci√≥n Photon:', err);
    }
  });
} else {
  console.warn("L.control.photon no est√° disponible (¬øfalta cargar leaflet.photon.js?)");
}

	



// ============== BOTON PDF ===================================
	
  //document.getElementById("btnExportar").addEventListener("click", function () {
    //const contenedor = document.getElementById("mapa-contenedor");

   // html2canvas(contenedor, {
     // useCORS: true, // para tiles externos
      //scale: 2       // mejor calidad
    //}).then(canvas => {
      //const imgData = canvas.toDataURL("image/png");
      //const { jsPDF } = window.jspdf;
      //const pdf = new jsPDF("landscape", "mm", "a4");

      //const pageWidth = pdf.internal.pageSize.getWidth();
      //const pageHeight = pdf.internal.pageSize.getHeight();

      //const imgWidth = pageWidth;
      //const imgHeight = canvas.height * pageWidth / canvas.width;

      //pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
      //pdf.save("mapa_resultados.pdf");
    //});
  //});

// ============== UBICACION ===================================

document.getElementById("Ubicacion").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("‚ö†Ô∏è Tu navegador no soporta geolocalizaci√≥n");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // üëá Quitar marcador previo si existe
      if (window.miUbicacionMarker) {
        map.removeLayer(window.miUbicacionMarker);
      }

      // üëá Crear marcador en la ubicaci√≥n del usuario
      window.miUbicacionMarker = L.marker([lat, lon], {
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", // √çcono personalizado
          iconSize: [30, 30]
        })
      }).addTo(map).bindPopup("üìç Est√°s aqu√≠").openPopup();

      // üëá Hacer zoom al punto
      map.setView([lat, lon], 15);

      // üëá Si quieres llenar inputs en #controls
      if (document.getElementById("lat")) document.getElementById("lat").value = lat;
      if (document.getElementById("lon")) document.getElementById("lon").value = lon;
    },
    (err) => {
      alert("‚ùå No se pudo obtener la ubicaci√≥n: " + err.message);
    }
  );
});


// ================== GR√ÅFICA SCATTER DE DELITOS ==================
const ctxScatter = document.getElementById("scatterChart").getContext("2d");

let scatterChart = new Chart(ctxScatter, {
  type: 'bubble',
  data: {
    datasets: [
      {
        label: "Robo a negocio",
        backgroundColor: "rgba(255, 99, 132, 0.6)",
        borderColor: "#ff6384",
        pointRadius: 6,
        data: []
      },
      {
        label: "Extorsi√≥n",
        backgroundColor: "rgba(54, 162, 235, 0.6)",
        borderColor: "#36a2eb",
        pointRadius: 6,
        data: []
      },
      {
        label: "Narcomenudeo",
        backgroundColor: "rgba(255, 206, 86, 0.6)",
        borderColor: "#ffce56",
        pointRadius: 6,
        data: []
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: {
        type: "category",
        title: { display: true, text: "Municipio" },
        ticks: { color: "#fff", font: { family: "Poppins" } }
      },
      y: {
        beginAtZero: true,
        title: { display: true, text: "Casos registrados" },
        ticks: { color: "#fff", font: { family: "Poppins" } }
      }
    },
    plugins: {
      legend: {
        labels: { color: "#fff", font: { family: "Poppins" } }
      },
      tooltip: {
        callbacks: {
          label: function (context) {
            const p = context.raw;
            return `${context.dataset.label}: ${p.y} casos en ${p.x}`;
          }
        }
      }
    }
  }
});

// ================== FUNCI√ìN PARA ACTUALIZAR SCATTER ==================
function actualizarScatter(geojson) {
  const datosRobo = [];
  const datosExt = [];
  const datosNarco = [];

  geojson.features.forEach(f => {
    const props = f.properties || {};
    const municipio = props.nomgeo || "Sin nombre";
    datosRobo.push({ x: municipio, y: props["robo a neg"] || 0 });
    datosExt.push({ x: municipio, y: props["extorsi√≥n"] || 0 });
    datosNarco.push({ x: municipio, y: props["narcomenud"] || 0 });
  });

  scatterChart.data.datasets[0].data = datosRobo;
  scatterChart.data.datasets[1].data = datosExt;
  scatterChart.data.datasets[2].data = datosNarco;
  scatterChart.update();
}

// ================== FUNCI√ìN DE FILTRO POR ESTADO ==================
document.getElementById("filtroEstado").addEventListener("change", (e) => {
  const estado = e.target.value;
  hiveGroup.clearLayers();

  if (estado === "todos") {
    // Combina todos los GeoJSONs en uno
    const combinado = { type: "FeatureCollection", features: [] };
    Object.values(hiveLayers).forEach(layer => {
      hiveGroup.addLayer(layer);
      if (layer.toGeoJSON) combinado.features.push(...layer.toGeoJSON().features);
    });
    actualizarScatter(combinado);

    // Ajusta vista general
    const bounds = hiveGroup.getBounds();
    if (bounds.isValid()) map.fitBounds(bounds);
  } else {
    // Carga solo la capa del estado seleccionado
    const layer = hiveLayers[estado];
    if (layer) {
      hiveGroup.addLayer(layer);
      if (layer.toGeoJSON) actualizarScatter(layer.toGeoJSON());

      // Zoom autom√°tico al estado
      const bounds = layer.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds);
    }
  }
});


// ================== EVENTO FILTRO ==================
// ================== FILTROS DE ESTADO Y DELITO ==================

// Crear lista de delitos
const delitos = [
  { campo: "robo a neg", nombre: "Robo a negocio", color: "#ff6384" },
  { campo: "extorsi√≥n", nombre: "Extorsi√≥n", color: "#36a2eb" },
  { campo: "narcomenud", nombre: "Narcomenudeo", color: "#ffce56" }
];


// ================== ACTUALIZAR GR√ÅFICA MULTIDELITO ==================
function actualizarScatterMultidelito(layerGroup) {
  // Limpiar datasets
  scatterChart.data.datasets.forEach(ds => (ds.data = []));

  const vistos = new Set(); // para evitar duplicados por municipio

  layerGroup.eachLayer(l => {
    const props = l.feature?.properties || {};
    const municipio = props.nomgeo?.trim() || "N/A";
    const clave = municipio.toLowerCase();

    // Solo agregar si no se ha agregado ese municipio antes
    if (!vistos.has(clave)) {
      vistos.add(clave);

      scatterChart.data.datasets[0].data.push({
        x: municipio,
        y: props["robo a neg"] || 0
      });
      scatterChart.data.datasets[1].data.push({
        x: municipio,
        y: props["extorsi√≥n"] || 0
      });
      scatterChart.data.datasets[2].data.push({
        x: municipio,
        y: props["narcomenud"] || 0
      });
    }
  });

  scatterChart.update();
}


// ================== FILTRO DE ENTIDAD ==================
document.getElementById("filtroEstado").addEventListener("change", () => {
  const estado = document.getElementById("filtroEstado").value;
  hiveGroup.clearLayers();

  if (estado === "todos") {
    Object.values(hiveLayers).forEach(layer => hiveGroup.addLayer(layer));
    actualizarScatterMultidelito(hiveGroup);

    const bounds = hiveGroup.getBounds();
    if (bounds.isValid()) map.fitBounds(bounds);
  } else {
    let capa = hiveLayers[estado];
    hiveGroup.addLayer(capa);
    actualizarScatterMultidelito(capa);

    const bounds = capa.getBounds();
    if (bounds.isValid()) map.fitBounds(bounds);
  }
});

// ================== FILTRO DE DELITO (OCULTAR/MOSTRAR) ==================
document.getElementById("filtroDelito").addEventListener("change", () => {
  const delito = document.getElementById("filtroDelito").value;

  scatterChart.data.datasets.forEach(ds => {
    if (delito === "todos") {
      ds.hidden = false;
    } else {
      ds.hidden = ds.label.toLowerCase().includes(delito) ? false : true;
    }
  });

  scatterChart.update();
});

// ==========================
//  GAUGE COMPLETO
// ==========================
const gaugePlugin = {
  id: "gaugePlugin",
  afterDraw(chart) {
    const { ctx, data } = chart;
    const valor = data.datasets[0].valorActual || 0;

    const cx = chart.width / 2;
    const cy = chart.height * 0.9;
    const radius = chart.height * 0.45;

    const pct = valor / 100;
    const ang = Math.PI * (1 - pct); // arco 180¬∞

    ctx.save();

    // Aguja
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(
      cx + radius * Math.cos(ang),
      cy - radius * Math.sin(ang)
    );
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 5;
    ctx.stroke();

    // Pivote
    ctx.beginPath();
    ctx.arc(cx, cy, 10, 0, Math.PI * 2);
    ctx.fillStyle = "#fff";
    ctx.fill();

    // Texto del valor
    ctx.font = "26px Poppins";
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.fillText(valor + "%", cx, cy - radius - 10);

    // Etiquetas del arco
    const labels = [0,20,40,60,80,100];
    ctx.font = "12px Poppins";

    labels.forEach(v => {
      const a = Math.PI * (1 - v/100);
      const lx = cx + (radius + 20) * Math.cos(a);
      const ly = cy - (radius + 20) * Math.sin(a);
      ctx.fillText(v, lx, ly);
    });

    ctx.restore();
  }
};

const gaugeChart = new Chart(document.getElementById("gaugeChart"), {
  type: "doughnut",
  plugins: [gaugePlugin],
  data: {
    datasets: [{
      valorActual: 0,
      data: [20,20,20,20,20], 
      backgroundColor: [
        "#0033cc", // azul
        "#00b050", // verde
        "#ffeb3b", // amarillo
        "#ff9800", // naranja
        "#d32f2f"  // rojo
      ],
      borderWidth: 0,
      circumference: 180,
      rotation: 270,
      cutout: "70%"
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false }, tooltip: { enabled: false } },
    animation: { duration: 1200, easing: "easeOutExpo" }
  }
});

function actualizarGauge(score) {
  gaugeChart.data.datasets[0].valorActual = score;
  gaugeChart.update();
}


//==https://www.inegi.org.mx/app/api/indicadores/desarrolladores/jsonxml/INDICATOR/5300000101,6200240473/es/00/true/BISE/2.0/33602899-98fd-4db7-8ce9-41c0330f1d7e?type=json===

async function cargarGastoNacional() {

    const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";
    const indicador = "6200240473";
    const url = `https://www.inegi.org.mx/app/api/indicadores/desarrolladores/jsonxml/INDICATOR/${indicador}/es/00/true/BISE/2.0/${token}?type=json`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        console.log("üì¶ Respuesta completa:", data);

        if (!data.Series || !data.Series[0]) {
            console.error("‚ùå No se encontr√≥ informaci√≥n");
            return;
        }

        const serie = data.Series[0];
        const nombre = serie.Nombre;
        const valor = serie.Data[0].Dato;

        console.log(`üìç ${nombre}: ${valor}`);

        const cont = document.getElementById("telara√±a");
        if (cont) {
            cont.innerHTML += `
                <p><strong>${nombre}:</strong> ${valor}</p>
            `;
        }

    } catch (err) {
        console.error("‚ùå Error consultando INEGI:", err);
    }
}

cargarGastoNacional();



</script>
</body>
</html>























































