<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estudio de mercado a un clic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 


   
    
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            background: #121212;
            color: #e0e0e0;
        }
        #controls {
            padding: 10px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
        }
        label { margin-right: 5px; }
        input, button {
            margin: 3px;
            padding: 5px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background: #444;
        }
        #map {
            height: 60vh;
            width: 100%;
        }
        #listado {
            height: 40vh;
            overflow-y: auto;
            background: #181818;
            border-top: 1px solid #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            color: #e0e0e0;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        tr:hover {
            background: #333;
            cursor: pointer;
        }
        th {
            background: #222;
            position: sticky;
            top: 0;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label>Establecimiento:</label>
        <input type="text" id="condi" value="restaurantes" />
        <label>Latitud:</label>
        <input type="text" id="lat" value="19.33333333333" />
        <label>Longitud:</label>
        <input type="text" id="lon" value="-99.22222222222" />
        <label>Metros:</label>
        <input type="number" id="mts" value="300" />
        <button id="btnBuscar">Buscar</button>
    </div>

    <div id="map"></div>
    <div id="listado">
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Dirección</th>
                    <th>Teléfono</th>
                </tr>
            </thead>
            <tbody id="tablaResultados"></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";

// Inicializar mapa en modo oscuro
const map = L.map('map').setView([19.432650801677962, -99.13316794583835], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);

var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);    

    var myMarker = L.marker([19.965, -99.664]);     
    var myMarker1 = L.marker([19.9614, -99.6672]);
        map.addLayer(myMarker);
        map.addLayer(myMarker1);
        //Control de visualización de capas
        var baseLayers = {
        "Base": map,
        "Ortoimagen": osm
        };
        var overlays = {
        "Ubicación 1": myMarker,
        "Ubicación 2": myMarker1,
        };
        var control = new L.control.layers(baseLayers, overlays,
        {collapsed:false});
        control.addTo(map);     

L.control.scale({imperial: true}).addTo(map);

    
// Capa de marcadores
let markersLayer = L.featureGroup().addTo(map);

async function buscarDENUE() {
    markersLayer.clearLayers();
    document.getElementById("tablaResultados").innerHTML = "";

    let condi = document.getElementById('condi').value.trim().toLowerCase();
    const lat = parseFloat(document.getElementById('lat').value.trim());
    const lon = parseFloat(document.getElementById('lon').value.trim());
    const mts = parseInt(document.getElementById('mts').value.trim());

    if (!condi || isNaN(lat) || isNaN(lon) || isNaN(mts)) {
        alert("Por favor ingresa datos válidos.");
        return;
    }

    const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(condi)}/${lat},${lon}/${mts}/${token}`;

    try {
        console.log("Consultando:", url);
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) {
            alert("No se encontraron resultados.");
            return;
        }

        data.forEach(item => {
            const latNum = parseFloat(item.Latitud);
            const lonNum = parseFloat(item.Longitud);
            if (isNaN(latNum) || isNaN(lonNum)) return;

            const popupContent = `
                <b>${item.Nombre || ''}</b><br>
                ${item.Razon_social || ''}<br>
                ${item.Calle || ''} ${item.Num_Exterior || ''}<br>
                ${item.Colonia || ''}, ${item.CP || ''}<br>
                ${item.Telefono || ''}
            `;

            const marker = L.marker([latNum, lonNum]).bindPopup(popupContent);
            markersLayer.addLayer(marker);

            // Agregar a tabla
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.Nombre || ''}</td>
                <td>${(item.Calle || '') + ' ' + (item.Num_Exterior || '') + ', ' + (item.Colonia || '')}</td>
                <td>${item.Telefono || ''}</td>
            `;
            row.addEventListener("click", () => {
                map.setView([latNum, lonNum], 18);
                marker.openPopup();
            });
            document.getElementById("tablaResultados").appendChild(row);
        });

        const bounds = markersLayer.getBounds();
        if (bounds.isValid()) {
            map.fitBounds(bounds.pad(0.1));
        }

    } catch (error) {
        console.error("Error consultando DENUE:", error);
        alert("Error al consultar la API. Ver consola para más detalles.");
    }
}

// Solo buscar cuando el usuario haga clic
document.getElementById('btnBuscar').addEventListener('click', buscarDENUE);
</script>
</body>
</html>












