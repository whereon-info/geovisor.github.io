<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estudio de mercado a un clic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

 <!-- Hive -->
  <script type="text/javascript" src="js/hive_cdmx.js"></script>
  <script type="text/javascript" src="js/hive_edomex.js"></script>

  <style>
    body,html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .leaflet-sidebar { z-index:1000; }
	.legend {line-height: 18px; color: #555;}
	.legend i {width: 18px;height: 18px; float: left;margin-right: 8px;opacity: 0.7;}
	.leaflet-sidebar-header {height: 40px;line-height: 40px;font-size: 16pt;color: rgb(0, 0, 0);background-color: rgb(0, 116, 217);margin: -10px -20px 0px; padding: 0px 20px;}
	.info {padding: 6px 8px;font: 14px/16px Arial, Helvetica, sans-serif;background: red; background: rgba(186,186,186,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2);border-radius: 5px;}
	.info h2 {margin: 0 0 5px;color: #404040;}
  </style>
</head>

	<body>
  <div id="map"></div>
  <div id="sidebar" class="leaflet-sidebar collapsed">
    <div class="leaflet-sidebar-tabs">
      <ul role="tablist">
        <li><a href="#info" role="tab"><i class="bi bi-info-circle"></i></a></li>
      </ul>
    </div>
    <div class="leaflet-sidebar-content">
      <div class="leaflet-sidebar-pane" id="info">
        <h3 class="leaflet-sidebar-header">
          Ficha de informaci√≥n urbano social y econ√≥mica de la zona
          <span class="leaflet-sidebar-close"><i class="bi bi-x-lg"></i></span>
        </h3>
        <div id="sidebar-content">H√°ga clic en una zona para conocer su informaci√≥n</div>
      </div>
    </div>
  </div>

  <script>
    // ================== MAPA ===================
		const map = L.map('map').setView([22.5, -100.5], 5);
		L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
		    attribution: '&copy; OpenStreetMap contributors',
		    subdomains: 'abcd',
		    maxZoom: 19
		}).addTo(map);
		
		var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
		});
		
		map.addLayer(osm);

    const sidebar = L.control.sidebar({ container:'sidebar', position:'right' }).addTo(map);
    function mostrarEnSidebar(html){ 
      document.getElementById("sidebar-content").innerHTML = html; 
      sidebar.open("info"); 
    }

    // ================== TOKEN DENUE ===================
    const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";

	//======================= Logo ======================
	var logoControl = L.control({ position: "bottomleft" });

	logoControl.onAdd = function (map) {
	    var div = L.DomUtil.create("div", "logo-leaflet");
	    div.innerHTML = '<img src="images/WhereOn-Logo-Color-Vrt.png" style="width:80px; opacity:0.9;">';
	    return div;
	};
	
	logoControl.addTo(map);
	  
    // ================== CATEGOR√çAS ===================
const categoriasHex = ["bancos", "supermercados", "escuelas", "hoteles"];

function getIconoCategoria(cat){
  switch(cat){
    case "Bancos": return '<i class="bi bi-bank"></i>';
    case "Supermercados": return '<i class="bi bi-basket3-fill"></i>';
    case "Escuelas": return '<i class="bi bi-mortarboard-fill"></i>';
    case "Hoteles": return '<i class="bi bi-building"></i>';
    default: return '<i class="bi bi-geo-alt-fill"></i>';
  }
}

async function buscarEnHexagono(bounds, categorias) {
  let resultados = [];
  const centro = bounds.getCenter();
  for (const cat of categorias) {
    const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${centro.lat},${centro.lng}/1000/${token}`;
    try {
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const data = await resp.json();

      // Filtrado b√°sico por bounding box del hex
      const dentro = data.filter(d => {
        const lat = parseFloat(d.Latitud), lon = parseFloat(d.Longitud);
        return !isNaN(lat) && !isNaN(lon) && bounds.contains([lat, lon]);
      });
      resultados.push(...dentro);
    } catch (err) {
      console.error("Error en consulta:", err);
    }
  }
  return resultados;
}

function onEachFeature(feature, layer) {
  layer.on("click", async () => {
    const props = feature.properties || {};

    // ----- Info fija (no se borra despu√©s) -----
    let htmlFija = `
      <div id="info-fija">
        <h2>${props.nomgeo || 'Zona'}</h2>
        	<b>Tipo:</b> ${props.TIPO || 'N/A'}<br>
            <p><b>Poblaci√≥n municipal total:</b> ${props.pobtot?.toLocaleString() || 0}</p>
            <p><b>Poblaci√≥n adulta municipal:</b> ${props.POBADUL?.toLocaleString() || 0}</p>
            <p><b>√çndice de Rezago:</b> ${props.REZAGO || 'N/A'}</p><hr>
			
            <p><b>Incidencia delicitiva municipal relacionada a extorsi√≥n:</b> ${props["extorsi√≥n"] || 0}</p>
            <p><b>Incidencia delicitiva municipal relacionada a narcomenudeo:</b> ${props.narcomenud || 0}</p>
            <p><b>Incidencia delicitiva municipal relacionada a robo a negocio:</b> ${props["robo a neg"] || 0}</p><hr>
            
            <p><b>Total de cr√©ditos personales a nivel municipal:</b> ${props.CRED_PERS?.toLocaleString() || 0}</p>
            <p><b>Total de cr√©ditos v√≠a n√≥mina a nivel municipal:</b> ${props.CRED_NOMI?.toLocaleString() || 0}</p>
            <p><b>Total de cr√©ditos hipotecarios a nivel municipal:</b> ${props.CRED_HIPOT?.toLocaleString() || 0}</p>
            <p><b>Total de cr√©ditos automotrices a nivel municipal:</b> ${props.CRED_AUTOM?.toLocaleString() || 0}</p>
			<p><b>Total cr√©ditos a nivel municipal:</b> ${props.TC?.toLocaleString() || 0}</p><hr>
   
            <p><b>Tasa de cr√©ditos hipotecarios por cada 10 mil adultos:</b> ${props.T_C_HIP || 0}</p>
            <p><b>Tasa de cr√©ditos automotrices por cada 10 mil adultos:</b> ${props.T_C_AUTO || 0}</p>
            <p><b>Tasa de tarjetas cr√©dito por cada 10 mil adultos:</b> ${props.T_TC || 0}</p><hr>
        <hr>
      </div>
      <div id="info-dinamica"></div>
    `;
    mostrarEnSidebar(htmlFija);

    const bounds = layer.getBounds();
    const resultados = await buscarEnHexagono(bounds, categoriasHex);

    // AGRUPAR resultados
    const resumen = { Bancos:0, Supermercados:0, Escuelas:0, Hoteles:0 };
    for (const item of resultados) {
      const c = (item.Clase_actividad || "").toLowerCase();
      if (c.includes("banco")) resumen.Bancos++;
      else if (c.includes("escuela") || c.includes("colegio") || c.includes("universidad")) resumen.Escuelas++;
      else if (c.includes("super") || c.includes("autoservicio") || c.includes("bodega") || c.includes("abarrotes")) resumen.Supermercados++;
      else if (c.includes("hotel") || c.includes("motel") || c.includes("hostal")) resumen.Hoteles++;
    }

    // Contenido din√°mico (s√≥lo cambia esta parte)
    let listado = "<h3>üè¨ Elementos urbanos dentro del √°rea:</h3><ul style='list-style:none;padding:0;'>";
    for (const [cat, num] of Object.entries(resumen)) {
      listado += `<li style="margin-bottom:6px; display:flex; align-items:center;">
                    <span style="margin-right:4px;">${getIconoCategoria(cat)}</span>
                    <h3>${cat}: </h3> <h3> ${num}</h3>
                   </li>`;
    }
    listado += "</ul>";

    // Reemplaza solo #info-dinamica
    document.getElementById("info-dinamica").innerHTML = listado;
  });
}

    // ================== HEX√ÅGONOS ===================

	function getColor(d) {
    return d > 1000000 ? '#d7191c' :
           d > 500000  ? '#fdae61' :
           d > 250000  ? '#ffffbf' :
           d > 100000  ? '#abdda4' :
                        '#2b83ba';
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties.POBADUL),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
    };
}
	  
	  var hiveLayer09 = L.geoJson(hive_cdmx, { 
    style: style, 
    onEachFeature: onEachFeature 
}).addTo(map);

var hiveLayer15 = L.geoJson(hive_edomex, { 
    style: style, 
    onEachFeature: onEachFeature 
}).addTo(map);
	
// Leyenda
var legend = L.control({position: 'bottomright'}); 
legend.onAdd = function (map) { 
    var div = L.DomUtil.create('div', 'info legend'), 
        grades = [0, 100000, 250000, 500000, 1000000]; 
    for (var i = 0; i < grades.length; i++) { 
        div.innerHTML += 
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' + 
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+'); 
    } 
    return div; 
}; 
legend.addTo(map); 

// ========================TITULO=========================
	var title = L.control();
	title.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'info');
		    div.innerHTML +=
		    '<h1>Estudio de mercado</h1><h2>An√°lisis de entornos</h2>';
		 return div;
	};
	title.addTo(map);	
	
	
// ===== LAYER CONTROL =====
var myMarker = L.marker([19.28581583157899, -99.40670897151347]) 
var myMarker1 = L.marker([19.38581583157899, -99.10670897151347]); 
map.addLayer(myMarker); 
map.addLayer(myMarker1); 
var baseLayers = { "Base": osm, "Ortoimagen": map }; 
var overlays = { "Casa": myMarker, "Otro": myMarker1, "Hive CDMX": hiveLayer09, "Hive EDOMEX": hiveLayer15 }; 
var control = new L.control.layers(baseLayers, overlays, {collapsed:true}); control.addTo(map);




  </script>
</body>
</html>



















