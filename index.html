<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estudio de mercado - Leaflet + DENUE</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
    }
    #sidebar {
        width: 350px;
        background: #f8f9fa;
        border-right: 1px solid #ccc;
        overflow-y: auto;
        padding: 10px;
    }
    #map {
        flex: 1;
    }
    .negocio-item {
        padding: 6px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
    }
    .negocio-item:hover {
        background: #e9ecef;
    }
</style>
</head>
<body>

<div id="sidebar">
    <h5>Estudio de mercado</h5>
    <div class="mb-2">
        <label>Tipo de negocio:</label>
        <select id="condi" class="form-select">
            <option value="restaurantes">Restaurantes</option>
            <option value="cafeter√≠as">Cafeter√≠as</option>
            <option value="hoteles">Hoteles</option>
        </select>
    </div>
    <div class="mb-2">
        <label>Radio (m):</label>
        <input type="number" id="mts" class="form-control" value="1000" min="100" max="5000" onchange="actualizarRadioDesdeInput()">
    </div>
    <div class="mb-2 d-grid gap-2">
        <button class="btn btn-primary" onclick="llamarApiDenueBus()">Buscar</button>
        <button class="btn btn-info" onclick="mostrarGraficos()">Ver gr√°ficos</button>
        <button class="btn btn-success" onclick="exportarExcel()">Exportar Excel</button>
        <button class="btn btn-danger" onclick="exportarPDF()">Exportar PDF</button>
    </div>
    <div id="stats" class="alert alert-info p-2">Esperando b√∫squeda...</div>
    <div id="listaNegocios"></div>
</div>

<div id="map"></div>

<!-- Modal para gr√°ficos -->
<div class="modal fade" id="graficosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">An√°lisis de resultados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="graficoMunicipios" height="120"></canvas>
        <hr>
        <canvas id="graficoColonias" height="120"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

<script>
    let map = L.map('map').setView([19.432608, -99.133209], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markersCluster = L.markerClusterGroup();
    map.addLayer(markersCluster);
    let radioInicial = 1000;
    let searchCircle, draggableCenter, draggableEdge;
    let datosActuales = [];

    function calcularPuntoEnBorde(center, radius) {
        let lat = center.lat;
        let lng = center.lng + (radius / 111320);
        return [lat, lng];
    }

    function actualizarRadioDesdeInput() {
        radioInicial = parseInt($('#mts').val());
        searchCircle.setRadius(radioInicial);
        draggableEdge.setLatLng(calcularPuntoEnBorde(draggableCenter.getLatLng(), radioInicial));
    }

    function setupMap(centerLatLng) {
        if (searchCircle) map.removeLayer(searchCircle);
        if (draggableCenter) map.removeLayer(draggableCenter);
        if (draggableEdge) map.removeLayer(draggableEdge);

        searchCircle = L.circle(centerLatLng, { radius: radioInicial, color: 'blue', fillOpacity: 0.2 }).addTo(map);
        draggableCenter = L.marker(centerLatLng, { draggable: true }).addTo(map);
        draggableEdge = L.marker(calcularPuntoEnBorde(centerLatLng, radioInicial), {
            draggable: true,
            icon: L.divIcon({ html: '<div style="width:12px;height:12px;background:red;border-radius:50%;"></div>', iconSize: [12, 12] })
        }).addTo(map);

        draggableCenter.on('drag', function(e) {
            let center = e.target.getLatLng();
            searchCircle.setLatLng(center);
            draggableEdge.setLatLng(calcularPuntoEnBorde(center, searchCircle.getRadius()));
        });

        draggableEdge.on('drag', function(e) {
            let center = draggableCenter.getLatLng();
            let newRadius = center.distanceTo(e.target.getLatLng());
            searchCircle.setRadius(newRadius);
            $('#mts').val(Math.round(newRadius));
        });
    }

    function llamarApiDenueBus() {
        const condi = $('#condi').val();
        const mts = parseInt($('#mts').val());
        const lat = draggableCenter.getLatLng().lat;
        const lon = draggableCenter.getLatLng().lng;
        const url = `/api/denue/${encodeURIComponent(condi)}/${lon},${lat}/${mts}`;

        $.getJSON(url, function(data) {
            markersCluster.clearLayers();
            datosActuales = [];
            $('#listaNegocios').empty();

            if (data && Array.isArray(data) && data.length > 0) {
                data.forEach((item, index) => {
                    const marker = L.marker([parseFloat(item.Latitud), parseFloat(item.Longitud)])
                        .bindPopup(`<b>${item.Nombre}</b><br>${item.Calle || ''} ${item.NumeroExterior || ''}<br>${item.Colonia || ''}, ${item.Municipio || ''}`);
                    markersCluster.addLayer(marker);
                    datosActuales.push(item);
                    $('#listaNegocios').append(`<div class="negocio-item" onclick="centrarNegocio(${index})"><b>${item.Nombre}</b><br><small>${item.Colonia || ''}, ${item.Municipio || ''}</small></div>`);
                });
                $('#stats').html(`üîç ${data.length} negocios encontrados`);
            } else {
                $('#stats').html(`‚ö†Ô∏è No se encontraron negocios`);
            }
        }).fail(function() {
            $('#stats').html(`‚ùå Error al obtener datos del servidor`);
        });
    }

    function centrarNegocio(index) {
        const n = datosActuales[index];
        map.setView([parseFloat(n.Latitud), parseFloat(n.Longitud)], 18);
    }

    function mostrarGraficos() {
        if (datosActuales.length === 0) {
            alert("No hay datos para mostrar.");
            return;
        }
        let municipios = {}, colonias = {};
        datosActuales.forEach(item => {
            municipios[item.Municipio] = (municipios[item.Municipio] || 0) + 1;
            colonias[item.Colonia] = (colonias[item.Colonia] || 0) + 1;
        });
        new Chart(document.getElementById('graficoMunicipios'), { type: 'bar', data: { labels: Object.keys(municipios), datasets: [{ label: 'Negocios por municipio', data: Object.values(municipios), backgroundColor: 'rgba(54, 162, 235, 0.7)' }] } });
        new Chart(document.getElementById('graficoColonias'), { type: 'pie', data: { labels: Object.keys(colonias), datasets: [{ label: 'Negocios por colonia', data: Object.values(colonias), backgroundColor: ['rgba(255, 99, 132, 0.7)','rgba(54, 162, 235, 0.7)','rgba(255, 206, 86, 0.7)','rgba(75, 192, 192, 0.7)','rgba(153, 102, 255, 0.7)'] }] } });
        new bootstrap.Modal(document.getElementById('graficosModal')).show();
    }

    function exportarExcel() {
        if (datosActuales.length === 0) {
            alert("No hay datos para exportar.");
            return;
        }
        const hoja1 = XLSX.utils.json_to_sheet(datosActuales);
        let municipios = {}, colonias = {};
        datosActuales.forEach(item => {
            municipios[item.Municipio] = (municipios[item.Municipio] || 0) + 1;
            colonias[item.Colonia] = (colonias[item.Colonia] || 0) + 1;
        });
        let resumenMunicipios = [["Municipio", "Cantidad"]];
        Object.entries(municipios).forEach(([mun, count]) => resumenMunicipios.push([mun, count]));
        let resumenColonias = [["Colonia", "Cantidad"]];
        Object.entries(colonias).forEach(([col, count]) => resumenColonias.push([col, count]));
        let hoja2Data = [["Resumen por municipio"], ...resumenMunicipios, [], ["Resumen por colonia"], ...resumenColonias];
        const hoja2 = XLSX.utils.aoa_to_sheet(hoja2Data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, hoja1, "Negocios");
        XLSX.utils.book_append_sheet(wb, hoja2, "Resumen");
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
    }

    function exportarPDF() {
        if (datosActuales.length === 0) {
            alert("No hay datos para exportar.");
            return;
        }
        leafletImage(map, function(err, canvas) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text("Estudio de mercado", 10, 10);
            doc.setFontSize(10);
            doc.text(`Fecha: ${new Date().toLocaleString()}`, 10, 16);
            const imgData = canvas.toDataURL("image/png");
            doc.addImage(imgData, "PNG", 10, 20, 190, 100);
            let y = 130;
            doc.setFontSize(12);
            doc.text("Listado de negocios:", 10, y);
            y += 6;
            datosActuales.forEach((item, i) => {
                doc.text(`${i + 1}. ${item.Nombre} - ${item.Colonia || ''}, ${item.Municipio || ''}`, 10, y);
                y += 6;
                if (y > 270) { doc.addPage(); y = 20; }
            });
            const blob = doc.output("blob");
            const url = URL.createObjectURL(blob);
            window.open(url, "_blank");
        });
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            let latlng = [pos.coords.latitude, pos.coords.longitude];
            map.setView(latlng, 14);
            setupMap(latlng);
        }, function() { setupMap([19.432608, -99.133209]); });
    } else {
        setupMap([19.432608, -99.133209]);
    }
</script>
</body>
</html>
