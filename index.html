<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estudio de mercado a un clic</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS y JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- Geocode -->
<script src="js/Control.OSMGeocoder.js"></script>
<link rel="stylesheet" href="css/Control.OSMGeocoder.css" />

<style>
body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #121212; color: #e0e0e0; }
#controls { padding: 10px; background: #1e1e1e; border-bottom: 1px solid #333; }
label { margin-right: 5px; }
input, button { margin: 3px; padding: 5px; background: #2a2a2a; border: 1px solid #444; color: #e0e0e0; }
button { cursor: pointer; }
button:hover { background: #444; }
#map { width: 100%; height: calc(100vh - 60px); transition: width 0.3s; float: left; }
#sidebar { width: 25%; height: calc(100vh - 60px); float: right; padding: 10px; border-left: 2px solid #333; background: #181818; overflow-y: auto; transition: width 0.3s, padding 0.3s; position: relative; }
#sidebar.collapsed { width: 0; padding: 0; border-left: none; overflow: hidden; }
#map.expanded { width: 100%; }
#sidebar h2 { margin-top: 0; color: #f0f0f0; }
#toggleSidebar { position: absolute; top: 10px; left: -35px; background: #333; border: none; color: #fff; padding: 6px 8px; cursor: pointer; border-radius: 4px 0 0 4px; font-size: 14px; transition: left 0.3s; }
#toggleSidebar:hover { background: #444; }
#listado { max-height: 40vh; overflow-y: auto; background: #181818; border-top: 1px solid #333; }
table { width: 100%; border-collapse: collapse; color: #e0e0e0; }
th, td { padding: 8px; border-bottom: 1px solid #333; }
tr:hover { background: #333; cursor: pointer; }
th { background: #222; position: sticky; top: 0; }
#tabs { display: flex; margin-bottom: 10px; } .tab-btn {flex: 1;background: #222;border: 1px solid #333;color: #eee;padding: 6px;cursor: pointer;text-align: center;}
.tab-btn.active { background: #444; font-weight: bold; }
.tab-pane { display: none; }
.tab-pane.active { display: block; }
</style>
</head>
<body>

<div id="controls">
    <label>Establecimiento:</label>
    <input type="text" id="condi" value="restaurantes" />
    <label>Latitud:</label>
    <input type="text" id="lat" value="19.432650801677962" />
    <label>Longitud:</label>
    <input type="text" id="lon" value="-99.13316794583835" />
    <label>Metros:</label>
    <input type="number" id="mts" value="500" />
    <button id="btnBuscar">Buscar</button>
</div>

<div id="map"></div>

<div id="sidebar" class="collapsed">
    <button id="toggleSidebar">➡</button>
    <h2>Detalles</h2>
    
    <!-- Tabs -->
    <div id="tabs">
        <button class="tab-btn active" data-tab="hexagono">Hexágono</button>
        <button class="tab-btn" data-tab="denue">DENUE</button>
    </div>

    <!-- Contenedor de pestañas -->
    <div id="tab-content">
        <!-- Pestaña Hexágonos -->
        <div id="hexagono" class="tab-pane active">
            <div id="info">Haz clic en un hexágono</div>
        </div>

        <!-- Pestaña DENUE -->
        <div id="denue" class="tab-pane">
            <h3>Resultados DENUE</h3>
            <div id="listado">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Dirección</th>
                            <th>Teléfono</th>
                            <th>Personal ocupado</th>
                            <th>Clase</th>
                        </tr>
                    </thead>
                    <tbody id="tablaResultados"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" src="js/hive_cdmx.js"></script>
<script type="text/javascript" src="js/hive_edomex.js"></script>

<script>
const token = "33602899-98fd-4db7-8ce9-41c0330f1d7e";

// Inicializar mapa
const map = L.map('map').setView([19.4326, -99.1332], 12);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; OpenStreetMap contributors'
}).addTo(map);

// Hive CDMX y EDOMEX
function getColor(d) {
    return d > 1000000 ? '#d7191c' :
           d > 500000  ? '#fdae61' :
           d > 250000  ? '#ffffbf' :
           d > 100000  ? '#abdda4' :
                        '#2b83ba';
}
function style(feature) {
    return { fillColor: getColor(feature.properties.POBADUL), weight: 2, color: 'white', dashArray: '3', fillOpacity: 0.7 };
}
function mostrarInfoHexagono(feature) {
    document.getElementById("info").innerHTML = `
        <h3>Hexágono</h3>
        <p><b>ID:</b> ${feature.properties.id}</p>
        <p><b>Nombre:</b> ${feature.properties.nombre}</p>
        <p><b>Valor:</b> ${feature.properties.valor}</p>
    `;

    // Abrir sidebar y activar pestaña hexágono
    document.getElementById("sidebar").classList.remove("collapsed");
    document.getElementById("map").classList.remove("expanded");
    document.getElementById("toggleSidebar").innerHTML = "⬅";
    document.querySelectorAll(".tab-btn, .tab-pane").forEach(el=>el.classList.remove("active"));
    document.querySelector('.tab-btn[data-tab="hexagono"]').classList.add("active");
    document.getElementById("hexagono").classList.add("active");

    // Centrar mapa
    if(feature.geometry && feature.geometry.coordinates){
        const coords = feature.geometry.coordinates[0][0];
        map.flyTo([coords[1], coords[0]], 15, {duration: 1.0});
    }
}

const hiveLayer09 = L.geoJson(hive_cdmx, { style: style, onEachFeature: (f,l) => l.on("click",()=>mostrarInfoHexagono(f)) });
const hiveLayer15 = L.geoJson(hive_edomex, { style: style, onEachFeature: (f,l) => l.on("click",()=>mostrarInfoHexagono(f)) });

// Sidebar toggle
const sidebar = document.getElementById("sidebar");
const mapDiv = document.getElementById("map");
const toggleBtn = document.getElementById("toggleSidebar");
toggleBtn.addEventListener("click", ()=>{
    sidebar.classList.toggle("collapsed");
    mapDiv.classList.toggle("expanded");
    toggleBtn.innerHTML = sidebar.classList.contains("collapsed") ? "➡":"⬅";
    setTimeout(()=>map.invalidateSize(),310);
});

// FeatureGroup para marcadores DENUE
let markersLayer = L.featureGroup().addTo(map);
function getBootstrapIconFromActividad(clase){
    clase = (clase||"").toLowerCase();
    let iconHTML;
    if(clase.includes("restaurante")||clase.includes("cafetería")||clase.includes("taquería")) iconHTML='<i class="bi bi-shop" style="font-size:26px;color:orange;"></i>';
    else if(clase.includes("hotel")||clase.includes("motel")||clase.includes("alojamiento")) iconHTML='<i class="bi bi-building" style="font-size:26px;color:blue;"></i>';
    else if(clase.includes("escuela")||clase.includes("colegio")||clase.includes("universidad")||clase.includes("capacitación")) iconHTML='<i class="bi bi-mortarboard-fill" style="font-size:26px;color:yellow;"></i>';
    else if(clase.includes("farmacia")||clase.includes("medicinas")||clase.includes("botica")) iconHTML='<i class="bi bi-capsule-pill" style="font-size:26px;color:green;"></i>';
    else if(clase.includes("abarrotes")||clase.includes("supermercado")||clase.includes("tienda de autoservicio")) iconHTML='<i class="bi bi-basket3-fill" style="font-size:26px;color:violet;"></i>';
    else if(clase.includes("hospital")||clase.includes("clínica")||clase.includes("consultorio")) iconHTML='<i class="bi bi-hospital" style="font-size:26px;color:pink;"></i>';
    else iconHTML='<i class="bi bi-geo-alt-fill" style="font-size:26px;color:red;"></i>';
    return L.divIcon({html:iconHTML,className:'custom-div-icon',iconSize:[26,26],iconAnchor:[13,26],popupAnchor:[0,-26]});
}

// Función para buscar DENUE
async function buscarDENUE(){
    markersLayer.clearLayers();
    document.getElementById("tablaResultados").innerHTML="";
    let condi=document.getElementById('condi').value.trim();
    const lat=parseFloat(document.getElementById('lat').value.trim());
    const lon=parseFloat(document.getElementById('lon').value.trim());
    const mts=parseInt(document.getElementById('mts').value.trim());
    if(!condi||isNaN(lat)||isNaN(lon)||isNaN(mts)){ alert("Datos inválidos."); return; }
    const url=`https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(condi)}/${lat},${lon}/${mts}/${token}`;
    try{
        const resp=await fetch(url);
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data=await resp.json();
        if(!Array.isArray(data)||data.length===0){ alert("No se encontraron resultados."); return; }
        data.forEach(item=>{
            const latNum=parseFloat(item.Latitud), lonNum=parseFloat(item.Longitud);
            if(isNaN(latNum)||isNaN(lonNum)) return;
            const icono=getBootstrapIconFromActividad(item.Clase_actividad);
            const marker=L.marker([latNum,lonNum],{icon:icono}).bindPopup(`<b>${item.Nombre||''}</b><br><small>${item.Clase_actividad||''}</small><br>${item.Calle||''} ${item.Num_Exterior||''}<br>${item.Colonia||''}, ${item.CP||''}<br>${item.Telefono||''}`);
            markersLayer.addLayer(marker);
            const row=document.createElement("tr");
            row.innerHTML=`<td>${item.Nombre||''}</td><td>${(item.Calle||'')+' '+(item.Num_Exterior||'')+', '+(item.Colonia||'')}</td><td>${item.Telefono||''}</td><td>${item.Estrato||''}</td><td>${item.Clase_actividad||''}</td>`;
            row.addEventListener("click",()=>{ map.flyTo([latNum,lonNum],18,{duration:1}); marker.openPopup(); });
            document.getElementById("tablaResultados").appendChild(row);
        });
        const bounds=markersLayer.getBounds();
        if(bounds.isValid()) map.fitBounds(bounds.pad(0.1));
    } catch(e){ console.error("Error DENUE:",e); alert("Error al consultar la API."); }
}
document.getElementById('btnBuscar').addEventListener('click',buscarDENUE);

// Control de capas
const baseLayers = { "OSM": osm, "Base": map };
const overlays = { "Hive CDMX": hiveLayer09, "Hive EDOMEX": hiveLayer15, "Resultados DENUE": markersLayer };
L.control.layers(baseLayers, overlays, {collapsed:true}).addTo(map);

// Geocoder
var osmGeocoder = new L.Control.OSMGeocoder({placeholder: 'Escribir dirección...'});
map.addControl(osmGeocoder);

// Agregar capas por defecto
hiveLayer09.addTo(map);
hiveLayer15.addTo(map);

// ⬇⬇⬇ AQUÍ AGREGAS EL MANEJO DE LAS PESTAÑAS
document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        // Quitar activos
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".tab-pane").forEach(p=>p.classList.remove("active"));

        // Activar el clicado
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
    });
});
    
</script>
</body>
</html>


