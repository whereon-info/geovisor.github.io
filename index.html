<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estudio de mercado a un clic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Sidebar -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.css">
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.js"></script>

  <style>
    #map { width: 100%; height: 100vh; }
    .sidebar-content { padding: 15px; font-family: Arial, sans-serif; }
    .sidebar-content h2 { margin-top: 0; }
    .bloque { margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Sidebar -->
  <div id="sidebar" class="leaflet-sidebar collapsed">
    <div class="leaflet-sidebar-tabs">
      <ul role="tablist">
        <li><a href="#info" role="tab"><i class="fa fa-info"></i></a></li>
      </ul>
    </div>
    <div class="leaflet-sidebar-content">
      <div class="leaflet-sidebar-pane" id="info">
        <h2 class="sidebar-header">📊 Información del hexágono</h2>
        <div id="info-dinamica" class="sidebar-content"></div>
      </div>
    </div>
  </div>

  <!-- Input de búsqueda DENUE -->
  <div style="position:absolute; top:10px; left:10px; z-index:9999; background:#fff; padding:8px; border-radius:5px;">
    <label><b>Búsqueda DENUE:</b></label><br>
    <input type="text" id="denue-input" placeholder="Ej: farmacia, banco, hotel" style="width:180px;">
  </div>

  <script>
    // === MAPA BASE ===
    const map = L.map('map').setView([21.12, -101.68], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Sidebar
    const sidebar = L.control.sidebar('sidebar').addTo(map);

    // === FUNCIÓN MOSTRAR INFO HEXÁGONO ===
    function mostrarInfoHexagono(feature) {
      let poblacion = feature.properties.poblacion || "N/D";
      let delitos = feature.properties.delitos || "N/D";

      let html = `
        <div class="bloque">
          <h3>👥 Población</h3>
          <p>${poblacion}</p>
        </div>
        <div class="bloque">
          <h3>⚖️ Delitos</h3>
          <p>${delitos}</p>
        </div>
        <div class="bloque">
          <h3>🏦 Bancos</h3>
          <p>${feature.properties.bancos || 0}</p>
        </div>
        <div class="bloque">
          <h3>🛒 Supermercados</h3>
          <p>${feature.properties.supermercados || 0}</p>
        </div>
        <div class="bloque">
          <h3>🏫 Escuelas</h3>
          <p>${feature.properties.escuelas || 0}</p>
        </div>
        <div class="bloque">
          <h3>🏨 Hoteles</h3>
          <p>${feature.properties.hoteles || 0}</p>
        </div>
      `;

      document.getElementById("info-dinamica").innerHTML = html;
      sidebar.open("info");
    }

    // === FUNCIÓN DE BÚSQUEDA DENUE POR HEXÁGONO ===
    function buscarDENUE(query, hexCentro) {
      if (!query || !hexCentro) return;

      let lat = hexCentro.lat;
      let lng = hexCentro.lng;

      const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/Buscar/${query}/${lat},${lng}/1000/0/100?token=TU_TOKEN_AQUI`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          let total = (data && data.length) ? data.length : 0;

          // Ícono dinámico
          let icono = "📍"; 
          if (query.toLowerCase().includes("farmacia")) icono = "💊";
          if (query.toLowerCase().includes("escuela")) icono = "🏫";
          if (query.toLowerCase().includes("hotel")) icono = "🏨";
          if (query.toLowerCase().includes("banco")) icono = "🏦";
          if (query.toLowerCase().includes("super")) icono = "🛒";

          let htmlDENUE = `
            <div id="denue-resultados" class="bloque">
              <h3>${icono} "${query}"</h3>
              <p><b>Total en el hexágono:</b> ${total}</p>
            </div>`;

          // Eliminar bloque previo si existe
          let bloquePrevio = document.getElementById("denue-resultados");
          if (bloquePrevio) bloquePrevio.remove();

          // Insertar al final
          document.getElementById("info-dinamica").innerHTML += htmlDENUE;
        })
        .catch(err => console.error("Error en consulta DENUE:", err));
    }

    // === CAPA DE HEXÁGONOS (EJEMPLO GEOJSON) ===
    const hexagonos = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": {
            "poblacion": 1200,
            "delitos": 15,
            "bancos": 2,
            "supermercados": 1,
            "escuelas": 3,
            "hoteles": 0
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [-101.70, 21.12],
              [-101.69, 21.13],
              [-101.68, 21.13],
              [-101.67, 21.12],
              [-101.68, 21.11],
              [-101.69, 21.11],
              [-101.70, 21.12]
            ]]
          }
        }
      ]
    };

    function onEachHexagon(feature, layer) {
      layer.on("click", function() {
        let centro = layer.getBounds().getCenter();

        // 1) Info del hexágono
        mostrarInfoHexagono(feature);

        // 2) Búsqueda DENUE según input
        let giro = document.getElementById("denue-input").value.trim();
        if (giro) {
          buscarDENUE(giro, centro);
        }
      });
    }

    L.geoJSON(hexagonos, {
      style: { color: "blue", weight: 1, fillOpacity: 0.2 },
      onEachFeature: onEachHexagon
    }).addTo(map);
  </script>
</body>
</html>
