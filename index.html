<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa DENUE + Hex치gonos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#111; color:#eee;}
        #map { width:100%; height:60vh; }
        #sidebar {
            width: 100%; height: 40vh; overflow-y: auto;
            background: #181818; border-top: 1px solid #333; padding: 10px;
        }
        #listado {
            display:none;
            height: 40vh; overflow-y: auto;
            background: #222; border-top: 1px solid #444; padding: 10px;
        }
        table { width:100%; border-collapse: collapse; margin-top: 5px;}
        th, td { border:1px solid #555; padding:4px; font-size:12px; color:#eee;}
    </style>
</head>
<body>

<div id="map"></div>
<div id="sidebar">Haz clic en un hex치gono para ver informaci칩n.</div>
<div id="listado">
    <h4>Resultados DENUE (b칰squeda manual)</h4>
    <table id="resultsTable">
        <thead><tr><th>Nombre</th><th>Clase</th><th>Direcci칩n</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
// TOKEN DENUE (sustituir por el tuyo)
const token = "TU_TOKEN_INEGI";

// Inicializar mapa
const map = L.map("map").setView([19.4, -99.1], 10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let markersLayer = L.layerGroup().addTo(map);

// Categor칤as clave
const categoriasHex = {
    "bancos": {icon:"<i class='bi bi-bank2'></i>", count:0},
    "escuela": {icon:"<i class='bi bi-mortarboard'></i>", count:0},
    "supermercado": {icon:"<i class='bi bi-cart4'></i>", count:0},
    "hotel": {icon:"<i class='bi bi-building'></i>", count:0}
};

// Auxiliar: consulta DENUE por categor칤a
async function buscarEnHexagono(bounds, categorias) {
    let conteo = {};
    for (let c in categorias) conteo[c] = 0;

    const centro = bounds.getCenter();

    for (let cat in categorias) {
        const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(cat)}/${centro.lat},${centro.lng}/1000/${token}`;
        try {
            const resp = await fetch(url);
            if (!resp.ok) continue;
            const data = await resp.json();
            conteo[cat] += data.length;
        } catch (err) {
            console.error("Error en consulta hex치gono:", err);
        }
    }
    return conteo;
}

// Mostrar en sidebar
function mostrarEnSidebar(html) {
    document.getElementById("sidebar").innerHTML = html;
}

// onEachFeature para hex치gonos
function onEachFeature(feature, layer) {
    layer.on("click", async () => {
        const props = feature.properties || {};
        let html = `
            <h4>${props.nomgeo || 'Zona'}</h4>
            <b>Tipo:</b> ${props.TIPO || 'N/A'}<br>
            <p><b>Poblaci칩n:</b> ${props.pobtot?.toLocaleString() || 0}</p>
            <p><b>Poblaci칩n adulta:</b> ${props.POBADUL?.toLocaleString() || 0}</p>
            <hr>
            <h5>游댍 Buscando servicios dentro...</h5>
        `;
        mostrarEnSidebar(html);

        const bounds = layer.getBounds();
        const conteo = await buscarEnHexagono(bounds, categoriasHex);

        let listado = "<h5>游낇 Servicios dentro del 치rea:</h5><ul style='list-style:none;padding:0;'>";
        for (let cat in categoriasHex) {
            listado += `
                <li style="margin-bottom:6px; display:flex; align-items:center;">
                    <span style="margin-right:6px;">${categoriasHex[cat].icon}</span>
                    <b>${cat.charAt(0).toUpperCase() + cat.slice(1)}:</b> ${conteo[cat]}
                </li>
            `;
        }
        listado += "</ul>";
        mostrarEnSidebar(html + listado);
    });
}

// Ejemplo de capa GeoJSON (simulaci칩n de hex치gonos)
const ejemploHex = {
    "type":"FeatureCollection",
    "features":[
        {
            "type":"Feature",
            "properties":{"nomgeo":"Hex 1","TIPO":"Urbano","pobtot":5000,"POBADUL":3500},
            "geometry":{"type":"Polygon","coordinates":[[[-99.2,19.3],[-99.1,19.3],[-99.1,19.4],[-99.2,19.4],[-99.2,19.3]]]}
        }
    ]
};

L.geoJSON(ejemploHex, {onEachFeature}).addTo(map);

// --- B칰squeda manual DENUE ---
async function buscarDENUE(query, lat, lng, radio=1000) {
    const url = `https://www.inegi.org.mx/app/api/denue/v1/consulta/buscar/${encodeURIComponent(query)}/${lat},${lng}/${radio}/${token}`;
    try {
        const resp = await fetch(url);
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) {
            alert("No se encontraron resultados.");
            return;
        }

        markersLayer.clearLayers();
        const tbody = document.querySelector("#resultsTable tbody");
        tbody.innerHTML = "";

        data.forEach(item => {
            const marker = L.marker([item.Latitud, item.Longitud]).addTo(markersLayer);
            marker.bindPopup(`<b>${item.Nombre}</b><br>${item.Clase_actividad}`);
            tbody.innerHTML += `<tr>
                <td>${item.Nombre}</td>
                <td>${item.Clase_actividad}</td>
                <td>${item.Calle} ${item.Num_Exterior||''}, ${item.Colonia||''}</td>
            </tr>`;
        });

        const bounds = markersLayer.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));

        // Mostrar tabla de resultados
        document.getElementById("listado").style.display = "block";
    } catch (err) {
        console.error("Error en b칰squeda manual:", err);
    }
}

</script>
</body>
</html>
